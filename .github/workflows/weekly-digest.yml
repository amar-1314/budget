name: Weekly Digest Push

on:
  schedule:
    # Every Monday 13:05 UTC (~8:05am ET standard; ~9:05am ET daylight)
    - cron: '5 13 * * 1'
  workflow_dispatch:
    inputs:
      force:
        type: boolean
        required: false
        default: false

jobs:
  send-digest:
    runs-on: ubuntu-latest
    steps:
      - name: Call push-weekly-digest
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          CRON_SECRET: ${{ secrets.BUDGET_CRON_SECRET }}
        run: |
          set -euo pipefail
          BODY='{}'
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.force }}" = "true" ]; then
            BODY='{"force":true}'
          fi
          CODE=$(curl -sS -o response.json -w "%{http_code}" "$SUPABASE_URL/functions/v1/push-weekly-digest" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "x-cron-secret: $CRON_SECRET" \
            -d "$BODY")
          cat response.json
          echo ""
          echo "HTTP $CODE"
          test "$CODE" -ge 200 -a "$CODE" -lt 300
