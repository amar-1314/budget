<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="mobile-web-app-capable" content="yes">
      <title>Family Budget Tracker Pro</title>
      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
      <script src="https://cdn.tailwindcss.com"></script>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
      <style>
         @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
         * { font-family: 'Inter', sans-serif; }
         .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
         .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; }
         .card:hover { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); transform: translateY(-2px); }
         .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; padding: 24px; position: relative; overflow: hidden; }
         .stat-card::before { content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: pulse 4s ease-in-out infinite; }
         @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }
         .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
         .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); }
         .btn-secondary { background: white; color: #667eea; padding: 12px 24px; border-radius: 8px; border: 2px solid #667eea; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
         .btn-secondary:hover { background: #667eea; color: white; }
         .input-field { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; }
         .input-field:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
         .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; }
         .modal.active { display: flex; }
         .modal-content { background: white; border-radius: 16px; padding: 32px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
         @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
         .expense-row { display: grid; grid-template-columns: 1fr; gap: 8px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
         .expense-row:hover { background: #f9fafb; }
         .expense-header { display: none; }
         .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
         .expense-label { font-size: 12px; color: #6b7280; font-weight: 600; }
         @media (min-width: 768px) {
            .expense-row { grid-template-columns: 1.5fr 1.2fr 0.7fr 0.8fr 1fr 1fr 1fr 0.7fr 80px; gap: 12px; padding: 16px; border: none; border-bottom: 1px solid #f3f4f6; border-radius: 0; margin-bottom: 0; box-shadow: none; }
            .expense-header { display: grid; font-weight: 700; color: #374151; background: #f9fafb; border-radius: 8px; }
            .expense-item { display: block; padding: 0; }
            .expense-label { display: none; }
         }
         .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
         .badge-llc { background: #dcfce7; color: #166534; }
         .badge-personal { background: #fef3c7; color: #92400e; }
         .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f4f6; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
         @keyframes spin { to { transform: rotate(360deg); } }
         .chart-container { position: relative; height: 300px; margin-top: 20px; }
         .progress-bar { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-top: 8px; }
         .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s ease; }
         .tab-button { padding: 12px 24px; border: none; background: transparent; color: #6b7280; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
         .tab-button.active { color: #667eea; border-bottom-color: #667eea; }
         .notification { position: fixed; top: 20px; right: 20px; left: 20px; background: white; padding: 16px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); z-index: 2000; display: none; animation: slideIn 0.3s ease; font-size: 14px; }
         @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
         .notification.success { border-left: 4px solid #10b981; }
         .notification.error { border-left: 4px solid #ef4444; }
         .fab { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; font-size: 24px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); cursor: pointer; z-index: 100; display: flex; align-items: center; justify-content: center; }
         .fab:active { transform: scale(0.95); }
         .mobile-only { display: block; }
         .desktop-only { display: none; }
         @media (min-width: 768px) {
            .notification { right: 20px; left: auto; }
            .fab { display: none; }
            .mobile-only { display: none; }
            .desktop-only { display: block; }
            .modal-content { padding: 32px; }
            .chart-container { height: 300px; }
            .stat-card { padding: 24px; }
            .tab-button { padding: 12px 24px; font-size: 14px; }
         }
         @media (max-width: 767px) {
            .modal-content { padding: 20px; }
            .chart-container { height: 250px; }
            .stat-card { padding: 16px; }
            .tab-button { padding: 10px 12px; font-size: 13px; }
            .input-field { font-size: 16px; }
            body { padding-bottom: 80px; }
         }
      </style>
   </head>
   <body class="bg-gray-50">
      <div id="notification" class="notification">
         <div class="flex items-center gap-3"><i class="fas fa-check-circle text-green-500"></i><span id="notificationText"></span></div>
      </div>
      <div class="gradient-bg text-white py-4 md:py-8 px-4 md:px-6 shadow-lg">
         <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center">
               <div>
                  <h1 class="text-2xl md:text-4xl font-bold mb-1 md:mb-2"><i class="fas fa-chart-line mr-2 md:mr-3"></i>Budget Tracker</h1>
                  <p class="text-purple-100 text-xs md:text-base">Amar & Priya</p>
               </div>
               <button onclick="openAddExpenseModal()" class="desktop-only btn-secondary bg-white/20 border-white/40 text-white hover:bg-white hover:text-purple-700"><i class="fas fa-plus mr-2"></i>Add Expense</button>
            </div>
         </div>
      </div>
      <button onclick="openAddExpenseModal()" class="fab mobile-only">
         <i class="fas fa-plus"></i>
      </button>
      <div class="max-w-7xl mx-auto px-3 md:px-6 py-4 md:py-8">
         <div class="mb-4 md:mb-6 flex items-center gap-2 md:gap-4 flex-wrap">
            <label class="font-semibold text-gray-700 text-sm md:text-base">Filter:</label>
            <select id="yearSelector" onchange="filterByPeriod()" class="input-field flex-1 min-w-[100px] md:w-40">
               <option value="all">All Years</option>
            </select>
            <select id="monthSelector" onchange="filterByPeriod()" class="input-field flex-1 min-w-[120px] md:w-48">
               <option value="all">All Months</option>
            </select>
            <button onclick="loadData()" class="btn-secondary text-sm md:text-base"><i class="fas fa-sync-alt mr-1 md:mr-2"></i><span class="hidden md:inline">Refresh</span><i class="fas fa-sync-alt md:hidden"></i></button>
         </div>
         <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-6 md:mb-8">
            <div class="stat-card">
               <div class="relative z-10">
                  <div class="text-purple-100 text-xs md:text-sm font-semibold mb-1">BUDGET</div>
                  <div class="text-xl md:text-3xl font-bold" id="totalBudget">$0</div>
               </div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
               <div class="relative z-10">
                  <div class="text-pink-100 text-xs md:text-sm font-semibold mb-1">SPENT</div>
                  <div class="text-xl md:text-3xl font-bold" id="totalActual">$0</div>
               </div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
               <div class="relative z-10">
                  <div class="text-blue-100 text-xs md:text-sm font-semibold mb-1">LLC</div>
                  <div class="text-xl md:text-3xl font-bold" id="llcTotal">$0</div>
               </div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
               <div class="relative z-10">
                  <div class="text-green-100 text-xs md:text-sm font-semibold mb-1">LEFT</div>
                  <div class="text-xl md:text-3xl font-bold" id="remaining">$0</div>
               </div>
            </div>
         </div>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="card p-6">
               <div class="flex items-center justify-between mb-4">
                  <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-user-circle text-blue-500 mr-2"></i>Amar's Share</h3>
                  <span class="text-2xl font-bold text-blue-600" id="amarShare">$0</span>
               </div>
               <div class="progress-bar">
                  <div class="progress-fill" id="amarProgress" style="width: 0%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);"></div>
               </div>
               <p class="text-sm text-gray-500 mt-2">50% of total expenses</p>
            </div>
            <div class="card p-6">
               <div class="flex items-center justify-between mb-4">
                  <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-user-circle text-pink-500 mr-2"></i>Priya's Share</h3>
                  <span class="text-2xl font-bold text-pink-600" id="priyaShare">$0</span>
               </div>
               <div class="progress-bar">
                  <div class="progress-fill" id="priyaProgress" style="width: 0%; background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);"></div>
               </div>
               <p class="text-sm text-gray-500 mt-2">50% of total expenses</p>
            </div>
         </div>
         <div class="card mb-8">
            <div class="border-b border-gray-200 px-3 md:px-6 overflow-x-auto">
               <div class="flex gap-2 min-w-max"><button class="tab-button active" onclick="switchTab('expenses')"><i class="fas fa-list mr-1 md:mr-2"></i><span class="hidden md:inline">Expenses</span><span class="md:hidden">List</span></button><button class="tab-button" onclick="switchTab('category')"><i class="fas fa-filter mr-1 md:mr-2"></i><span class="hidden md:inline">Category</span><span class="md:hidden">Cat</span></button><button class="tab-button" onclick="switchTab('analytics')"><i class="fas fa-chart-pie mr-1 md:mr-2"></i><span class="hidden md:inline">Analytics</span><span class="md:hidden">Charts</span></button><button class="tab-button" onclick="switchTab('trends')"><i class="fas fa-chart-line mr-1 md:mr-2"></i>Trends</button><button class="tab-button" onclick="switchTab('insights')"><i class="fas fa-lightbulb mr-1 md:mr-2"></i>Insights</button></div>
            </div>
            <div id="expensesTab" class="p-3 md:p-6">
               <div class="expense-row expense-header">
                  <div>Item</div>
                  <div>Category</div>
                  <div>Year</div>
                  <div>Month</div>
                  <div>Budget</div>
                  <div>Actual</div>
                  <div>Variance</div>
                  <div>LLC</div>
                  <div>Actions</div>
               </div>
               <div id="expensesList">
                  <div class="text-center py-12 text-gray-400">
                     <div class="loading mx-auto mb-4"></div>
                     <p>Loading expenses...</p>
                  </div>
               </div>
            </div>
            <div id="categoryTab" class="p-6" style="display: none;">
               <div class="mb-6">
                  <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-filter mr-2 text-purple-500"></i>Select Category to Analyze</h3>
                  <select id="categorySelector" onchange="updateCategoryAnalysis()" class="input-field w-full max-w-md">
                     <option value="">Choose an expense category...</option>
                  </select>
               </div>
               <div id="categoryStats" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6" style="display: none;">
                  <div class="card p-6 text-center">
                     <div class="text-gray-500 text-sm mb-2">Total Spent</div>
                     <div class="text-3xl font-bold text-purple-600" id="categoryTotal">$0</div>
                  </div>
                  <div class="card p-6 text-center">
                     <div class="text-gray-500 text-sm mb-2">Monthly Average</div>
                     <div class="text-3xl font-bold text-blue-600" id="categoryAvg">$0</div>
                  </div>
                  <div class="card p-6 text-center">
                     <div class="text-gray-500 text-sm mb-2">Number of Entries</div>
                     <div class="text-3xl font-bold text-green-600" id="categoryCount">0</div>
                  </div>
               </div>
               <div id="categoryChartContainer" style="display: none;">
                  <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-chart-line mr-2 text-green-500"></i>Monthly Trend for Selected Category</h3>
                  <div class="chart-container" style="height: 400px;">
                     <canvas id="categoryTrendChart"></canvas>
                  </div>
                  <div class="mt-6">
                     <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-table mr-2 text-blue-500"></i>Detailed Breakdown</h3>
                     <div id="categoryDetails"></div>
                  </div>
               </div>
            </div>
            <div id="analyticsTab" class="p-6" style="display: none;">
               <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                  <div>
                     <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-chart-pie mr-2 text-purple-500"></i>Expense Distribution</h3>
                     <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                     </div>
                  </div>
                  <div>
                     <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-balance-scale mr-2 text-blue-500"></i>LLC vs Personal</h3>
                     <div class="chart-container">
                        <canvas id="llcChart"></canvas>
                     </div>
                  </div>
               </div>
               <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div>
                     <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-chart-bar mr-2 text-green-500"></i>Budget vs Actual by Category</h3>
                     <div class="chart-container">
                        <canvas id="budgetActualChart"></canvas>
                     </div>
                  </div>
                  <div>
                     <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-percentage mr-2 text-orange-500"></i>Budget Utilization</h3>
                     <div class="chart-container">
                        <canvas id="utilizationChart"></canvas>
                     </div>
                  </div>
               </div>
            </div>
            <div id="trendsTab" class="p-6" style="display: none;">
               <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-chart-line mr-2 text-green-500"></i>Monthly Spending Trends</h3>
               <div class="chart-container" style="height: 400px;">
                  <canvas id="lineChart"></canvas>
               </div>
               <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-8">
                  <div class="card p-6 text-center">
                     <div class="text-gray-500 text-sm mb-2">Average Monthly</div>
                     <div class="text-3xl font-bold text-purple-600" id="avgMonthly">$0</div>
                  </div>
                  <div class="card p-6 text-center">
                     <div class="text-gray-500 text-sm mb-2">Highest Month</div>
                     <div class="text-3xl font-bold text-red-600" id="highestMonth">$0</div>
                  </div>
                  <div class="card p-6 text-center">
                     <div class="text-gray-500 text-sm mb-2">Lowest Month</div>
                     <div class="text-3xl font-bold text-green-600" id="lowestMonth">$0</div>
                  </div>
                  <div class="card p-6 text-center">
                     <div class="text-gray-500 text-sm mb-2">Yearly Total</div>
                     <div class="text-3xl font-bold text-blue-600" id="yearlyTotal">$0</div>
                  </div>
               </div>
               <div class="mt-6">
                  <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-chart-area mr-2 text-indigo-500"></i>Year-over-Year Comparison</h3>
                  <div class="chart-container" style="height: 350px;">
                     <canvas id="yearComparisonChart"></canvas>
                  </div>
               </div>
            </div>
            <div id="insightsTab" class="p-6" style="display: none;">
               <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                  <div class="card p-6">
                     <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-arrow-trend-up mr-2 text-purple-500"></i>Spending Trend</h3>
                     <div id="trendIndicator" class="text-center py-8"></div>
                  </div>
                  <div class="card p-6">
                     <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-exclamation-triangle mr-2 text-orange-500"></i>Budget Alerts</h3>
                     <div id="budgetAlerts" class="space-y-3"></div>
                  </div>
               </div>
               <div class="card p-6 mb-6">
                  <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-trophy mr-2 text-yellow-500"></i>Top Spending Categories</h3>
                  <div id="topCategories"></div>
               </div>
               <div class="card p-6">
                  <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-lightbulb mr-2 text-blue-500"></i>Smart Recommendations</h3>
                  <div id="recommendations" class="space-y-3"></div>
               </div>
            </div>
         </div>
      </div>
      <div id="expenseModal" class="modal">
         <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-plus-circle mr-2 text-purple-500"></i><span id="modalTitle">Add Expense</span></h2>
               <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <form id="expenseForm" onsubmit="saveExpense(event)">
               <input type="hidden" id="recordId">
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Item Name</label><input type="text" id="itemName" class="input-field" list="itemList" required placeholder="e.g., Walmart, Costco">
                  <datalist id="itemList"></datalist>
               </div>
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label><input type="text" id="category" class="input-field" list="categoryList" required placeholder="e.g., Grocery, Gas, Utilities">
                  <datalist id="categoryList"></datalist>
               </div>
               <div class="grid grid-cols-2 gap-4 mb-4">
                  <div><label class="block text-sm font-semibold text-gray-700 mb-2">Year</label><select id="year" class="input-field" required></select></div>
                  <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Month</label>
                     <select id="month" class="input-field" required>
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03">March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                     </select>
                  </div>
               </div>
               <div class="grid grid-cols-2 gap-4 mb-4">
                  <div><label class="block text-sm font-semibold text-gray-700 mb-2">Budget Amount</label><input type="number" id="budget" class="input-field" step="0.01" required placeholder="0.00"></div>
                  <div><label class="block text-sm font-semibold text-gray-700 mb-2">Actual Amount</label><input type="number" id="actual" class="input-field" step="0.01" placeholder="0.00"></div>
               </div>
               <div class="mb-6">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">LLC Account</label>
                  <select id="llc" class="input-field">
                     <option value="No">No - Personal Expense</option>
                     <option value="Yes">Yes - Business Eligible</option>
                  </select>
                  <p class="text-xs text-gray-500 mt-1"><i class="fas fa-info-circle mr-1"></i>Select "Yes" if this expense should be paid through LLC account</p>
               </div>
               <div class="flex gap-3"><button type="submit" class="btn-primary flex-1"><i class="fas fa-save mr-2"></i>Save Expense</button><button type="button" onclick="closeModal()" class="btn-secondary">Cancel</button></div>
            </form>
         </div>
      </div>
      <script>
         // Airtable Configuration
         const AIRTABLE_API_KEY = 'patdWEvbUXXndHirs.833e3e18250b2a7914a25b37d6419ba09156c1dcd97cfe99208e2489cb193ce9';
         const BASE_ID = 'appfAAvs2G6gk3O0V';
         const TABLE_NAME = 'Budget';
         
         let allExpenses = [];
         let charts = { pie: null, llc: null, line: null, budgetActual: null, utilization: null, yearComparison: null, categoryTrend: null };
         
         document.addEventListener('DOMContentLoaded', function() {
             populateYearDropdown();
             loadData();
         });
         
         function populateYearDropdown() {
             const yearSelect = document.getElementById('year');
             const currentYear = new Date().getFullYear();
             for (let year = 2025; year <= 2045; year++) {
                 const option = document.createElement('option');
                 option.value = year;
                 option.textContent = year;
                 if (year === currentYear) option.selected = true;
                 yearSelect.appendChild(option);
             }
         }
         
         async function loadData() {
             try {
                 const response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`, {
                     headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
                 });
                 if (!response.ok) throw new Error('Failed to fetch data');
                 const data = await response.json();
                 allExpenses = data.records;
                 populateFilters();
                 populateCategorySelector();
                 populateCategoryDatalist();
                 populateItemDatalist();
                 renderExpenses();
                 updateStats();
                 updateCharts();
                 showNotification('Data loaded successfully!', 'success');
             } catch (error) {
                 console.error('Error:', error);
                 showNotification('Error: ' + error.message, 'error');
             }
         }
         
         function populateFilters() {
             const yearSelector = document.getElementById('yearSelector');
             const monthSelector = document.getElementById('monthSelector');
             yearSelector.innerHTML = '<option value="all">All Years</option>';
             monthSelector.innerHTML = '<option value="all">All Months</option>';
             const years = [...new Set(allExpenses.map(exp => exp.fields.Year).filter(Boolean))].sort().reverse();
             const months = [...new Set(allExpenses.map(exp => exp.fields.Month).filter(Boolean))].sort();
             years.forEach(year => {
                 const option = document.createElement('option');
                 option.value = year;
                 option.textContent = year;
                 yearSelector.appendChild(option);
             });
             const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
             months.forEach(month => {
                 const option = document.createElement('option');
                 option.value = month;
                 const monthNum = parseInt(month);
                 option.textContent = monthNames[monthNum - 1] || month;
                 monthSelector.appendChild(option);
             });
             const currentYear = new Date().getFullYear();
             const currentMonth = String(new Date().getMonth() + 1).padStart(2, '0');
             if (years.includes(currentYear)) yearSelector.value = currentYear;
             if (months.includes(currentMonth)) monthSelector.value = currentMonth;
         }
         
         function filterByPeriod() {
             renderExpenses();
             updateStats();
             updateCharts();
             updateInsights();
         }
         
         function getFilteredExpenses() {
             const selectedYear = document.getElementById('yearSelector').value;
             const selectedMonth = document.getElementById('monthSelector').value;
             let filtered = allExpenses;
             if (selectedYear !== 'all') filtered = filtered.filter(exp => String(exp.fields.Year) === selectedYear);
             if (selectedMonth !== 'all') filtered = filtered.filter(exp => exp.fields.Month === selectedMonth);
             return filtered;
         }
         
         function renderExpenses() {
             const container = document.getElementById('expensesList');
             const filteredExpenses = getFilteredExpenses();
             if (filteredExpenses.length === 0) {
                 container.innerHTML = `<div class="text-center py-12 text-gray-400"><i class="fas fa-inbox text-6xl mb-4"></i><p class="text-lg">No expenses found</p><button onclick="openAddExpenseModal()" class="btn-primary mt-4"><i class="fas fa-plus mr-2"></i>Add Your First Expense</button></div>`;
                 return;
             }
             const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
             container.innerHTML = filteredExpenses.map(expense => {
                 const fields = expense.fields;
                 const budget = fields.Budget || 0;
                 const actual = fields.Actual || 0;
                 const variance = budget - actual;
                 const varianceClass = variance >= 0 ? 'text-green-600' : 'text-red-600';
                 const varianceIcon = variance >= 0 ? 'fa-arrow-down' : 'fa-arrow-up';
                 const monthDisplay = fields.Month ? monthNames[parseInt(fields.Month) - 1] : 'N/A';
                 return `
                    <div class="expense-row">
                        <div class="expense-item"><span class="expense-label">Item:</span><span class="font-semibold text-gray-800">${fields.Item || 'Unnamed'}</span></div>
                        <div class="expense-item"><span class="expense-label">Category:</span><span class="inline-block px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-semibold">${fields.Category || 'N/A'}</span></div>
                        <div class="expense-item"><span class="expense-label">Date:</span><span class="text-gray-600">${monthDisplay} ${fields.Year || 'N/A'}</span></div>
                        <div class="expense-item"><span class="expense-label">Budget:</span><span class="font-semibold text-gray-700">$${budget.toFixed(2)}</span></div>
                        <div class="expense-item"><span class="expense-label">Actual:</span><span class="font-semibold ${actual > budget ? 'text-red-600' : 'text-gray-700'}">$${actual.toFixed(2)}</span></div>
                        <div class="expense-item"><span class="expense-label">Variance:</span><span class="${varianceClass} font-semibold"><i class="fas ${varianceIcon} mr-1"></i>$${Math.abs(variance).toFixed(2)}</span></div>
                        <div class="expense-item"><span class="expense-label">LLC:</span><span class="badge ${fields.LLC === 'Yes' ? 'badge-llc' : 'badge-personal'}">${fields.LLC || 'No'}</span></div>
                        <div class="expense-item"><span class="expense-label">Actions:</span><div class="flex gap-3">
                            <button onclick="editExpense('${expense.id}')" class="text-blue-500 hover:text-blue-700 text-lg" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteExpense('${expense.id}')" class="text-red-500 hover:text-red-700 text-lg" title="Delete"><i class="fas fa-trash"></i></button>
                        </div></div>
                    </div>
                `;
             }).join('');
         }
         
         function updateStats() {
             const expenses = getFilteredExpenses();
             const totalBudget = expenses.reduce((sum, exp) => sum + (exp.fields.Budget || 0), 0);
             const totalActual = expenses.reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             const llcTotal = expenses.filter(exp => exp.fields.LLC === 'Yes').reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             const remaining = totalBudget - totalActual;
             const amarShare = totalActual / 2;
             const priyaShare = totalActual / 2;
             document.getElementById('totalBudget').textContent = `$${totalBudget.toFixed(2)}`;
             document.getElementById('totalActual').textContent = `$${totalActual.toFixed(2)}`;
             document.getElementById('llcTotal').textContent = `$${llcTotal.toFixed(2)}`;
             document.getElementById('remaining').textContent = `$${remaining.toFixed(2)}`;
             document.getElementById('amarShare').textContent = `$${amarShare.toFixed(2)}`;
             document.getElementById('priyaShare').textContent = `$${priyaShare.toFixed(2)}`;
             const amarProgress = totalBudget > 0 ? (amarShare / totalBudget) * 100 : 0;
             const priyaProgress = totalBudget > 0 ? (priyaShare / totalBudget) * 100 : 0;
             document.getElementById('amarProgress').style.width = `${Math.min(amarProgress, 100)}%`;
             document.getElementById('priyaProgress').style.width = `${Math.min(priyaProgress, 100)}%`;
         }
         
         function updateCharts() {
             updatePieChart();
             updateLLCChart();
             updateLineChart();
             updateBudgetActualChart();
             updateUtilizationChart();
             updateYearComparisonChart();
         }
         
         function updatePieChart() {
             const ctx = document.getElementById('pieChart');
             if (!ctx) return;
             const expenses = getFilteredExpenses();
             const expensesByItem = {};
             expenses.forEach(exp => {
                 const item = exp.fields.Item || 'Other';
                 const actual = exp.fields.Actual || 0;
                 expensesByItem[item] = (expensesByItem[item] || 0) + actual;
             });
             if (charts.pie) charts.pie.destroy();
             charts.pie = new Chart(ctx, {
                 type: 'doughnut',
                 data: {
                     labels: Object.keys(expensesByItem),
                     datasets: [{ data: Object.values(expensesByItem), backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7', '#fa709a', '#fee140'] }]
                 },
                 options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, padding: 10, font: { size: 11 } } } } }
             });
         }
         
         function updateLLCChart() {
             const ctx = document.getElementById('llcChart');
             if (!ctx) return;
             const expenses = getFilteredExpenses();
             const llcExpenses = expenses.filter(exp => exp.fields.LLC === 'Yes').reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             const personalExpenses = expenses.filter(exp => exp.fields.LLC !== 'Yes').reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             if (charts.llc) charts.llc.destroy();
             charts.llc = new Chart(ctx, {
                 type: 'doughnut',
                 data: { labels: ['LLC Account', 'Personal'], datasets: [{ data: [llcExpenses, personalExpenses], backgroundColor: ['#4facfe', '#f5576c'] }] },
                 options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
             });
         }
         
         function updateBudgetActualChart() {
             const ctx = document.getElementById('budgetActualChart');
             if (!ctx) return;
             const expenses = getFilteredExpenses();
             const categoryData = {};
             expenses.forEach(exp => {
                 const item = exp.fields.Item || 'Other';
                 if (!categoryData[item]) categoryData[item] = { budget: 0, actual: 0 };
                 categoryData[item].budget += exp.fields.Budget || 0;
                 categoryData[item].actual += exp.fields.Actual || 0;
             });
             const labels = Object.keys(categoryData);
             if (charts.budgetActual) charts.budgetActual.destroy();
             charts.budgetActual = new Chart(ctx, {
                 type: 'bar',
                 data: {
                     labels: labels,
                     datasets: [
                         { label: 'Budget', data: labels.map(l => categoryData[l].budget), backgroundColor: '#667eea' },
                         { label: 'Actual', data: labels.map(l => categoryData[l].actual), backgroundColor: '#f5576c' }
                     ]
                 },
                 options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
             });
         }
         
         function updateUtilizationChart() {
             const ctx = document.getElementById('utilizationChart');
             if (!ctx) return;
             const expenses = getFilteredExpenses();
             const categoryData = {};
             expenses.forEach(exp => {
                 const item = exp.fields.Item || 'Other';
                 if (!categoryData[item]) categoryData[item] = { budget: 0, actual: 0 };
                 categoryData[item].budget += exp.fields.Budget || 0;
                 categoryData[item].actual += exp.fields.Actual || 0;
             });
             const labels = Object.keys(categoryData);
             const utilizationData = labels.map(l => {
                 const b = categoryData[l].budget;
                 return b > 0 ? (categoryData[l].actual / b) * 100 : 0;
             });
             if (charts.utilization) charts.utilization.destroy();
             charts.utilization = new Chart(ctx, {
                 type: 'bar',
                 data: {
                     labels: labels,
                     datasets: [{ label: 'Utilization %', data: utilizationData, backgroundColor: utilizationData.map(v => v > 100 ? '#ef4444' : v > 90 ? '#f59e0b' : '#10b981') }]
                 },
                 options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, max: 120 } } }
             });
         }
         
         function updateLineChart() {
             const ctx = document.getElementById('lineChart');
             if (!ctx) return;
             const monthlyData = {};
             allExpenses.forEach(exp => {
                 const key = `${exp.fields.Year}-${String(exp.fields.Month).padStart(2, '0')}`;
                 monthlyData[key] = (monthlyData[key] || 0) + (exp.fields.Actual || 0);
             });
             const sortedMonths = Object.keys(monthlyData).sort();
             const monthlyTotals = sortedMonths.map(m => monthlyData[m]);
             if (charts.line) charts.line.destroy();
             charts.line = new Chart(ctx, {
                 type: 'line',
                 data: {
                     labels: sortedMonths,
                     datasets: [{ label: 'Monthly Spending', data: monthlyTotals, borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', tension: 0.4, fill: true }]
                 },
                 options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
             });
             if (monthlyTotals.length > 0) {
                 const avg = monthlyTotals.reduce((a, b) => a + b, 0) / monthlyTotals.length;
                 document.getElementById('avgMonthly').textContent = `$${avg.toFixed(2)}`;
                 document.getElementById('highestMonth').textContent = `$${Math.max(...monthlyTotals).toFixed(2)}`;
                 document.getElementById('lowestMonth').textContent = `$${Math.min(...monthlyTotals).toFixed(2)}`;
                 document.getElementById('yearlyTotal').textContent = `$${monthlyTotals.reduce((a, b) => a + b, 0).toFixed(2)}`;
             }
         }
         
         function updateYearComparisonChart() {
             const ctx = document.getElementById('yearComparisonChart');
             if (!ctx) return;
             const yearlyData = {};
             allExpenses.forEach(exp => {
                 const year = exp.fields.Year;
                 const month = exp.fields.Month;
                 if (!year || !month) return;
                 if (!yearlyData[year]) yearlyData[year] = {};
                 if (!yearlyData[year][month]) yearlyData[year][month] = 0;
                 yearlyData[year][month] += exp.fields.Actual || 0;
             });
             const years = Object.keys(yearlyData).sort();
             const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
             const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
             const colors = ['#667eea', '#f5576c', '#4facfe', '#43e97b', '#fa709a'];
             const datasets = years.map((year, i) => ({
                 label: year,
                 data: months.map(m => yearlyData[year][m] || 0),
                 borderColor: colors[i % colors.length],
                 tension: 0.4
             }));
             if (charts.yearComparison) charts.yearComparison.destroy();
             charts.yearComparison = new Chart(ctx, {
                 type: 'line',
                 data: { labels: monthNames, datasets: datasets },
                 options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
             });
         }
         
         function updateInsights() {
             updateTrendIndicator();
             updateBudgetAlerts();
             updateTopCategories();
             updateRecommendations();
         }
         
         function updateTrendIndicator() {
             const container = document.getElementById('trendIndicator');
             if (!container) return;
             const monthlyData = {};
             allExpenses.forEach(exp => {
                 const key = `${exp.fields.Year}-${String(exp.fields.Month).padStart(2, '0')}`;
                 monthlyData[key] = (monthlyData[key] || 0) + (exp.fields.Actual || 0);
             });
             const sortedMonths = Object.keys(monthlyData).sort();
             if (sortedMonths.length < 6) {
                 container.innerHTML = '<p class="text-gray-500">Not enough data</p>';
                 return;
             }
             const recent = sortedMonths.slice(-3).map(m => monthlyData[m]);
             const older = sortedMonths.slice(-6, -3).map(m => monthlyData[m]);
             const avgRecent = recent.reduce((a, b) => a + b, 0) / recent.length;
             const avgOlder = older.reduce((a, b) => a + b, 0) / older.length;
             const change = ((avgRecent - avgOlder) / avgOlder) * 100;
             let icon, color, text, message;
             if (change > 5) {
                 icon = 'fa-arrow-trend-up';
                 color = 'text-red-500';
                 text = 'Spending is Increasing';
                 message = `Your spending increased by ${change.toFixed(1)}%`;
             } else if (change < -5) {
                 icon = 'fa-arrow-trend-down';
                 color = 'text-green-500';
                 text = 'Spending is Decreasing';
                 message = `Great! Spending decreased by ${Math.abs(change).toFixed(1)}%`;
             } else {
                 icon = 'fa-minus';
                 color = 'text-blue-500';
                 text = 'Spending is Stable';
                 message = 'Your spending is stable';
             }
             container.innerHTML = `<i class="fas ${icon} ${color} text-6xl mb-4"></i><h4 class="text-2xl font-bold ${color} mb-2">${text}</h4><p class="text-gray-600">${message}</p>`;
         }
         
         function updateBudgetAlerts() {
             const container = document.getElementById('budgetAlerts');
             if (!container) return;
             const expenses = getFilteredExpenses();
             const categoryData = {};
             expenses.forEach(exp => {
                 const item = exp.fields.Item || 'Other';
                 if (!categoryData[item]) categoryData[item] = { budget: 0, actual: 0 };
                 categoryData[item].budget += exp.fields.Budget || 0;
                 categoryData[item].actual += exp.fields.Actual || 0;
             });
             const alerts = [];
             Object.keys(categoryData).forEach(item => {
                 const { budget, actual } = categoryData[item];
                 const util = budget > 0 ? (actual / budget) * 100 : 0;
                 if (util > 100) alerts.push(`<div class="p-3 bg-red-50 border-l-4 border-red-500 rounded"><i class="fas fa-exclamation-circle text-red-500 mr-2"></i><strong>${item}</strong> is over budget by $${(actual - budget).toFixed(2)}</div>`);
                 else if (util > 90) alerts.push(`<div class="p-3 bg-orange-50 border-l-4 border-orange-500 rounded"><i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i><strong>${item}</strong> is at ${util.toFixed(0)}% of budget</div>`);
             });
             container.innerHTML = alerts.length ? alerts.join('') : '<p class="text-green-600"><i class="fas fa-check-circle mr-2"></i>All within budget!</p>';
         }
         
         function updateTopCategories() {
             const container = document.getElementById('topCategories');
             if (!container) return;
             const expenses = getFilteredExpenses();
             const categoryData = {};
             expenses.forEach(exp => {
                 const item = exp.fields.Item || 'Other';
                 categoryData[item] = (categoryData[item] || 0) + (exp.fields.Actual || 0);
             });
             const sorted = Object.entries(categoryData).sort((a, b) => b[1] - a[1]).slice(0, 5);
             const total = Object.values(categoryData).reduce((a, b) => a + b, 0);
             const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'];
             container.innerHTML = sorted.map(([item, amount], i) => {
                 const pct = total > 0 ? (amount / total) * 100 : 0;
                 return `<div class="flex items-center justify-between p-3 border-b"><div class="flex items-center gap-3"><span class="text-2xl">${medals[i]}</span><div><div class="font-semibold">${item}</div><div class="text-sm text-gray-500">${pct.toFixed(1)}%</div></div></div><div class="text-lg font-bold text-purple-600">$${amount.toFixed(2)}</div></div>`;
             }).join('');
         }
         
         function updateRecommendations() {
             const container = document.getElementById('recommendations');
             if (!container) return;
             const expenses = getFilteredExpenses();
             const totalBudget = expenses.reduce((sum, exp) => sum + (exp.fields.Budget || 0), 0);
             const totalActual = expenses.reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             const llcTotal = expenses.filter(exp => exp.fields.LLC === 'Yes').reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             const recs = [];
             if (totalActual > totalBudget) {
                 recs.push(`<div class="p-4 bg-red-50 border-l-4 border-red-500 rounded"><i class="fas fa-chart-line text-red-500 mr-2"></i><strong>Reduce Spending</strong><p class="text-sm mt-1">Over budget by $${(totalActual - totalBudget).toFixed(2)}</p></div>`);
             } else {
                 recs.push(`<div class="p-4 bg-green-50 border-l-4 border-green-500 rounded"><i class="fas fa-thumbs-up text-green-500 mr-2"></i><strong>Great Job!</strong><p class="text-sm mt-1">Under budget with $${(totalBudget - totalActual).toFixed(2)} remaining</p></div>`);
             }
             const llcPct = totalActual > 0 ? (llcTotal / totalActual) * 100 : 0;
             if (llcPct < 30) {
                 recs.push(`<div class="p-4 bg-blue-50 border-l-4 border-blue-500 rounded"><i class="fas fa-building text-blue-500 mr-2"></i><strong>Maximize LLC</strong><p class="text-sm mt-1">Only ${llcPct.toFixed(0)}% through LLC. Review business expenses.</p></div>`);
             }
             container.innerHTML = recs.join('');
         }
         
         function populateCategorySelector() {
             const selector = document.getElementById('categorySelector');
             if (!selector) return;
             selector.innerHTML = '<option value="">Choose a category...</option>';
             const categories = [...new Set(allExpenses.map(exp => exp.fields.Category).filter(Boolean))].sort();
             categories.forEach(category => {
                 const option = document.createElement('option');
                 option.value = category;
                 option.textContent = category;
                 selector.appendChild(option);
             });
         }
         
         function populateCategoryDatalist() {
             const datalist = document.getElementById('categoryList');
             if (!datalist) return;
             datalist.innerHTML = '';
             const categories = [...new Set(allExpenses.map(exp => exp.fields.Category).filter(Boolean))].sort();
             categories.forEach(category => {
                 const option = document.createElement('option');
                 option.value = category;
                 datalist.appendChild(option);
             });
         }
         
         function populateItemDatalist() {
             const datalist = document.getElementById('itemList');
             if (!datalist) return;
             datalist.innerHTML = '';
             const items = [...new Set(allExpenses.map(exp => exp.fields.Item).filter(Boolean))].sort();
             items.forEach(item => {
                 const option = document.createElement('option');
                 option.value = item;
                 datalist.appendChild(option);
             });
         }
         
         function updateCategoryAnalysis() {
             const selectedCategory = document.getElementById('categorySelector').value;
             if (!selectedCategory) {
                 document.getElementById('categoryStats').style.display = 'none';
                 document.getElementById('categoryChartContainer').style.display = 'none';
                 return;
             }
             const categoryExpenses = allExpenses.filter(exp => exp.fields.Category === selectedCategory);
             const total = categoryExpenses.reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             const count = categoryExpenses.length;
             const monthlyData = {};
             categoryExpenses.forEach(exp => {
                 const key = `${exp.fields.Year}-${String(exp.fields.Month).padStart(2, '0')}`;
                 if (!monthlyData[key]) monthlyData[key] = 0;
                 monthlyData[key] += exp.fields.Actual || 0;
             });
             const avg = Object.keys(monthlyData).length > 0 ? total / Object.keys(monthlyData).length : 0;
             document.getElementById('categoryTotal').textContent = `$${total.toFixed(2)}`;
             document.getElementById('categoryAvg').textContent = `$${avg.toFixed(2)}`;
             document.getElementById('categoryCount').textContent = count;
             document.getElementById('categoryStats').style.display = 'grid';
             document.getElementById('categoryChartContainer').style.display = 'block';
             updateCategoryTrendChart(selectedCategory, monthlyData);
             updateCategoryDetails(categoryExpenses);
         }
         
         function updateCategoryTrendChart(category, monthlyData) {
             const ctx = document.getElementById('categoryTrendChart');
             if (!ctx) return;
             const sortedMonths = Object.keys(monthlyData).sort();
             const monthlyTotals = sortedMonths.map(m => monthlyData[m]);
             if (charts.categoryTrend) charts.categoryTrend.destroy();
             charts.categoryTrend = new Chart(ctx, {
                 type: 'line',
                 data: {
                     labels: sortedMonths,
                     datasets: [{
                         label: `${category} - Monthly Spending`,
                         data: monthlyTotals,
                         borderColor: '#667eea',
                         backgroundColor: 'rgba(102, 126, 234, 0.1)',
                         tension: 0.4,
                         fill: true,
                         pointRadius: 6,
                         pointHoverRadius: 8
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         legend: { display: true },
                         tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     return `Spending: $${context.parsed.y.toFixed(2)}`;
                                 }
                             }
                         }
                     },
                     scales: {
                         y: { beginAtZero: true, ticks: { callback: value => '$' + value.toFixed(0) } }
                     }
                 }
             });
         }
         
         function updateCategoryDetails(expenses) {
             const container = document.getElementById('categoryDetails');
             if (!container) return;
             const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
             const sortedExpenses = expenses.sort((a, b) => {
                 const aKey = `${a.fields.Year}-${String(a.fields.Month).padStart(2, '0')}`;
                 const bKey = `${b.fields.Year}-${String(b.fields.Month).padStart(2, '0')}`;
                 return bKey.localeCompare(aKey);
             });
             container.innerHTML = `
                 <div class="overflow-x-auto">
                     <table class="w-full">
                         <thead class="bg-gray-100">
                             <tr>
                                 <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Year</th>
                                 <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Month</th>
                                 <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Budget</th>
                                 <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Actual</th>
                                 <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Variance</th>
                                 <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">LLC</th>
                             </tr>
                         </thead>
                         <tbody>
                             ${sortedExpenses.map(exp => {
                                 const budget = exp.fields.Budget || 0;
                                 const actual = exp.fields.Actual || 0;
                                 const variance = budget - actual;
                                 const monthDisplay = exp.fields.Month ? monthNames[parseInt(exp.fields.Month) - 1] : 'N/A';
                                 return `
                                     <tr class="border-b hover:bg-gray-50">
                                         <td class="px-4 py-3 text-sm">${exp.fields.Year || 'N/A'}</td>
                                         <td class="px-4 py-3 text-sm">${monthDisplay}</td>
                                         <td class="px-4 py-3 text-sm font-semibold">$${budget.toFixed(2)}</td>
                                         <td class="px-4 py-3 text-sm font-semibold ${actual > budget ? 'text-red-600' : 'text-gray-700'}">$${actual.toFixed(2)}</td>
                                         <td class="px-4 py-3 text-sm font-semibold ${variance >= 0 ? 'text-green-600' : 'text-red-600'}">$${Math.abs(variance).toFixed(2)}</td>
                                         <td class="px-4 py-3 text-sm"><span class="badge ${exp.fields.LLC === 'Yes' ? 'badge-llc' : 'badge-personal'}">${exp.fields.LLC || 'No'}</span></td>
                                     </tr>
                                 `;
                             }).join('')}
                         </tbody>
                     </table>
                 </div>
             `;
         }
         
         function switchTab(tab) {
             document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
             document.querySelectorAll('[id$="Tab"]').forEach(content => content.style.display = 'none');
             event.target.closest('.tab-button').classList.add('active');
             document.getElementById(tab + 'Tab').style.display = 'block';
             if (tab === 'analytics' || tab === 'trends') updateCharts();
             if (tab === 'insights') updateInsights();
         }
         
         function openAddExpenseModal() {
             document.getElementById('modalTitle').textContent = 'Add Expense';
             document.getElementById('expenseForm').reset();
             document.getElementById('recordId').value = '';
             const currentMonth = String(new Date().getMonth() + 1).padStart(2, '0');
             document.getElementById('month').value = currentMonth;
             document.getElementById('expenseModal').classList.add('active');
         }
         
         function closeModal() {
             document.getElementById('expenseModal').classList.remove('active');
         }
         
         async function editExpense(id) {
             const expense = allExpenses.find(exp => exp.id === id);
             if (!expense) return;
             document.getElementById('modalTitle').textContent = 'Edit Expense';
             document.getElementById('recordId').value = id;
             document.getElementById('itemName').value = expense.fields.Item || '';
             document.getElementById('category').value = expense.fields.Category || '';
             document.getElementById('year').value = expense.fields.Year || '';
             document.getElementById('month').value = expense.fields.Month || '';
             document.getElementById('budget').value = expense.fields.Budget || '';
             document.getElementById('actual').value = expense.fields.Actual || '';
             document.getElementById('llc').value = expense.fields.LLC || 'No';
             document.getElementById('expenseModal').classList.add('active');
         }
         
         async function saveExpense(event) {
             event.preventDefault();
             const recordId = document.getElementById('recordId').value;
             const fields = {
                 Item: document.getElementById('itemName').value,
                 Category: document.getElementById('category').value,
                 Year: parseInt(document.getElementById('year').value),
                 Month: document.getElementById('month').value,
                 Budget: parseFloat(document.getElementById('budget').value) || 0,
                 Actual: parseFloat(document.getElementById('actual').value) || 0,
                 LLC: document.getElementById('llc').value
             };
             try {
                 const url = recordId ? `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}/${recordId}` : `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`;
                 const response = await fetch(url, {
                     method: recordId ? 'PATCH' : 'POST',
                     headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}`, 'Content-Type': 'application/json' },
                     body: JSON.stringify({ fields })
                 });
                 if (!response.ok) throw new Error('Failed to save');
                 closeModal();
                 await loadData();
                 showNotification(recordId ? 'Updated!' : 'Added!', 'success');
             } catch (error) {
                 showNotification('Error: ' + error.message, 'error');
             }
         }
         
         async function deleteExpense(id) {
             if (!confirm('Delete this expense?')) return;
             try {
                 const response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}/${id}`, {
                     method: 'DELETE',
                     headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
                 });
                 if (!response.ok) throw new Error('Failed to delete');
                 await loadData();
                 showNotification('Deleted!', 'success');
             } catch (error) {
                 showNotification('Error: ' + error.message, 'error');
             }
         }
         
         function showNotification(message, type) {
             const notification = document.getElementById('notification');
             const notificationText = document.getElementById('notificationText');
             notificationText.textContent = message;
             notification.className = `notification ${type}`;
             notification.style.display = 'block';
             setTimeout(() => notification.style.display = 'none', 3000);
         }
      </script>
   </body>
</html>