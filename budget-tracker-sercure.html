<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="mobile-web-app-capable" content="yes">
      <title>Family Budget Tracker Pro</title>
      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="https://cdn.tailwindcss.com"></script>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
      <style>
         @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
         * { font-family: 'Inter', sans-serif; }
         .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
         .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; }
         .card:hover { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); transform: translateY(-2px); }
         .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; padding: 24px; position: relative; overflow: hidden; }
         .stat-card::before { content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: pulse 4s ease-in-out infinite; }
         @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }
         .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
         .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); }
         .btn-secondary { background: white; color: #667eea; padding: 12px 24px; border-radius: 8px; border: 2px solid #667eea; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
         .btn-secondary:hover { background: #667eea; color: white; }
         .input-field { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; }
         .input-field:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
         .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; }
         .modal.active { display: flex; }
         .modal-content { background: white; border-radius: 16px; padding: 32px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
         @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
         .expense-row { display: grid; grid-template-columns: 1fr; gap: 8px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
         .expense-row:hover { background: #f9fafb; }
         .expense-header { display: none; }
         .spinner { border: 4px solid #e5e7eb; border-top: 4px solid #667eea; border-radius: 50%; width: 48px; height: 48px; animation: spin 0.8s linear infinite; display: block; margin: 0 auto; }
         @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
         .btn-loading { position: relative; color: transparent !important; pointer-events: none; }
         .btn-loading::after { content: ''; position: absolute; width: 20px; height: 20px; top: 50%; left: 50%; margin-left: -10px; margin-top: -10px; border: 3px solid #ffffff; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
         .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
         .expense-label { font-size: 12px; color: #6b7280; font-weight: 600; }
         .payment-row { display: grid; grid-template-columns: 1fr; gap: 8px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
         .payment-row:hover { background: #f9fafb; }
         @media (min-width: 768px) {
            .expense-row { grid-template-columns: 1.5fr 1fr 1fr 0.9fr 0.9fr 0.9fr 0.6fr 0.5fr 90px; gap: 8px; padding: 16px; border: none; border-bottom: 1px solid #f3f4f6; border-radius: 0; margin-bottom: 0; box-shadow: none; }
            .expense-header { display: grid; font-weight: 700; color: #374151; background: #f9fafb; border-radius: 8px; }
            .expense-item { display: block; padding: 0; }
            .expense-label { display: none; }
            .payment-row { grid-template-columns: 1fr 1fr 1fr 2fr 80px; gap: 12px; padding: 16px; border: none; border-bottom: 1px solid #f3f4f6; border-radius: 0; margin-bottom: 0; box-shadow: none; }
         }
         .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
         .badge-llc { background: #dcfce7; color: #166534; }
         .badge-personal { background: #fef3c7; color: #92400e; }
         .loading { display: block; width: 48px; height: 48px; border: 4px solid #e5e7eb; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
         @keyframes spin { to { transform: rotate(360deg); } }
         
         .fancy-spinner {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
         }
         
         .fancy-spinner-inner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 70%;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-bottom-color: white;
            border-radius: 50%;
            animation: spin-reverse 2s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
         }
         
         .fancy-spinner-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
            animation: pulse-dot 1.5s ease-in-out infinite;
         }
         
         .loading-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: bounce-dot 1.4s ease-in-out infinite;
         }
         
         @keyframes spin-reverse {
            to { transform: translate(-50%, -50%) rotate(-360deg); }
         }
         
         @keyframes pulse-dot {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.6; }
         }
         
         @keyframes bounce-dot {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
         }
         .chart-container { position: relative; height: 300px; margin-top: 20px; }
         .progress-bar { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-top: 8px; }
         .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s ease; }
         .tab-button { padding: 12px 24px; border: none; background: transparent; color: #6b7280; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
         .tab-button.active { color: #667eea; border-bottom-color: #667eea; }
         .notification { position: fixed; top: 20px; right: 20px; left: 20px; background: white; padding: 16px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); z-index: 2000; display: none; animation: slideIn 0.3s ease; font-size: 14px; }
         @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
         .notification.success { border-left: 4px solid #10b981; }
         .notification.error { border-left: 4px solid #ef4444; }
         .fab { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; font-size: 24px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); cursor: pointer; z-index: 100; display: flex; align-items: center; justify-content: center; }
         .fab:active { transform: scale(0.95); }
         .mobile-only { display: block; }
         .desktop-only { display: none; }
         @media (min-width: 768px) {
            .notification { right: 20px; left: auto; }
            .fab { display: none; }
            .mobile-only { display: none; }
            .desktop-only { display: block; }
            .modal-content { padding: 32px; }
            .chart-container { height: 300px; }
            .stat-card { padding: 24px; }
            .tab-button { padding: 12px 24px; font-size: 14px; }
         }
         @media (max-width: 767px) {
            .modal-content { padding: 20px; }
            .chart-container { height: 250px; }
            .stat-card { padding: 16px; }
            .tab-button { padding: 10px 12px; font-size: 13px; }
            .input-field { font-size: 16px; }
            body { padding-bottom: 80px; }
         }
      </style>
   </head>
   <body class="bg-gray-50">
      <div id="globalLoadingOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;">
         <div style="position: relative; width: 120px; height: 120px;">
            <div class="fancy-spinner"></div>
            <div class="fancy-spinner-inner"></div>
            <div class="fancy-spinner-dot"></div>
         </div>
         <p style="font-size: 24px; font-weight: 700; color: white; margin-top: 32px; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">Budget Tracker</p>
         <p style="font-size: 16px; color: rgba(255,255,255,0.9); margin-top: 8px; font-weight: 500;">Loading your data...</p>
         <div style="margin-top: 24px; display: flex; gap: 8px;">
            <div class="loading-dot" style="animation-delay: 0s;"></div>
            <div class="loading-dot" style="animation-delay: 0.2s;"></div>
            <div class="loading-dot" style="animation-delay: 0.4s;"></div>
         </div>
      </div>
      <div id="notification" class="notification">
         <div class="flex items-center gap-3"><i class="fas fa-check-circle text-green-500"></i><span id="notificationText"></span></div>
      </div>
      <div id="slideMenu" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50">
         <div class="p-6">
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-bars mr-2"></i>Menu</h2>
               <button onclick="toggleMenu()" class="text-gray-400 hover:text-gray-600">
                  <i class="fas fa-times text-2xl"></i>
               </button>
            </div>
            <div class="space-y-3">
               <button onclick="openFixedExpensesModal(); toggleMenu();" class="w-full text-left px-4 py-3 rounded-lg hover:bg-purple-50 transition-colors flex items-center gap-3">
                  <i class="fas fa-repeat text-purple-600 text-xl"></i>
                  <div>
                     <div class="font-semibold text-gray-800">Fixed Expenses</div>
                     <div class="text-xs text-gray-500">Manage recurring expenses</div>
                  </div>
               </button>
               <button onclick="openLLCExpensesModal(); toggleMenu();" class="w-full text-left px-4 py-3 rounded-lg hover:bg-purple-50 transition-colors flex items-center gap-3">
                  <i class="fas fa-building text-purple-600 text-xl"></i>
                  <div>
                     <div class="font-semibold text-gray-800">LLC Eligible Expenses</div>
                     <div class="text-xs text-gray-500">Define business-eligible items</div>
                  </div>
               </button>
               <button onclick="openMonthlySummary(); toggleMenu();" class="w-full text-left px-4 py-3 rounded-lg hover:bg-purple-50 transition-colors flex items-center gap-3">
                  <i class="fas fa-chart-bar text-purple-600 text-xl"></i>
                  <div>
                     <div class="font-semibold text-gray-800">Monthly Summary</div>
                     <div class="text-xs text-gray-500">View detailed monthly reports</div>
                  </div>
               </button>
               <button onclick="openPredictiveBudgeting(); toggleMenu();" class="w-full text-left px-4 py-3 rounded-lg hover:bg-purple-50 transition-colors flex items-center gap-3">
                  <i class="fas fa-crystal-ball text-purple-600 text-xl"></i>
                  <div>
                     <div class="font-semibold text-gray-800">Predictive Budgeting</div>
                     <div class="text-xs text-gray-500">AI-powered spending predictions</div>
                  </div>
               </button>
               <button onclick="openAIInsights(); toggleMenu();" class="w-full text-left px-4 py-3 rounded-lg hover:bg-purple-50 transition-colors flex items-center gap-3">
                  <i class="fas fa-brain text-purple-600 text-xl"></i>
                  <div>
                     <div class="font-semibold text-gray-800">AI Insights</div>
                     <div class="text-xs text-gray-500">Smart spending analysis & tips</div>
                  </div>
               </button>
               <button onclick="openAdvancedAnalytics(); toggleMenu();" class="w-full text-left px-4 py-3 rounded-lg hover:bg-purple-50 transition-colors flex items-center gap-3">
                  <i class="fas fa-chart-pie text-purple-600 text-xl"></i>
                  <div>
                     <div class="font-semibold text-gray-800">Advanced Analytics</div>
                     <div class="text-xs text-gray-500">Heatmaps, trends & visualizations</div>
                  </div>
               </button>
               <button onclick="openSmartSearch(); toggleMenu();" class="w-full text-left px-4 py-3 rounded-lg hover:bg-purple-50 transition-colors flex items-center gap-3">
                  <i class="fas fa-search text-purple-600 text-xl"></i>
                  <div>
                     <div class="font-semibold text-gray-800">Smart Search</div>
                     <div class="text-xs text-gray-500">Advanced search & filters</div>
                  </div>
               </button>
               <button onclick="openSettings(); toggleMenu();" class="w-full text-left px-4 py-3 rounded-lg hover:bg-purple-50 transition-colors flex items-center gap-3">
                  <i class="fas fa-cog text-purple-600 text-xl"></i>
                  <div>
                     <div class="font-semibold text-gray-800">Settings</div>
                     <div class="text-xs text-gray-500">Configure your account</div>
                  </div>
               </button>
            </div>
         </div>
      </div>
      <div id="menuOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40" style="display: none;" onclick="toggleMenu()"></div>
      <div class="gradient-bg text-white py-4 md:py-8 px-4 md:px-6 shadow-lg">
         <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center">
               <div>
                  <h1 class="text-2xl md:text-4xl font-bold mb-1 md:mb-2"><i class="fas fa-chart-line mr-2 md:mr-3"></i>Budget Tracker</h1>
                  <p class="text-purple-100 text-xs md:text-base">Amar & Priya</p>
               </div>
               <div class="flex items-center gap-2 md:gap-4">
                  <button onclick="toggleMenu()" class="btn-secondary bg-white/20 border-white/40 text-white hover:bg-white hover:text-purple-700" title="Menu">
                     <i class="fas fa-bars"></i>
                  </button>
                  <button onclick="showMismatchNotifications()" class="btn-secondary bg-white/20 border-white/40 text-white hover:bg-white hover:text-purple-700 relative" title="Notifications" id="notificationBtn">
                     <i class="fas fa-bell"></i>
                     <span id="notificationBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold" style="display: none;">0</span>
                  </button>
                  <button onclick="openSettings()" class="btn-secondary bg-white/20 border-white/40 text-white hover:bg-white hover:text-purple-700" title="Settings"><i class="fas fa-cog"></i><span class="hidden md:inline ml-2">Settings</span></button>
                  <button onclick="openAddExpenseModal()" class="desktop-only btn-secondary bg-white/20 border-white/40 text-white hover:bg-white hover:text-purple-700"><i class="fas fa-plus mr-2"></i>Add Expense</button>
               </div>
            </div>
         </div>
      </div>
      <button onclick="openAddExpenseModal()" class="fab mobile-only">
         <i class="fas fa-plus"></i>
      </button>
      <div class="max-w-7xl mx-auto px-3 md:px-6 py-4 md:py-8">
         <div class="mb-4 md:mb-6 flex items-center gap-2 md:gap-4 flex-wrap">
            <label class="font-semibold text-gray-700 text-sm md:text-base">Filter:</label>
            <select id="yearSelector" onchange="filterByPeriod()" class="input-field flex-1 min-w-[100px] md:w-40">
               <option value="all">All Years</option>
            </select>
            <select id="monthSelector" onchange="filterByPeriod()" class="input-field flex-1 min-w-[120px] md:w-48">
               <option value="all">All Months</option>
            </select>
            <button onclick="loadData()" class="btn-secondary text-sm md:text-base"><i class="fas fa-sync-alt mr-1 md:mr-2"></i><span class="hidden md:inline">Refresh</span><i class="fas fa-sync-alt md:hidden"></i></button>
         </div>
         <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 md:gap-6 mb-6 md:mb-8">
            <div class="stat-card">
               <div class="relative z-10">
                  <div class="text-purple-100 text-xs md:text-sm font-semibold mb-1">BUDGET</div>
                  <div class="text-xl md:text-3xl font-bold" id="totalBudget">$0</div>
               </div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
               <div class="relative z-10">
                  <div class="text-pink-100 text-xs md:text-sm font-semibold mb-1">SPENT</div>
                  <div class="text-xl md:text-3xl font-bold" id="totalActual">$0</div>
               </div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
               <div class="relative z-10">
                  <div class="text-blue-100 text-xs md:text-sm font-semibold mb-1">LLC</div>
                  <div class="text-xl md:text-3xl font-bold" id="llcTotal">$0</div>
               </div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
               <div class="relative z-10">
                  <div class="text-green-100 text-xs md:text-sm font-semibold mb-1">LEFT</div>
                  <div class="text-xl md:text-3xl font-bold" id="remaining">$0</div>
               </div>
            </div>
            <div class="stat-card cursor-pointer" style="background: linear-gradient(135deg, #FA8BFF 0%, #2BD2FF 90%, #2BFF88 100%);" onclick="openPredictiveBudgeting()" title="Click to view detailed predictions">
               <div class="relative z-10">
                  <div class="text-white text-xs md:text-sm font-semibold mb-1 flex items-center gap-1">
                     <i class="fas fa-crystal-ball"></i>
                     <span>PREDICTED</span>
                  </div>
                  <div class="text-xl md:text-3xl font-bold" id="predictedTotal">$0</div>
                  <div class="text-xs text-white opacity-75 mt-1">Next Month</div>
               </div>
            </div>
         </div>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="card p-6">
               <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-3">
                     <div class="relative group cursor-pointer" onclick="document.getElementById('amarPictureInput').click()">
                        <div class="w-16 h-16 rounded-full overflow-hidden bg-blue-100 flex items-center justify-center border-2 border-blue-300">
                           <img id="amarPicture" src="" alt="Amar" class="w-full h-full object-cover" style="display: none;">
                           <i id="amarPictureIcon" class="fas fa-user-circle text-blue-500 text-4xl"></i>
                        </div>
                        <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                           <i class="fas fa-camera text-white text-xl"></i>
                        </div>
                     </div>
                     <input type="file" id="amarPictureInput" accept="image/*" style="display: none;" onchange="uploadProfilePicture('Amar', this)">
                     <h3 class="text-xl font-bold text-gray-800">Amar's Share</h3>
                  </div>
                  <div class="text-right">
                     <div class="text-2xl font-bold text-blue-600" id="amarShare">$0</div>
                     <div class="text-xs text-gray-500">Share: 50%</div>
                  </div>
               </div>
               <div class="mb-3">
                  <div class="flex justify-between text-sm mb-1">
                     <span class="text-gray-600">Contributed</span>
                     <span class="font-semibold text-blue-600"><span id="amarContribution">$0</span> (<span id="amarContributionPercent">0</span>%)</span>
                  </div>
                  <div class="progress-bar">
                     <div class="progress-fill" id="amarContributionProgress" style="width: 0%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);"></div>
                  </div>
               </div>
               <div class="mb-3">
                  <div class="flex justify-between text-sm mb-1">
                     <span class="text-gray-600">Remaining</span>
                     <span class="font-semibold text-gray-700" id="amarRemaining">$0</span>
                  </div>
                  <div class="progress-bar">
                     <div class="progress-fill" id="amarRemainingProgress" style="width: 100%; background: #e5e7eb;"></div>
                  </div>
               </div>
               <button onclick="openContributionModal('Amar')" class="btn-primary w-full text-sm py-2"><i class="fas fa-plus mr-2"></i>Add Payment</button>
            </div>
            <div class="card p-6">
               <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-3">
                     <div class="relative group cursor-pointer" onclick="document.getElementById('priyaPictureInput').click()">
                        <div class="w-16 h-16 rounded-full overflow-hidden bg-pink-100 flex items-center justify-center border-2 border-pink-300">
                           <img id="priyaPicture" src="" alt="Priya" class="w-full h-full object-cover" style="display: none;">
                           <i id="priyaPictureIcon" class="fas fa-user-circle text-pink-500 text-4xl"></i>
                        </div>
                        <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                           <i class="fas fa-camera text-white text-xl"></i>
                        </div>
                     </div>
                     <input type="file" id="priyaPictureInput" accept="image/*" style="display: none;" onchange="uploadProfilePicture('Priya', this)">
                     <h3 class="text-xl font-bold text-gray-800">Priya's Share</h3>
                  </div>
                  <div class="text-right">
                     <div class="text-2xl font-bold text-pink-600" id="priyaShare">$0</div>
                     <div class="text-xs text-gray-500">Share: 50%</div>
                  </div>
               </div>
               <div class="mb-3">
                  <div class="flex justify-between text-sm mb-1">
                     <span class="text-gray-600">Contributed</span>
                     <span class="font-semibold text-pink-600"><span id="priyaContribution">$0</span> (<span id="priyaContributionPercent">0</span>%)</span>
                  </div>
                  <div class="progress-bar">
                     <div class="progress-fill" id="priyaContributionProgress" style="width: 0%; background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);"></div>
                  </div>
               </div>
               <div class="mb-3">
                  <div class="flex justify-between text-sm mb-1">
                     <span class="text-gray-600">Remaining</span>
                     <span class="font-semibold text-gray-700" id="priyaRemaining">$0</span>
                  </div>
                  <div class="progress-bar">
                     <div class="progress-fill" id="priyaRemainingProgress" style="width: 100%; background: #e5e7eb;"></div>
                  </div>
               </div>
               <button onclick="openContributionModal('Priya')" class="btn-primary w-full text-sm py-2" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><i class="fas fa-plus mr-2"></i>Add Payment</button>
            </div>
         </div>
         <div class="card mb-8">
            <div class="border-b border-gray-200 px-3 md:px-6 overflow-x-auto">
               <div class="flex gap-2 min-w-max"><button class="tab-button active" onclick="switchTab('expenses')"><i class="fas fa-list mr-1 md:mr-2"></i><span class="hidden md:inline">Expenses</span><span class="md:hidden">List</span></button><button class="tab-button" onclick="switchTab('payments')"><i class="fas fa-hand-holding-usd mr-1 md:mr-2"></i><span class="hidden md:inline">Payments</span><span class="md:hidden">Pay</span></button><button class="tab-button" onclick="switchTab('category')"><i class="fas fa-filter mr-1 md:mr-2"></i><span class="hidden md:inline">Category</span><span class="md:hidden">Cat</span></button><button class="tab-button" onclick="switchTab('analytics')"><i class="fas fa-chart-pie mr-1 md:mr-2"></i><span class="hidden md:inline">Analytics</span><span class="md:hidden">Charts</span></button><button class="tab-button" onclick="switchTab('trends')"><i class="fas fa-chart-line mr-1 md:mr-2"></i>Trends</button><button class="tab-button" onclick="switchTab('insights')"><i class="fas fa-lightbulb mr-1 md:mr-2"></i>Insights</button></div>
            </div>
            <div id="expensesTab" class="p-3 md:p-6">
               <div class="mb-4 space-y-3">
                  <div class="flex gap-2">
                     <div class="flex-1">
                        <input type="text" id="expenseSearch" placeholder="ðŸ” Search expenses..." class="input-field" oninput="filterExpenses()">
                     </div>
                     <button onclick="toggleAdvancedFilters()" class="btn-secondary whitespace-nowrap">
                        <i class="fas fa-filter mr-2"></i>Filters
                     </button>
                  </div>
                  <div id="advancedFilters" style="display: none;" class="space-y-3 p-4 bg-gray-50 rounded-lg">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                           <label class="text-xs font-semibold text-gray-600 mb-1 block">Amount Range</label>
                           <div class="flex gap-2">
                              <input type="number" id="minAmount" placeholder="Min $" class="input-field text-sm" oninput="filterExpenses()">
                              <input type="number" id="maxAmount" placeholder="Max $" class="input-field text-sm" oninput="filterExpenses()">
                           </div>
                        </div>
                        <div>
                           <label class="text-xs font-semibold text-gray-600 mb-1 block">Day Range (within selected month)</label>
                           <div class="flex gap-2">
                              <input type="number" id="startDay" placeholder="From" min="1" max="31" class="input-field text-sm" oninput="filterExpenses()">
                              <input type="number" id="endDay" placeholder="To" min="1" max="31" class="input-field text-sm" oninput="filterExpenses()">
                           </div>
                        </div>
                        <div>
                           <label class="text-xs font-semibold text-gray-600 mb-1 block">Tags</label>
                           <select id="tagFilter" class="input-field text-sm" onchange="filterExpenses()">
                              <option value="">All Tags</option>
                           </select>
                        </div>
                     </div>
                     <div class="flex justify-end mt-3">
                        <button onclick="clearExpenseFilters()" class="px-4 py-2 text-sm text-purple-600 hover:text-purple-800 font-semibold bg-purple-50 rounded-lg hover:bg-purple-100 transition-colors" style="min-height: 44px; touch-action: manipulation;">
                           <i class="fas fa-times-circle mr-1"></i>Clear All Filters
                        </button>
                     </div>
                  </div>
               </div>
               <div class="expense-row expense-header">
                  <div>Item</div>
                  <div>Category</div>
                  <div>Date</div>
                  <div>Budget</div>
                  <div>Actual</div>
                  <div>Variance</div>
                  <div>LLC</div>
                  <div>Receipt</div>
                  <div>Actions</div>
               </div>
               <div id="expensesList" style="min-height: 300px;">
                  <div class="text-center py-12 text-gray-400" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 250px;">
                     <div class="loading mb-4"></div>
                     <p style="font-size: 16px; font-weight: 500;">Loading expenses...</p>
                  </div>
               </div>
            </div>
            <div id="paymentsTab" class="p-3 md:p-6" style="display: none;">
               <div class="flex justify-between items-center mb-6">
                  <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-hand-holding-usd mr-2 text-green-500"></i>Payment History</h3>
                  <button onclick="openContributionModal('Amar')" class="btn-primary"><i class="fas fa-plus mr-2"></i>Add Payment</button>
               </div>
               <div class="payment-row expense-header">
                  <div>Date</div>
                  <div>Person</div>
                  <div>Amount</div>
                  <div>Description</div>
                  <div>Actions</div>
               </div>
               <div id="paymentsList">
                  <div class="text-center py-12 text-gray-400">
                     <div class="loading mx-auto mb-4"></div>
                     <p>Loading payments...</p>
                  </div>
               </div>
            </div>
            <div id="categoryTab" class="p-6" style="display: none;">
               <div class="mb-6">
                  <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-filter mr-2 text-purple-500"></i>Select Category to Analyze</h3>
                  <select id="categorySelector" onchange="updateCategoryAnalysis()" class="input-field w-full max-w-md">
                     <option value="">Choose an expense category...</option>
                  </select>
               </div>
               <div id="categoryStats" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6" style="display: none;">
                  <div class="card p-6 text-center">
                     <div class="text-gray-500 text-sm mb-2">Total Spent</div>
                     <div class="text-3xl font-bold text-purple-600" id="categoryTotal">$0</div>
                  </div>
                  <div class="card p-6 text-center">
                     <div class="text-gray-500 text-sm mb-2">Monthly Average</div>
                     <div class="text-3xl font-bold text-blue-600" id="categoryAvg">$0</div>
                  </div>
                  <div class="card p-6 text-center">
                     <div class="text-gray-500 text-sm mb-2">Number of Entries</div>
                     <div class="text-3xl font-bold text-green-600" id="categoryCount">0</div>
                  </div>
               </div>
               <div id="categoryChartContainer" style="display: none;">
                  <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-chart-line mr-2 text-green-500"></i>Monthly Trend for Selected Category</h3>
                  <div class="chart-container" style="height: 400px;">
                     <canvas id="categoryTrendChart"></canvas>
                  </div>
                  <div class="mt-6">
                     <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-table mr-2 text-blue-500"></i>Detailed Breakdown</h3>
                     <div id="categoryDetails"></div>
                  </div>
               </div>
            </div>
            <div id="analyticsTab" class="p-6" style="display: none;">
               <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                  <div>
                     <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-chart-pie mr-2 text-purple-500"></i>Expense Distribution</h3>
                     <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                     </div>
                  </div>
                  <div>
                     <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-balance-scale mr-2 text-blue-500"></i>LLC vs Personal</h3>
                     <div class="chart-container">
                        <canvas id="llcChart"></canvas>
                     </div>
                  </div>
               </div>
               <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div>
                     <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-chart-bar mr-2 text-green-500"></i>Spending Per Category Per Month</h3>
                     <div class="chart-container">
                        <canvas id="categoryMonthlyChart"></canvas>
                     </div>
                  </div>
                  <div>
                     <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-hand-holding-usd mr-2 text-blue-500"></i>Contributions Per Month</h3>
                     <div class="chart-container">
                        <canvas id="contributionsMonthlyChart"></canvas>
                     </div>
                  </div>
               </div>
               <div class="mt-6">
                  <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-percentage mr-2 text-purple-500"></i>Contribution Coverage Per Year</h3>
                  <div class="chart-container">
                     <canvas id="contributionCoverageChart"></canvas>
                  </div>
               </div>
            </div>
            <div id="trendsTab" class="p-6" style="display: none;">
               <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-chart-line mr-2 text-green-500"></i>Monthly Spending Trends</h3>
               <div class="chart-container" style="height: 400px;">
                  <canvas id="lineChart"></canvas>
               </div>
               <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-8">
                  <div class="card p-6 text-center">
                     <div class="text-gray-500 text-sm mb-2">Average Monthly</div>
                     <div class="text-3xl font-bold text-purple-600" id="avgMonthly">$0</div>
                  </div>
                  <div class="card p-6 text-center">
                     <div class="text-gray-500 text-sm mb-2">Highest Month</div>
                     <div class="text-3xl font-bold text-red-600" id="highestMonth">$0</div>
                  </div>
                  <div class="card p-6 text-center">
                     <div class="text-gray-500 text-sm mb-2">Lowest Month</div>
                     <div class="text-3xl font-bold text-green-600" id="lowestMonth">$0</div>
                  </div>
                  <div class="card p-6 text-center">
                     <div class="text-gray-500 text-sm mb-2">Yearly Total</div>
                     <div class="text-3xl font-bold text-blue-600" id="yearlyTotal">$0</div>
                  </div>
               </div>
               <div class="mt-6">
                  <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-chart-area mr-2 text-indigo-500"></i>Year-over-Year Comparison</h3>
                  <div class="chart-container" style="height: 350px;">
                     <canvas id="yearComparisonChart"></canvas>
                  </div>
               </div>
            </div>
            <div id="insightsTab" class="p-6" style="display: none;">
               <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                  <div class="card p-6">
                     <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-arrow-trend-up mr-2 text-purple-500"></i>Spending Trend</h3>
                     <div id="trendIndicator" class="text-center py-8"></div>
                  </div>
                  <div class="card p-6">
                     <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-exclamation-triangle mr-2 text-orange-500"></i>Budget Alerts</h3>
                     <div id="budgetAlerts" class="space-y-3"></div>
                  </div>
               </div>
               <div class="card p-6 mb-6">
                  <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-trophy mr-2 text-yellow-500"></i>Top Spending Categories</h3>
                  <div id="topCategories"></div>
               </div>
               <div class="card p-6 mb-6">
                  <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-hand-holding-usd mr-2 text-green-500"></i>Contribution Trends</h3>
                  <div class="chart-container">
                     <canvas id="contributionTrendChart"></canvas>
                  </div>
               </div>
               <div class="card p-6">
                  <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-lightbulb mr-2 text-blue-500"></i>Smart Recommendations</h3>
                  <div id="recommendations" class="space-y-3"></div>
               </div>
            </div>
         </div>
      </div>
      <div id="expenseModal" class="modal">
         <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-plus-circle mr-2 text-purple-500"></i><span id="modalTitle">Add Expense</span></h2>
               <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <form id="expenseForm" onsubmit="saveExpense(event)">
               <input type="hidden" id="recordId">
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Item Name</label><input type="text" id="itemName" class="input-field" list="itemList" autocomplete="off" required placeholder="e.g., Walmart, Costco" oninput="suggestCategoryFromItem()">
                  <datalist id="itemList"></datalist>
               </div>
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label><input type="text" id="category" class="input-field" list="categoryList" autocomplete="off" required placeholder="e.g., Grocery, Gas, Utilities">
                  <datalist id="categoryList"></datalist>
               </div>
               <div class="grid grid-cols-3 gap-4 mb-4">
                  <div><label class="block text-sm font-semibold text-gray-700 mb-2">Year</label><select id="year" class="input-field" required></select></div>
                  <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Month</label>
                     <select id="month" class="input-field" required>
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03">March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                     </select>
                  </div>
                  <div><label class="block text-sm font-semibold text-gray-700 mb-2">Day</label><input type="number" id="day" class="input-field" min="1" max="31" required placeholder="1-31"></div>
               </div>
               <div class="grid grid-cols-2 gap-4 mb-4">
                  <div><label class="block text-sm font-semibold text-gray-700 mb-2">Budget Amount</label><input type="number" id="budget" class="input-field" step="0.01" placeholder="0.00" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'" value="0"></div>
                  <div><label class="block text-sm font-semibold text-gray-700 mb-2">Actual Amount <span class="text-red-500">*</span></label><input type="number" id="actual" class="input-field" step="0.01" placeholder="0.00" required></div>
               </div>
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">LLC Account</label>
                  <select id="llc" class="input-field">
                     <option value="No">No - Personal Expense</option>
                     <option value="Yes">Yes - Business Eligible</option>
                  </select>
                  <p class="text-xs text-gray-500 mt-1"><i class="fas fa-info-circle mr-1"></i>Select "Yes" if this expense should be paid through LLC account</p>
               </div>
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-tags mr-2 text-purple-500"></i>Tags</label>
                  <input type="text" id="tags" class="input-field" list="tagsList" autocomplete="off" placeholder="e.g., vacation, emergency, gift (comma-separated)">
                  <datalist id="tagsList"></datalist>
                  <p class="text-xs text-gray-500 mt-1"><i class="fas fa-info-circle mr-1"></i>Add tags to categorize expenses (separate with commas)</p>
               </div>
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-sticky-note mr-2 text-purple-500"></i>Notes</label>
                  <textarea id="notes" class="input-field" rows="3" placeholder="Add any additional notes or details about this expense..."></textarea>
                  <p class="text-xs text-gray-500 mt-1"><i class="fas fa-info-circle mr-1"></i>Optional notes for reference</p>
               </div>
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-receipt mr-2 text-purple-500"></i>Receipt</label>
                  <input type="file" id="receiptFile" class="input-field" accept="image/*,.pdf" capture="environment">
                  <p class="text-xs text-gray-500 mt-1"><i class="fas fa-camera mr-1"></i>Take photo or upload file (images, PDF)</p>
                  <div id="currentReceipt" class="mt-3" style="display: none;">
                     <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex items-center gap-3">
                           <i class="fas fa-file-image text-purple-500 text-xl"></i>
                           <div>
                              <p class="text-sm font-semibold text-gray-800" id="receiptFileName">Current Receipt</p>
                              <a id="receiptViewLink" href="#" target="_blank" class="text-xs text-blue-600 hover:underline">View Receipt</a>
                           </div>
                        </div>
                        <button type="button" onclick="removeReceipt()" class="text-red-500 hover:text-red-700" title="Remove receipt">
                           <i class="fas fa-times-circle text-xl"></i>
                        </button>
                     </div>
                  </div>
               </div>
               <div class="border-t pt-4 mb-6">
                  <h3 class="text-lg font-semibold text-gray-800 mb-3"><i class="fas fa-hand-holding-usd text-green-500 mr-2"></i>Contributions</h3>
                  <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Amar's Contribution</label>
                        <input type="number" id="amarContributionInput" class="input-field" step="0.01" placeholder="0.00">
                     </div>
                     <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Priya's Contribution</label>
                        <input type="number" id="priyaContributionInput" class="input-field" step="0.01" placeholder="0.00">
                     </div>
                  </div>
                  <p class="text-xs text-gray-500 mt-2"><i class="fas fa-info-circle mr-1"></i>Enter the amount each person has contributed towards their share</p>
               </div>
               <div class="flex gap-3"><button type="submit" class="btn-primary flex-1"><i class="fas fa-save mr-2"></i>Save Expense</button><button type="button" onclick="closeModal()" class="btn-secondary">Cancel</button></div>
            </form>
         </div>
      </div>
      <div id="contributionModal" class="modal">
         <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-hand-holding-usd mr-2 text-green-500"></i><span id="contributionModalTitle">Add Payment</span></h2>
               <button onclick="closeContributionModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <form id="contributionForm" onsubmit="saveStandaloneContribution(event)">
               <input type="hidden" id="contributionPerson">
               <input type="hidden" id="paymentRecordId">
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Person</label>
                  <select id="contributionPersonSelect" class="input-field" required onchange="updateContributionPerson()">
                     <option value="Amar">Amar</option>
                     <option value="Priya">Priya</option>
                  </select>
               </div>
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Amount</label>
                  <input type="number" id="contributionAmount" class="input-field" step="0.01" required placeholder="0.00" autofocus>
                  <p class="text-xs text-gray-500 mt-1"><i class="fas fa-info-circle mr-1"></i>Enter the payment amount</p>
               </div>
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Description (Optional)</label>
                  <input type="text" id="contributionDescription" class="input-field" placeholder="e.g., Bank transfer, Cash payment">
               </div>
               <div class="grid grid-cols-2 gap-4 mb-4">
                  <div><label class="block text-sm font-semibold text-gray-700 mb-2">Year</label><select id="contributionYear" class="input-field" required></select></div>
                  <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Month</label>
                     <select id="contributionMonth" class="input-field" required>
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03">March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                     </select>
                  </div>
               </div>
               <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                  <p class="text-sm text-blue-800"><i class="fas fa-info-circle mr-2"></i>This will create a payment record without linking to a specific expense.</p>
               </div>
               <div class="flex gap-3"><button type="submit" class="btn-primary flex-1"><i class="fas fa-save mr-2"></i>Save Payment</button><button type="button" onclick="closeContributionModal()" class="btn-secondary">Cancel</button></div>
            </form>
         </div>
      </div>
      <div id="mismatchModal" class="modal">
         <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>Contribution Mismatches</h2>
               <button onclick="closeMismatchModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="mismatchList" class="space-y-4">
               <div class="text-center py-8 text-gray-400">
                  <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                  <p class="text-lg">No mismatches found!</p>
                  <p class="text-sm mt-2">All contributions match spending for each month.</p>
               </div>
            </div>
            <div class="mt-6">
               <button onclick="closeMismatchModal()" class="btn-secondary w-full">Close</button>
            </div>
         </div>
      </div>
      <div id="fixedExpensesModal" class="modal">
         <div class="modal-content" style="max-width: 800px;">
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-repeat mr-2 text-purple-600"></i>Fixed Expenses</h2>
               <button onclick="closeFixedExpensesModal()" class="text-gray-400 hover:text-gray-600">
                  <i class="fas fa-times text-2xl"></i>
               </button>
            </div>
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
               <p class="text-sm text-blue-800"><i class="fas fa-info-circle mr-2"></i>Fixed expenses are automatically added to each month on the 1st. Changes only affect future months.</p>
            </div>
            <div class="mb-6">
               <button onclick="openAddFixedExpenseForm()" class="btn-primary w-full">
                  <i class="fas fa-plus mr-2"></i>Add Fixed Expense
               </button>
            </div>
            <div id="fixedExpensesList" class="space-y-3">
               <div class="text-center py-8 text-gray-400">
                  <i class="fas fa-inbox text-4xl mb-3"></i>
                  <p>No fixed expenses yet</p>
               </div>
            </div>
         </div>
      </div>
      <div id="addFixedExpenseModal" class="modal">
         <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold text-gray-800" id="fixedExpenseModalTitle">Add Fixed Expense</h2>
               <button onclick="closeAddFixedExpenseForm()" class="text-gray-400 hover:text-gray-600">
                  <i class="fas fa-times text-2xl"></i>
               </button>
            </div>
            <form id="fixedExpenseForm" onsubmit="saveFixedExpense(event)">
               <input type="hidden" id="fixedExpenseId">
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Item Name</label>
                  <input type="text" id="fixedItemName" class="input-field" required placeholder="e.g., Rent, Mortgage, Insurance">
               </div>
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                  <input type="text" id="fixedCategory" class="input-field" list="categoryList" required placeholder="e.g., Housing, Utilities">
               </div>
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Amount</label>
                  <input type="number" id="fixedAmount" class="input-field" step="0.01" required placeholder="0.00">
               </div>
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">LLC Account</label>
                  <select id="fixedLLC" class="input-field">
                     <option value="No">No - Personal Expense</option>
                     <option value="Yes">Yes - Business Eligible</option>
                  </select>
               </div>
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Start From</label>
                  <div class="grid grid-cols-2 gap-4">
                     <select id="fixedStartYear" class="input-field" required></select>
                     <select id="fixedStartMonth" class="input-field" required>
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03">March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                     </select>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">This expense will be added from this month onwards</p>
               </div>
               <div class="flex gap-3">
                  <button type="submit" class="btn-primary flex-1"><i class="fas fa-save mr-2"></i>Save</button>
                  <button type="button" onclick="closeAddFixedExpenseForm()" class="btn-secondary">Cancel</button>
               </div>
            </form>
         </div>
      </div>
      <div id="llcExpensesModal" class="modal">
         <div class="modal-content" style="max-width: 800px;">
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-building mr-2 text-purple-600"></i>LLC Eligible Expenses</h2>
               <button onclick="closeLLCExpensesModal()" class="text-gray-400 hover:text-gray-600">
                  <i class="fas fa-times text-2xl"></i>
               </button>
            </div>
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
               <p class="text-sm text-blue-800"><i class="fas fa-info-circle mr-2"></i>Define which expense items are eligible for LLC/business deduction. No cost needed, just item name and category.</p>
            </div>
            <div class="mb-6">
               <button onclick="openAddLLCExpenseForm()" class="btn-primary w-full">
                  <i class="fas fa-plus mr-2"></i>Add LLC Eligible Expense
               </button>
            </div>
            <div id="llcExpensesList" class="space-y-3">
               <div class="text-center py-8 text-gray-400">
                  <i class="fas fa-inbox text-4xl mb-3"></i>
                  <p>No LLC eligible expenses defined yet</p>
               </div>
            </div>
         </div>
      </div>
      <div id="addLLCExpenseModal" class="modal">
         <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold text-gray-800" id="llcExpenseModalTitle">Add LLC Eligible Expense</h2>
               <button onclick="closeAddLLCExpenseForm()" class="text-gray-400 hover:text-gray-600">
                  <i class="fas fa-times text-2xl"></i>
               </button>
            </div>
            <form id="llcExpenseForm" onsubmit="saveLLCExpense(event)">
               <input type="hidden" id="llcExpenseId">
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Expense Item</label>
                  <input type="text" id="llcItemName" class="input-field" required placeholder="e.g., Internet, Office Supplies, Software">
               </div>
               <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                  <input type="text" id="llcCategoryName" class="input-field" list="existingCategories" required placeholder="Start typing to see existing categories">
                  <datalist id="existingCategories"></datalist>
                  <p class="text-xs text-gray-500 mt-1">Select existing or type new category</p>
               </div>
               <div class="flex gap-3">
                  <button type="submit" class="btn-primary flex-1"><i class="fas fa-save mr-2"></i>Save</button>
                  <button type="button" onclick="closeAddLLCExpenseForm()" class="btn-secondary">Cancel</button>
               </div>
            </form>
         </div>
      </div>
      <div id="monthlySummaryModal" class="modal">
         <div class="modal-content" style="max-width: 900px;">
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-chart-bar mr-2 text-purple-600"></i>Monthly Summary</h2>
               <button onclick="closeMonthlySummary()" class="text-gray-400 hover:text-gray-600">
                  <i class="fas fa-times text-2xl"></i>
               </button>
            </div>
            <div class="mb-6 flex gap-4">
               <select id="summaryYear" class="input-field flex-1" onchange="loadMonthlySummary()"></select>
               <select id="summaryMonth" class="input-field flex-1" onchange="loadMonthlySummary()">
                  <option value="01">January</option>
                  <option value="02">February</option>
                  <option value="03">March</option>
                  <option value="04">April</option>
                  <option value="05">May</option>
                  <option value="06">June</option>
                  <option value="07">July</option>
                  <option value="08">August</option>
                  <option value="09">September</option>
                  <option value="10">October</option>
                  <option value="11">November</option>
                  <option value="12">December</option>
               </select>
            </div>
            <div id="monthlySummaryContent">
               <div class="text-center py-8 text-gray-400">
                  <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                  <p>Loading summary...</p>
               </div>
            </div>
         </div>
      </div>
      <div id="predictiveBudgetingModal" class="modal">
         <div class="modal-content" style="max-width: 1000px;">
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-crystal-ball mr-2 text-purple-600"></i>Predictive Budgeting</h2>
               <button onclick="closePredictiveBudgeting()" class="text-gray-400 hover:text-gray-600">
                  <i class="fas fa-times text-2xl"></i>
               </button>
            </div>
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
               <p class="text-sm text-blue-800"><i class="fas fa-info-circle mr-2"></i>AI-powered predictions based on your spending history and patterns.</p>
            </div>
            <div id="predictiveBudgetingContent">
               <div class="text-center py-8 text-gray-400">
                  <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                  <p>Analyzing your spending patterns...</p>
               </div>
            </div>
         </div>
      </div>
      <div id="aiInsightsModal" class="modal">
         <div class="modal-content" style="max-width: 1000px;">
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-brain mr-2 text-purple-600"></i>AI Insights</h2>
               <button onclick="closeAIInsights()" class="text-gray-400 hover:text-gray-600">
                  <i class="fas fa-times text-2xl"></i>
               </button>
            </div>
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
               <p class="text-sm text-blue-800"><i class="fas fa-info-circle mr-2"></i>Smart analysis of your spending patterns with actionable recommendations.</p>
            </div>
            <div id="aiInsightsContent">
               <div class="text-center py-8 text-gray-400">
                  <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                  <p>Analyzing your spending data...</p>
               </div>
            </div>
         </div>
      </div>
      <div id="advancedAnalyticsModal" class="modal">
         <div class="modal-content" style="max-width: 1200px;">
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-chart-pie mr-2 text-purple-600"></i>Advanced Analytics</h2>
               <button onclick="closeAdvancedAnalytics()" class="text-gray-400 hover:text-gray-600">
                  <i class="fas fa-times text-2xl"></i>
               </button>
            </div>
            <div id="advancedAnalyticsContent">
               <div class="text-center py-8 text-gray-400">
                  <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                  <p>Loading analytics...</p>
               </div>
            </div>
         </div>
      </div>
      <div id="smartSearchModal" class="modal">
         <div class="modal-content" style="max-width: 1000px;">
            <div class="flex justify-between items-center mb-6">
               <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-search mr-2 text-purple-600"></i>Smart Search & Filters</h2>
               <button onclick="closeSmartSearch()" class="text-gray-400 hover:text-gray-600">
                  <i class="fas fa-times text-2xl"></i>
               </button>
            </div>
            
            <!-- Natural Language Search -->
            <div class="mb-6">
               <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-magic mr-2 text-purple-500"></i>Natural Language Search
               </label>
               <div class="flex gap-2">
                  <input type="text" id="naturalSearchInput" class="input-field flex-1" 
                         placeholder='Try: "grocery over $100 last month" or "dining in October"'>
                  <button onclick="performNaturalSearch()" class="btn-primary">
                     <i class="fas fa-search mr-2"></i>Search
                  </button>
               </div>
               <p class="text-xs text-gray-500 mt-2">
                  <i class="fas fa-lightbulb mr-1"></i>
                  Examples: "mortgage in 2025", "expenses over $500", "gas last 3 months"
               </p>
            </div>
            
            <!-- Quick Filters -->
            <div class="mb-6">
               <label class="block text-sm font-semibold text-gray-700 mb-3">
                  <i class="fas fa-bolt mr-2 text-yellow-500"></i>Quick Filters
               </label>
               <div class="flex flex-wrap gap-2">
                  <button onclick="applyQuickFilter('dining')" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-sm font-semibold">
                     <i class="fas fa-utensils mr-1"></i>Dining
                  </button>
                  <button onclick="applyQuickFilter('shopping')" class="px-4 py-2 bg-pink-100 text-pink-700 rounded-lg hover:bg-pink-200 text-sm font-semibold">
                     <i class="fas fa-shopping-bag mr-1"></i>Shopping
                  </button>
                  <button onclick="applyQuickFilter('misc')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm font-semibold">
                     <i class="fas fa-ellipsis-h mr-1"></i>Misc
                  </button>
                  <button onclick="applyQuickFilter('over100')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-sm font-semibold">
                     Over $100
                  </button>
                  <button onclick="applyQuickFilter('over500')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-sm font-semibold">
                     Over $500
                  </button>
                  <button onclick="applyQuickFilter('llcOnly')" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-semibold">
                     LLC Expenses
                  </button>
               </div>
            </div>
            
            <!-- Advanced Filters -->
            <div class="card p-6 mb-6">
               <h3 class="text-lg font-bold mb-4">Advanced Filters</h3>
               <div class="grid grid-cols-1 gap-4">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Amount Range</label>
                        <div class="flex gap-2">
                           <input type="number" id="minAmount" class="input-field" placeholder="Min" step="0.01">
                           <input type="number" id="maxAmount" class="input-field" placeholder="Max" step="0.01">
                        </div>
                     </div>
                     <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                        <select id="searchCategory" class="input-field">
                           <option value="">All Categories</option>
                        </select>
                     </div>
                  </div>
                  <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Date Range</label>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <input type="date" id="startDate" class="input-field" placeholder="Start Date">
                        <input type="date" id="endDate" class="input-field" placeholder="End Date">
                     </div>
                  </div>
               </div>
               <div class="flex gap-3 mt-4">
                  <button onclick="applyAdvancedFilters()" class="btn-primary">
                     <i class="fas fa-filter mr-2"></i>Apply Filters
                  </button>
                  <button onclick="clearAllFilters()" class="btn-secondary">
                     <i class="fas fa-times mr-2"></i>Clear All
                  </button>
               </div>
            </div>
            
            <!-- Search Results -->
            <div id="searchResults">
               <div class="text-center py-8 text-gray-400">
                  <i class="fas fa-search text-4xl mb-3"></i>
                  <p>Enter search criteria above to find expenses</p>
               </div>
            </div>
         </div>
      </div>
      <script>
         // Airtable Configuration - Multiple storage methods for reliability
         const TABLE_NAME = 'Budget';
         const PAYMENTS_TABLE = 'Payments';
         const PROFILES_TABLE = 'Profiles';
         const FIXED_EXPENSES_TABLE = 'FixedExpenses';
         const LLC_EXPENSES_TABLE = 'LLCEligibleExpenses';
         
         // Try to get credentials from URL parameters first (works in private mode!)
         const urlParams = new URLSearchParams(window.location.search);
         let AIRTABLE_API_KEY = urlParams.get('key') || localStorage.getItem('airtable_api_key');
         let BASE_ID = urlParams.get('base') || localStorage.getItem('airtable_base_id');
         
         // First-time setup: Ask user for credentials
         if (!AIRTABLE_API_KEY || !BASE_ID) {
             AIRTABLE_API_KEY = prompt('Enter your Airtable API Key:\n(Find it at: airtable.com/account)');
             BASE_ID = prompt('Enter your Airtable Base ID:\n(Found in your Airtable URL)');
             
             if (AIRTABLE_API_KEY && BASE_ID) {
                 // Save to localStorage (for normal browsing)
                 try {
                     localStorage.setItem('airtable_api_key', AIRTABLE_API_KEY);
                     localStorage.setItem('airtable_base_id', BASE_ID);
                 } catch(e) {
                     console.log('localStorage not available (private mode?)');
                 }
                 
                 // Generate personalized URL for private mode
                 const personalURL = window.location.origin + window.location.pathname + 
                                   '?key=' + encodeURIComponent(AIRTABLE_API_KEY) + 
                                   '&base=' + encodeURIComponent(BASE_ID);
                 
                 const usePersonalURL = confirm('âœ… Credentials saved!\n\nðŸ”’ PRIVATE MODE USERS:\nBookmark this special URL to avoid re-entering credentials:\n\n' + personalURL + '\n\nClick OK to copy this URL to clipboard.');
                 
                 if (usePersonalURL) {
                     // Copy to clipboard
                     navigator.clipboard.writeText(personalURL).then(() => {
                         alert('ðŸ“‹ Personal URL copied!\n\nBookmark it or add to Home Screen.\nIt contains your credentials (keep it private!)');
                     }).catch(() => {
                         alert('ðŸ“‹ Your Personal URL:\n\n' + personalURL + '\n\nBookmark this URL!');
                     });
                 }
             } else {
                 alert('âŒ Credentials required to use the app!');
             }
         }
         
         let allExpenses = [];
         let allPayments = [];
         let currentReceiptData = null; // Store current receipt for editing
         let charts = { pie: null, llc: null, line: null, categoryMonthly: null, contributionsMonthly: null, contributionCoverage: null, yearComparison: null, categoryTrend: null, contributionTrend: null };
         
         // Utility function for fetch with timeout and retry
         async function fetchWithRetry(url, options = {}, retries = 3, timeout = 10000) {
             for (let i = 0; i < retries; i++) {
                 try {
                     const controller = new AbortController();
                     const timeoutId = setTimeout(() => controller.abort(), timeout);
                     
                     const response = await fetch(url, {
                         ...options,
                         signal: controller.signal
                     });
                     
                     clearTimeout(timeoutId);
                     return response;
                 } catch (error) {
                     if (i === retries - 1) throw error;
                     console.log(`Retry ${i + 1}/${retries} for ${url}`);
                     await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1))); // Exponential backoff
                 }
             }
         }
         
         // Show loading spinner on button
         function setButtonLoading(button, loading) {
             if (loading) {
                 button.classList.add('btn-loading');
                 button.disabled = true;
             } else {
                 button.classList.remove('btn-loading');
                 button.disabled = false;
             }
         }
         
         document.addEventListener('DOMContentLoaded', function() {
             populateYearDropdown();
             loadData();
             loadProfilePictures();
             loadFixedExpenses();
             loadLLCExpenses();
             
             // Pull-to-refresh functionality
             let touchStartY = 0;
             let touchEndY = 0;
             let isPulling = false;
             let pullDistance = 0;
             
             const pullToRefreshIndicator = document.createElement('div');
             pullToRefreshIndicator.id = 'pullToRefreshIndicator';
             pullToRefreshIndicator.style.cssText = `
                 position: fixed;
                 top: -80px;
                 left: 0;
                 right: 0;
                 height: 80px;
                 background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                 display: flex;
                 align-items: center;
                 justify-content: center;
                 z-index: 9998;
                 transition: transform 0.3s ease;
                 color: white;
                 font-weight: 600;
                 font-size: 14px;
             `;
             pullToRefreshIndicator.innerHTML = '<div style="text-align: center;"><div class="loading" style="width: 24px; height: 24px; border-width: 3px; margin: 0 auto 8px;"></div><div>Pull to refresh</div></div>';
             document.body.appendChild(pullToRefreshIndicator);
             
             document.addEventListener('touchstart', function(e) {
                 if (window.scrollY === 0) {
                     touchStartY = e.touches[0].clientY;
                     isPulling = true;
                 }
             }, { passive: true });
             
             document.addEventListener('touchmove', function(e) {
                 if (!isPulling) return;
                 
                 touchEndY = e.touches[0].clientY;
                 pullDistance = touchEndY - touchStartY;
                 
                 if (pullDistance > 0 && window.scrollY === 0) {
                     // Show indicator
                     const translateY = Math.min(pullDistance * 0.5, 80);
                     pullToRefreshIndicator.style.transform = `translateY(${translateY}px)`;
                     
                     if (pullDistance > 100) {
                         pullToRefreshIndicator.innerHTML = '<div style="text-align: center;"><i class="fas fa-arrow-down" style="font-size: 24px; margin-bottom: 8px;"></i><div>Release to refresh</div></div>';
                     } else {
                         pullToRefreshIndicator.innerHTML = '<div style="text-align: center;"><div class="loading" style="width: 24px; height: 24px; border-width: 3px; margin: 0 auto 8px;"></div><div>Pull to refresh</div></div>';
                     }
                 }
             }, { passive: true });
             
             document.addEventListener('touchend', async function(e) {
                 if (!isPulling) return;
                 
                 if (pullDistance > 100 && window.scrollY === 0) {
                     // Trigger refresh
                     pullToRefreshIndicator.innerHTML = '<div style="text-align: center;"><div class="loading" style="width: 24px; height: 24px; border-width: 3px; margin: 0 auto 8px;"></div><div>Refreshing...</div></div>';
                     pullToRefreshIndicator.style.transform = 'translateY(80px)';
                     
                     try {
                         await loadData();
                         await loadProfilePictures();
                         await loadFixedExpenses();
                         await loadLLCExpenses();
                         showNotification('Data refreshed successfully!', 'success');
                     } catch (error) {
                         showNotification('Failed to refresh data', 'error');
                     }
                     
                     // Hide indicator
                     setTimeout(() => {
                         pullToRefreshIndicator.style.transform = 'translateY(0)';
                         pullToRefreshIndicator.innerHTML = '<div style="text-align: center;"><div class="loading" style="width: 24px; height: 24px; border-width: 3px; margin: 0 auto 8px;"></div><div>Pull to refresh</div></div>';
                     }, 500);
                 } else {
                     // Reset
                     pullToRefreshIndicator.style.transform = 'translateY(0)';
                 }
                 
                 isPulling = false;
                 touchStartY = 0;
                 touchEndY = 0;
                 pullDistance = 0;
             }, { passive: true });
         });
         
         async function loadProfilePictures() {
             try {
                 const response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${PROFILES_TABLE}`, {
                     headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
                 });
                 
                 if (!response.ok) {
                     console.log('Profiles table not found - will be created on first upload');
                     return;
                 }
                 
                 const data = await response.json();
                 
                 // Find Amar's profile
                 const amarProfile = data.records.find(r => r.fields.Person === 'Amar');
                 if (amarProfile && amarProfile.fields.Picture && amarProfile.fields.Picture.length > 0) {
                     document.getElementById('amarPicture').src = amarProfile.fields.Picture[0].url;
                     document.getElementById('amarPicture').style.display = 'block';
                     document.getElementById('amarPictureIcon').style.display = 'none';
                 }
                 
                 // Find Priya's profile
                 const priyaProfile = data.records.find(r => r.fields.Person === 'Priya');
                 if (priyaProfile && priyaProfile.fields.Picture && priyaProfile.fields.Picture.length > 0) {
                     document.getElementById('priyaPicture').src = priyaProfile.fields.Picture[0].url;
                     document.getElementById('priyaPicture').style.display = 'block';
                     document.getElementById('priyaPictureIcon').style.display = 'none';
                 }
             } catch (error) {
                 console.log('Could not load profile pictures:', error);
             }
         }
         
         async function uploadProfilePicture(person, input) {
             const file = input.files[0];
             if (!file) return;
             
             // Check file size (max 5MB for Airtable)
             if (file.size > 5 * 1024 * 1024) {
                 alert('Image size should be less than 5MB');
                 return;
             }
             
             // Check file type
             if (!file.type.startsWith('image/')) {
                 alert('Please select an image file');
                 return;
             }
             
             showNotification('Uploading picture...', 'info');
             
             try {
                 // First, check if profile exists
                 const listResponse = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${PROFILES_TABLE}`, {
                     headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
                 });
                 
                 let profileId = null;
                 if (listResponse.ok) {
                     const data = await listResponse.json();
                     const existingProfile = data.records.find(r => r.fields.Person === person);
                     if (existingProfile) {
                         profileId = existingProfile.id;
                     }
                 }
                 
                 // Create or update profile record first
                 const profileUrl = profileId 
                     ? `https://api.airtable.com/v0/${BASE_ID}/${PROFILES_TABLE}/${profileId}`
                     : `https://api.airtable.com/v0/${BASE_ID}/${PROFILES_TABLE}`;
                 
                 const profileResponse = await fetch(profileUrl, {
                     method: profileId ? 'PATCH' : 'POST',
                     headers: { 
                         'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify({
                         fields: { Person: person }
                     })
                 });
                 
                 if (!profileResponse.ok) throw new Error('Failed to create/update profile');
                 const profileData = await profileResponse.json();
                 const recordId = profileData.id;
                 
                 // Upload image as attachment
                 const reader = new FileReader();
                 reader.onloadend = async function() {
                     try {
                         const base64 = reader.result.split(',')[1];
                         
                         const uploadUrl = `https://content.airtable.com/v0/${BASE_ID}/${recordId}/Picture/uploadAttachment`;
                         const uploadResponse = await fetch(uploadUrl, {
                             method: 'POST',
                             headers: { 
                                 'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                                 'Content-Type': 'application/json'
                             },
                             body: JSON.stringify({
                                 contentType: file.type,
                                 file: base64,
                                 filename: `${person.toLowerCase()}_profile.${file.name.split('.').pop()}`
                             })
                         });
                         
                         if (!uploadResponse.ok) throw new Error('Failed to upload picture');
                         
                         // Reload pictures to show the new one
                         await loadProfilePictures();
                         showNotification(`${person}'s picture updated!`, 'success');
                     } catch (error) {
                         console.error('Upload error:', error);
                         showNotification('Error uploading picture: ' + error.message, 'error');
                     }
                 };
                 
                 reader.readAsDataURL(file);
                 
             } catch (error) {
                 console.error('Profile picture upload error:', error);
                 showNotification('Error: ' + error.message, 'error');
             }
         }
         
         function populateYearDropdown() {
             const yearSelect = document.getElementById('year');
             const currentYear = new Date().getFullYear();
             for (let year = 2025; year <= 2045; year++) {
                 const option = document.createElement('option');
                 option.value = year;
                 option.textContent = year;
                 if (year === currentYear) option.selected = true;
                 yearSelect.appendChild(option);
             }
         }
         
         async function loadData() {
             try {
                 // Show loading in expenses list
                 const expensesList = document.getElementById('expensesList');
                 if (expensesList) {
                     expensesList.innerHTML = '<div class="text-center py-12 text-gray-400"><div class="spinner mx-auto mb-4"></div><p>Loading expenses...</p></div>';
                 }
                 
                 // Load expenses with retry
                 const expensesResponse = await fetchWithRetry(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`, {
                     headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
                 });
                 if (!expensesResponse.ok) throw new Error('Failed to fetch expenses');
                 const expensesData = await expensesResponse.json();
                 allExpenses = expensesData.records;
                 
                 // Load payments with retry
                 try {
                     const paymentsResponse = await fetchWithRetry(`https://api.airtable.com/v0/${BASE_ID}/${PAYMENTS_TABLE}`, {
                         headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
                     });
                     if (paymentsResponse.ok) {
                         const paymentsData = await paymentsResponse.json();
                         allPayments = paymentsData.records;
                     }
                 } catch (e) {
                     console.log('Payments table not found - will be created on first payment');
                     allPayments = [];
                 }
                 
                 populateFilters();
                 populateCategorySelector();
                 populateCategoryDatalist();
                 populateItemDatalist();
                 populateTagsDatalist();
                 updateTagFilterDropdown();
                 renderExpenses();
                 renderPayments();
                 updateStats();
                 updateCharts();
                 updateMismatchNotification();
                 
                 // Hide global loading overlay
                 const overlay = document.getElementById('globalLoadingOverlay');
                 if (overlay) {
                     overlay.style.display = 'none';
                 }
                 
                 showNotification('Data loaded successfully!', 'success');
             } catch (error) {
                 console.error('Error:', error);
                 
                 // Hide global loading overlay even on error
                 const overlay = document.getElementById('globalLoadingOverlay');
                 if (overlay) {
                     overlay.style.display = 'none';
                 }
                 
                 const expensesList = document.getElementById('expensesList');
                 if (expensesList) {
                     expensesList.innerHTML = '<div class="text-center py-12 text-red-400"><i class="fas fa-exclamation-triangle text-4xl mb-3"></i><p>Failed to load data. Please refresh.</p></div>';
                 }
                 showNotification('Error: ' + error.message, 'error');
             }
         }
         
         function populateFilters() {
             const yearSelector = document.getElementById('yearSelector');
             const monthSelector = document.getElementById('monthSelector');
             yearSelector.innerHTML = '<option value="all">All Years</option>';
             monthSelector.innerHTML = '<option value="all">All Months</option>';
             const years = [...new Set(allExpenses.map(exp => exp.fields.Year).filter(Boolean))].sort().reverse();
             const months = [...new Set(allExpenses.map(exp => exp.fields.Month).filter(Boolean))].sort();
             years.forEach(year => {
                 const option = document.createElement('option');
                 option.value = year;
                 option.textContent = year;
                 yearSelector.appendChild(option);
             });
             const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
             months.forEach(month => {
                 const option = document.createElement('option');
                 option.value = month;
                 const monthNum = parseInt(month);
                 option.textContent = monthNames[monthNum - 1] || month;
                 monthSelector.appendChild(option);
             });
             const currentYear = new Date().getFullYear();
             const currentMonth = String(new Date().getMonth() + 1).padStart(2, '0');
             if (years.includes(currentYear)) yearSelector.value = currentYear;
             if (months.includes(currentMonth)) monthSelector.value = currentMonth;
         }
         
         function filterByPeriod() {
             renderExpenses();
             renderPayments();
             updateStats();
             updateCharts();
             updateInsights();
         }
         
         function getFilteredExpenses() {
             const selectedYear = document.getElementById('yearSelector').value;
             const selectedMonth = document.getElementById('monthSelector').value;
             let filtered = allExpenses;
             if (selectedYear !== 'all') filtered = filtered.filter(exp => String(exp.fields.Year) === selectedYear);
             if (selectedMonth !== 'all') filtered = filtered.filter(exp => exp.fields.Month === selectedMonth);
             return filtered;
         }
         
         function toggleAdvancedFilters() {
             const filters = document.getElementById('advancedFilters');
             filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
         }
         
         function filterExpenses() {
             const searchTerm = document.getElementById('expenseSearch').value.toLowerCase();
             const minAmount = parseFloat(document.getElementById('minAmount').value) || 0;
             const maxAmount = parseFloat(document.getElementById('maxAmount').value) || Infinity;
             const startDay = parseInt(document.getElementById('startDay').value) || 1;
             const endDay = parseInt(document.getElementById('endDay').value) || 31;
             const tagFilter = document.getElementById('tagFilter').value;
             
             const filtered = getFilteredExpenses().filter(expense => {
                 // Search filter
                 const searchMatch = !searchTerm || 
                     (expense.fields.Item || '').toLowerCase().includes(searchTerm) ||
                     (expense.fields.Category || '').toLowerCase().includes(searchTerm) ||
                     (expense.fields.Notes || '').toLowerCase().includes(searchTerm) ||
                     (expense.fields.Tags || '').toLowerCase().includes(searchTerm);
                 
                 // Amount filter
                 const amount = expense.fields.Actual || 0;
                 const amountMatch = amount >= minAmount && amount <= maxAmount;
                 
                 // Day filter (within the already filtered month/year)
                 const expenseDay = expense.fields.Day || 1;
                 const dayMatch = expenseDay >= startDay && expenseDay <= endDay;
                 
                 // Tag filter
                 const tagMatch = !tagFilter || (expense.fields.Tags || '').includes(tagFilter);
                 
                 return searchMatch && amountMatch && dayMatch && tagMatch;
             });
             
             renderFilteredExpenses(filtered);
         }
         
         function clearExpenseFilters() {
             document.getElementById('expenseSearch').value = '';
             document.getElementById('minAmount').value = '';
             document.getElementById('maxAmount').value = '';
             document.getElementById('startDay').value = '';
             document.getElementById('endDay').value = '';
             document.getElementById('tagFilter').value = '';
             renderExpenses();
         }
         
         function renderFilteredExpenses(expenses) {
             const container = document.getElementById('expensesList');
             if (expenses.length === 0) {
                 container.innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-inbox text-4xl mb-3"></i><p>No expenses match your filters</p></div>';
                 return;
             }
             
             // Sort by date (newest first) - same as renderExpenses
             const sortedExpenses = [...expenses].sort((a, b) => {
                 const dateA = `${a.fields.Year}-${String(a.fields.Month).padStart(2, '0')}-${String(a.fields.Day || 1).padStart(2, '0')}`;
                 const dateB = `${b.fields.Year}-${String(b.fields.Month).padStart(2, '0')}-${String(b.fields.Day || 1).padStart(2, '0')}`;
                 return dateB.localeCompare(dateA);
             });
             
             const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
             
             container.innerHTML = sortedExpenses.map(expense => {
                 const fields = expense.fields;
                 const budget = fields.Budget || 0;
                 const actual = fields.Actual || 0;
                 const variance = budget - actual;
                 const varianceClass = variance >= 0 ? 'text-green-600' : 'text-red-600';
                 const varianceIcon = variance >= 0 ? 'fa-arrow-down' : 'fa-arrow-up';
                 const monthDisplay = fields.Month ? monthNames[parseInt(fields.Month) - 1] : 'N/A';
                 const day = fields.Day || 1;
                 const dateDisplay = `${monthDisplay} ${day}, ${fields.Year || 'N/A'}`;
                 const hasNotes = fields.Notes && fields.Notes.trim();
                 const notesEscaped = hasNotes ? fields.Notes.replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';
                 
                 return `
                    <div class="expense-row">
                        <div class="expense-item"><span class="expense-label">Item:</span><span class="font-semibold text-gray-800">${fields.Item || 'Unnamed'}${hasNotes ? ` <i class="fas fa-info-circle text-blue-500 cursor-pointer" title="${notesEscaped}"></i>` : ''}</span></div>
                        <div class="expense-item"><span class="expense-label">Category:</span><span class="inline-block px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-semibold">${fields.Category || 'N/A'}</span></div>
                        <div class="expense-item"><span class="expense-label">Date:</span><span class="text-gray-600">${dateDisplay}</span></div>
                        <div class="expense-item"><span class="expense-label">Budget:</span><span class="font-semibold text-gray-700">$${budget.toFixed(2)}</span></div>
                        <div class="expense-item"><span class="expense-label">Actual:</span><span class="font-semibold ${actual > budget ? 'text-red-600' : 'text-gray-700'}">$${actual.toFixed(2)}</span></div>
                        <div class="expense-item"><span class="expense-label">Variance:</span><span class="${varianceClass} font-semibold"><i class="fas ${varianceIcon} mr-1"></i>$${Math.abs(variance).toFixed(2)}</span></div>
                        <div class="expense-item"><span class="expense-label">LLC:</span><span class="badge ${fields.LLC === 'Yes' ? 'badge-llc' : 'badge-personal'}">${fields.LLC || 'No'}</span></div>
                        <div class="expense-item"><span class="expense-label">Receipt:</span>${fields.Receipt && fields.Receipt.length > 0 ? `<a href="${fields.Receipt[0].url}" target="_blank" class="text-purple-600 hover:text-purple-800" title="View Receipt"><i class="fas fa-receipt text-xl"></i></a>` : '<span class="text-gray-300"><i class="fas fa-receipt text-xl"></i></span>'}</div>
                        <div class="expense-item"><span class="expense-label">Actions:</span><div class="flex gap-3">
                            <button onclick="editExpense('${expense.id}')" class="text-blue-500 hover:text-blue-700 text-lg" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteExpense('${expense.id}')" class="text-red-500 hover:text-red-700 text-lg" title="Delete"><i class="fas fa-trash"></i></button>
                        </div></div>
                    </div>
                 `;
             }).join('');
             
             // Update tag filter dropdown
             updateTagFilterDropdown();
         }
         
         function updateTagFilterDropdown() {
             const tagFilter = document.getElementById('tagFilter');
             const allTags = new Set();
             
             allExpenses.forEach(expense => {
                 if (expense.fields.Tags) {
                     expense.fields.Tags.split(',').forEach(tag => {
                         const trimmed = tag.trim();
                         if (trimmed) allTags.add(trimmed);
                     });
                 }
             });
             
             const currentValue = tagFilter.value;
             tagFilter.innerHTML = '<option value="">All Tags</option>' + 
                 Array.from(allTags).sort().map(tag => `<option value="${tag}">${tag}</option>`).join('');
             tagFilter.value = currentValue;
         }
         
         function renderExpenses() {
             const container = document.getElementById('expensesList');
             const filteredExpenses = getFilteredExpenses();
             if (filteredExpenses.length === 0) {
                 container.innerHTML = `<div class="text-center py-12 text-gray-400"><i class="fas fa-inbox text-6xl mb-4"></i><p class="text-lg">No expenses found</p><button onclick="openAddExpenseModal()" class="btn-primary mt-4"><i class="fas fa-plus mr-2"></i>Add Your First Expense</button></div>`;
                 return;
             }
             
             // Sort by date (newest first)
             const sortedExpenses = [...filteredExpenses].sort((a, b) => {
                 const dateA = `${a.fields.Year}-${String(a.fields.Month).padStart(2, '0')}-${String(a.fields.Day || 1).padStart(2, '0')}`;
                 const dateB = `${b.fields.Year}-${String(b.fields.Month).padStart(2, '0')}-${String(b.fields.Day || 1).padStart(2, '0')}`;
                 return dateB.localeCompare(dateA);
             });
             
             const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
             container.innerHTML = sortedExpenses.map(expense => {
                 const fields = expense.fields;
                 const budget = fields.Budget || 0;
                 const actual = fields.Actual || 0;
                 const variance = budget - actual;
                 const varianceClass = variance >= 0 ? 'text-green-600' : 'text-red-600';
                 const varianceIcon = variance >= 0 ? 'fa-arrow-down' : 'fa-arrow-up';
                 const monthDisplay = fields.Month ? monthNames[parseInt(fields.Month) - 1] : 'N/A';
                 const day = fields.Day || 1;
                 const dateDisplay = `${monthDisplay} ${day}, ${fields.Year || 'N/A'}`;
                 const hasNotes = fields.Notes && fields.Notes.trim();
                 const notesEscaped = hasNotes ? fields.Notes.replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';
                
                 return `
                    <div class="expense-row">
                        <div class="expense-item"><span class="expense-label">Item:</span><span class="font-semibold text-gray-800">${fields.Item || 'Unnamed'}${hasNotes ? ` <i class="fas fa-info-circle text-blue-500 cursor-pointer" title="${notesEscaped}"></i>` : ''}</span></div>
                        <div class="expense-item"><span class="expense-label">Category:</span><span class="inline-block px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-semibold">${fields.Category || 'N/A'}</span></div>
                        <div class="expense-item"><span class="expense-label">Date:</span><span class="text-gray-600">${dateDisplay}</span></div>
                        <div class="expense-item"><span class="expense-label">Budget:</span><span class="font-semibold text-gray-700">$${budget.toFixed(2)}</span></div>
                        <div class="expense-item"><span class="expense-label">Actual:</span><span class="font-semibold ${actual > budget ? 'text-red-600' : 'text-gray-700'}">$${actual.toFixed(2)}</span></div>
                        <div class="expense-item"><span class="expense-label">Variance:</span><span class="${varianceClass} font-semibold"><i class="fas ${varianceIcon} mr-1"></i>$${Math.abs(variance).toFixed(2)}</span></div>
                        <div class="expense-item"><span class="expense-label">LLC:</span><span class="badge ${fields.LLC === 'Yes' ? 'badge-llc' : 'badge-personal'}">${fields.LLC || 'No'}</span></div>
                        <div class="expense-item"><span class="expense-label">Receipt:</span>${fields.Receipt && fields.Receipt.length > 0 ? `<a href="${fields.Receipt[0].url}" target="_blank" class="text-purple-600 hover:text-purple-800" title="View Receipt"><i class="fas fa-receipt text-xl"></i></a>` : '<span class="text-gray-300"><i class="fas fa-receipt text-xl"></i></span>'}</div>
                        <div class="expense-item"><span class="expense-label">Actions:</span><div class="flex gap-3">
                            <button onclick="editExpense('${expense.id}')" class="text-blue-500 hover:text-blue-700 text-lg" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteExpense('${expense.id}')" class="text-red-500 hover:text-red-700 text-lg" title="Delete"><i class="fas fa-trash"></i></button>
                        </div></div>
                    </div>
                `;
             }).join('');
         }
         
         function renderPayments() {
             const container = document.getElementById('paymentsList');
             
             // Apply year/month filter
             const selectedYear = document.getElementById('yearSelector').value;
             const selectedMonth = document.getElementById('monthSelector').value;
             let filteredPayments = allPayments;
             if (selectedYear !== 'all') {
                 filteredPayments = filteredPayments.filter(p => String(p.fields.Year) === selectedYear);
             }
             if (selectedMonth !== 'all') {
                 filteredPayments = filteredPayments.filter(p => p.fields.Month === selectedMonth);
             }
             
             if (filteredPayments.length === 0) {
                 container.innerHTML = `<div class="text-center py-12 text-gray-400"><i class="fas fa-inbox text-6xl mb-4"></i><p class="text-lg">No payments found</p><button onclick="openContributionModal('Amar')" class="btn-primary mt-4"><i class="fas fa-plus mr-2"></i>Add First Payment</button></div>`;
                 return;
             }
             const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
             const sortedPayments = [...filteredPayments].sort((a, b) => {
                 const dateA = `${a.fields.Year}-${a.fields.Month}`;
                 const dateB = `${b.fields.Year}-${b.fields.Month}`;
                 return dateB.localeCompare(dateA);
             });
             
             container.innerHTML = sortedPayments.map(payment => {
                 const fields = payment.fields;
                 const monthDisplay = fields.Month ? monthNames[parseInt(fields.Month) - 1] : 'N/A';
                 const personColor = fields.Person === 'Amar' ? 'text-blue-600' : 'text-pink-600';
                 const personBg = fields.Person === 'Amar' ? 'bg-blue-100' : 'bg-pink-100';
                 return `
                    <div class="payment-row">
                        <div class="expense-item"><span class="expense-label">Date:</span><span class="text-gray-600">${monthDisplay} ${fields.Year || 'N/A'}</span></div>
                        <div class="expense-item"><span class="expense-label">Person:</span><span class="inline-block px-3 py-1 ${personBg} ${personColor} rounded-full text-sm font-semibold">${fields.Person || 'N/A'}</span></div>
                        <div class="expense-item"><span class="expense-label">Amount:</span><span class="font-bold text-green-600 text-lg">$${(fields.Amount || 0).toFixed(2)}</span></div>
                        <div class="expense-item"><span class="expense-label">Description:</span><span class="text-gray-700">${fields.Description || 'Payment'}</span></div>
                        <div class="expense-item"><span class="expense-label">Actions:</span><div class="flex gap-3">
                            <button onclick="editPayment('${payment.id}')" class="text-blue-500 hover:text-blue-700 text-lg" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="deletePayment('${payment.id}')" class="text-red-500 hover:text-red-700 text-lg" title="Delete"><i class="fas fa-trash"></i></button>
                        </div></div>
                    </div>
                `;
             }).join('');
         }
         
         function updateStats() {
             const expenses = getFilteredExpenses();
             const totalBudget = expenses.reduce((sum, exp) => sum + (exp.fields.Budget || 0), 0);
             const totalActual = expenses.reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             const llcTotal = expenses.filter(exp => exp.fields.LLC === 'Yes').reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             const remaining = totalBudget - totalActual;
             const amarShare = totalActual / 2;
             const priyaShare = totalActual / 2;
             
             // Calculate contributions (from expenses + standalone payments)
             // Filter payments by same year/month as expenses
             const yearFilterEl = document.getElementById('yearSelector');
             const monthFilterEl = document.getElementById('monthSelector');
             const selectedYear = yearFilterEl ? yearFilterEl.value : 'all';
             const selectedMonth = monthFilterEl ? monthFilterEl.value : 'all';
             
             let filteredPayments = allPayments;
             if (selectedYear !== 'all') {
                 filteredPayments = filteredPayments.filter(p => String(p.fields.Year) === selectedYear);
             }
             if (selectedMonth !== 'all') {
                 filteredPayments = filteredPayments.filter(p => p.fields.Month === selectedMonth);
             }
             
             const amarContribFromExpenses = expenses.reduce((sum, exp) => sum + (exp.fields.AmarContribution || 0), 0);
             const priyaContribFromExpenses = expenses.reduce((sum, exp) => sum + (exp.fields.PriyaContribution || 0), 0);
             // Only count standalone payments (not from expenses, to avoid double counting)
             const amarContribFromPayments = filteredPayments.filter(p => p.fields.Person === 'Amar' && !p.fields.FromExpense).reduce((sum, p) => sum + (p.fields.Amount || 0), 0);
             const priyaContribFromPayments = filteredPayments.filter(p => p.fields.Person === 'Priya' && !p.fields.FromExpense).reduce((sum, p) => sum + (p.fields.Amount || 0), 0);
             const amarContribTotal = amarContribFromExpenses + amarContribFromPayments;
             const priyaContribTotal = priyaContribFromExpenses + priyaContribFromPayments;
             
             // Debug logging
             console.log('Filter:', selectedYear, selectedMonth);
             console.log('Amar - From Expenses:', amarContribFromExpenses, 'From Payments:', amarContribFromPayments, 'Total:', amarContribTotal);
             console.log('Priya - From Expenses:', priyaContribFromExpenses, 'From Payments:', priyaContribFromPayments, 'Total:', priyaContribTotal);
             console.log('Filtered Payments Count:', filteredPayments.length);
             const amarRemaining = amarShare - amarContribTotal;
             const priyaRemaining = priyaShare - priyaContribTotal;
             const amarContribPercent = amarShare > 0 ? (amarContribTotal / amarShare) * 100 : 0;
             const priyaContribPercent = priyaShare > 0 ? (priyaContribTotal / priyaShare) * 100 : 0;
             
             document.getElementById('totalBudget').textContent = `$${totalBudget.toFixed(2)}`;
             document.getElementById('totalActual').textContent = `$${totalActual.toFixed(2)}`;
             document.getElementById('llcTotal').textContent = `$${llcTotal.toFixed(2)}`;
             document.getElementById('remaining').textContent = `$${remaining.toFixed(2)}`;
             
             // Update predicted total
             updatePredictedTotal();
             
             // Update Amar's stats
             document.getElementById('amarShare').textContent = `$${amarShare.toFixed(2)}`;
             document.getElementById('amarContribution').textContent = `$${amarContribTotal.toFixed(2)}`;
             document.getElementById('amarContributionPercent').textContent = amarContribPercent.toFixed(0);
             document.getElementById('amarRemaining').textContent = `$${amarRemaining.toFixed(2)}`;
             document.getElementById('amarContributionProgress').style.width = `${Math.min(amarContribPercent, 100)}%`;
             document.getElementById('amarRemainingProgress').style.width = `${Math.min(100 - amarContribPercent, 100)}%`;
             
             // Update Priya's stats
             document.getElementById('priyaShare').textContent = `$${priyaShare.toFixed(2)}`;
             document.getElementById('priyaContribution').textContent = `$${priyaContribTotal.toFixed(2)}`;
             document.getElementById('priyaContributionPercent').textContent = priyaContribPercent.toFixed(0);
             document.getElementById('priyaRemaining').textContent = `$${priyaRemaining.toFixed(2)}`;
             document.getElementById('priyaContributionProgress').style.width = `${Math.min(priyaContribPercent, 100)}%`;
             document.getElementById('priyaRemainingProgress').style.width = `${Math.min(100 - priyaContribPercent, 100)}%`;
         }
         
         function updateCharts() {
             updatePieChart();
             updateLLCChart();
             updateLineChart();
             updateCategoryMonthlyChart();
             updateContributionsMonthlyChart();
             updateContributionCoverageChart();
             updateYearComparisonChart();
         }
         
         function updatePieChart() {
             const ctx = document.getElementById('pieChart');
             if (!ctx) return;
             const expenses = getFilteredExpenses();
             const expensesByItem = {};
             expenses.forEach(exp => {
                 const item = exp.fields.Item || 'Other';
                 const actual = exp.fields.Actual || 0;
                 expensesByItem[item] = (expensesByItem[item] || 0) + actual;
             });
             if (charts.pie) charts.pie.destroy();
             charts.pie = new Chart(ctx, {
                 type: 'doughnut',
                 data: {
                     labels: Object.keys(expensesByItem),
                     datasets: [{ data: Object.values(expensesByItem), backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7', '#fa709a', '#fee140'] }]
                 },
                 options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, padding: 10, font: { size: 11 } } } } }
             });
         }
         
         function updateLLCChart() {
             const ctx = document.getElementById('llcChart');
             if (!ctx) return;
             const expenses = getFilteredExpenses();
             const llcExpenses = expenses.filter(exp => exp.fields.LLC === 'Yes').reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             const personalExpenses = expenses.filter(exp => exp.fields.LLC !== 'Yes').reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             if (charts.llc) charts.llc.destroy();
             charts.llc = new Chart(ctx, {
                 type: 'doughnut',
                 data: { labels: ['LLC Account', 'Personal'], datasets: [{ data: [llcExpenses, personalExpenses], backgroundColor: ['#4facfe', '#f5576c'] }] },
                 options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
             });
         }
         
         function updateCategoryMonthlyChart() {
             const ctx = document.getElementById('categoryMonthlyChart');
             if (!ctx) return;
             const expenses = allExpenses;
             
             // Group by month and category
             const monthlyData = {};
             expenses.forEach(exp => {
                 const monthKey = `${exp.fields.Year}-${String(exp.fields.Month).padStart(2, '0')}`;
                 const category = exp.fields.Category || 'Other';
                 if (!monthlyData[monthKey]) monthlyData[monthKey] = {};
                 if (!monthlyData[monthKey][category]) monthlyData[monthKey][category] = 0;
                 monthlyData[monthKey][category] += exp.fields.Actual || 0;
             });
             
             // Get last 6 months
             const sortedMonths = Object.keys(monthlyData).sort().slice(-6);
             const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
             const labels = sortedMonths.map(m => {
                 const [year, month] = m.split('-');
                 return `${monthNames[parseInt(month) - 1]} ${year}`;
             });
             
             // Get all categories and sort by total spending (highest first)
             const categoryTotals = {};
             expenses.forEach(e => {
                 const category = e.fields.Category || 'Other';
                 categoryTotals[category] = (categoryTotals[category] || 0) + (e.fields.Actual || 0);
             });
             const categories = Object.keys(categoryTotals).sort((a, b) => categoryTotals[b] - categoryTotals[a]);
             const colors = ['#667eea', '#f5576c', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
             
             const datasets = categories.map((category, index) => ({
                 label: category,
                 data: sortedMonths.map(m => monthlyData[m][category] || 0),
                 backgroundColor: colors[index % colors.length]
             }));
             
             if (charts.categoryMonthly) charts.categoryMonthly.destroy();
             charts.categoryMonthly = new Chart(ctx, {
                 type: 'bar',
                 data: { labels, datasets },
                 options: { 
                     responsive: true, 
                     maintainAspectRatio: false, 
                     scales: { 
                         x: { stacked: false },
                         y: { beginAtZero: true, stacked: false }
                     }
                 }
             });
         }
         
         function updateContributionsMonthlyChart() {
             const ctx = document.getElementById('contributionsMonthlyChart');
             if (!ctx) return;
             
             // Group contributions by month (from expenses + standalone payments)
             const monthlyData = {};
             allExpenses.forEach(exp => {
                 const monthKey = `${exp.fields.Year}-${String(exp.fields.Month).padStart(2, '0')}`;
                 if (!monthlyData[monthKey]) {
                     monthlyData[monthKey] = { amar: 0, priya: 0 };
                 }
                 monthlyData[monthKey].amar += (exp.fields.AmarContribution || 0);
                 monthlyData[monthKey].priya += (exp.fields.PriyaContribution || 0);
             });
             
             // Add standalone payments (exclude FromExpense to avoid double counting)
             allPayments.forEach(payment => {
                 if (!payment.fields.FromExpense) {
                     const monthKey = `${payment.fields.Year}-${String(payment.fields.Month).padStart(2, '0')}`;
                     if (!monthlyData[monthKey]) {
                         monthlyData[monthKey] = { amar: 0, priya: 0 };
                     }
                     if (payment.fields.Person === 'Amar') {
                         monthlyData[monthKey].amar += (payment.fields.Amount || 0);
                     } else if (payment.fields.Person === 'Priya') {
                         monthlyData[monthKey].priya += (payment.fields.Amount || 0);
                     }
                 }
             });
             
             // Get last 6 months
             const sortedMonths = Object.keys(monthlyData).sort().slice(-6);
             const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
             const labels = sortedMonths.map(m => {
                 const [year, month] = m.split('-');
                 return `${monthNames[parseInt(month) - 1]} ${year}`;
             });
             
             const amarData = sortedMonths.map(m => monthlyData[m].amar);
             const priyaData = sortedMonths.map(m => monthlyData[m].priya);
             
             if (charts.contributionsMonthly) charts.contributionsMonthly.destroy();
             charts.contributionsMonthly = new Chart(ctx, {
                 type: 'bar',
                 data: {
                     labels,
                     datasets: [
                         {
                             label: 'Amar',
                             data: amarData,
                             backgroundColor: '#4facfe'
                         },
                         {
                             label: 'Priya',
                             data: priyaData,
                             backgroundColor: '#f093fb'
                         }
                     ]
                 },
                 options: { 
                     responsive: true, 
                     maintainAspectRatio: false, 
                     scales: { 
                         y: { beginAtZero: true }
                     }
                 }
             });
         }
         
         function updateContributionCoverageChart() {
             const ctx = document.getElementById('contributionCoverageChart');
             if (!ctx) return;
             
             // Group by year
             const yearlyData = {};
             
             // Calculate total spending and individual contributions per year
             allExpenses.forEach(exp => {
                 const year = exp.fields.Year;
                 if (!yearlyData[year]) {
                     yearlyData[year] = { spending: 0, amar: 0, priya: 0 };
                 }
                 yearlyData[year].spending += (exp.fields.Actual || 0);
                 yearlyData[year].amar += (exp.fields.AmarContribution || 0);
                 yearlyData[year].priya += (exp.fields.PriyaContribution || 0);
             });
             
             // Add standalone payments (exclude FromExpense to avoid double counting)
             allPayments.forEach(payment => {
                 if (!payment.fields.FromExpense) {
                     const year = payment.fields.Year;
                     if (!yearlyData[year]) {
                         yearlyData[year] = { spending: 0, amar: 0, priya: 0 };
                     }
                     if (payment.fields.Person === 'Amar') {
                         yearlyData[year].amar += (payment.fields.Amount || 0);
                     } else if (payment.fields.Person === 'Priya') {
                         yearlyData[year].priya += (payment.fields.Amount || 0);
                     }
                 }
             });
             
             // Calculate percentages for each person
             const years = Object.keys(yearlyData).sort();
             const amarPercentages = years.map(year => {
                 const spending = yearlyData[year].spending;
                 return spending > 0 ? (yearlyData[year].amar / spending) * 100 : 0;
             });
             const priyaPercentages = years.map(year => {
                 const spending = yearlyData[year].spending;
                 return spending > 0 ? (yearlyData[year].priya / spending) * 100 : 0;
             });
             
             if (charts.contributionCoverage) charts.contributionCoverage.destroy();
             charts.contributionCoverage = new Chart(ctx, {
                 type: 'bar',
                 data: {
                     labels: years,
                     datasets: [
                         {
                             label: 'Amar',
                             data: amarPercentages,
                             backgroundColor: '#4facfe',
                             borderColor: '#2196f3',
                             borderWidth: 2
                         },
                         {
                             label: 'Priya',
                             data: priyaPercentages,
                             backgroundColor: '#f093fb',
                             borderColor: '#e91e63',
                             borderWidth: 2
                         }
                     ]
                 },
                 options: { 
                     responsive: true, 
                     maintainAspectRatio: false,
                     plugins: {
                         datalabels: {
                             anchor: 'end',
                             align: 'top',
                             formatter: function(value, context) {
                                 const year = context.chart.data.labels[context.dataIndex];
                                 const person = context.dataset.label;
                                 const amount = person === 'Amar' ? yearlyData[year].amar : yearlyData[year].priya;
                                 return value.toFixed(1) + '%\n$' + amount.toFixed(0);
                             },
                             font: {
                                 weight: 'bold',
                                 size: 11
                             },
                             color: '#374151'
                         },
                         tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     const year = context.label;
                                     const person = context.dataset.label;
                                     const percentage = context.parsed.y.toFixed(1);
                                     const amount = person === 'Amar' ? yearlyData[year].amar : yearlyData[year].priya;
                                     const spending = yearlyData[year].spending;
                                     return [
                                         `${person}: ${percentage}%`,
                                         `Amount: $${amount.toFixed(2)}`,
                                         `Total Spending: $${spending.toFixed(2)}`
                                     ];
                                 }
                             }
                         }
                     },
                     scales: { 
                         y: { 
                             beginAtZero: true,
                             max: 100,
                             ticks: {
                                 callback: function(value) {
                                     return value + '%';
                                 }
                             }
                         }
                     }
                 },
                 plugins: [ChartDataLabels]
             });
         }
         
         function updateLineChart() {
             const ctx = document.getElementById('lineChart');
             if (!ctx) return;
             const monthlyData = {};
             allExpenses.forEach(exp => {
                 const key = `${exp.fields.Year}-${String(exp.fields.Month).padStart(2, '0')}`;
                 monthlyData[key] = (monthlyData[key] || 0) + (exp.fields.Actual || 0);
             });
             const sortedMonths = Object.keys(monthlyData).sort();
             const monthlyTotals = sortedMonths.map(m => monthlyData[m]);
             if (charts.line) charts.line.destroy();
             charts.line = new Chart(ctx, {
                 type: 'line',
                 data: {
                     labels: sortedMonths,
                     datasets: [{ label: 'Monthly Spending', data: monthlyTotals, borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', tension: 0.4, fill: true }]
                 },
                 options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
             });
             if (monthlyTotals.length > 0) {
                 const avg = monthlyTotals.reduce((a, b) => a + b, 0) / monthlyTotals.length;
                 document.getElementById('avgMonthly').textContent = `$${avg.toFixed(2)}`;
                 document.getElementById('highestMonth').textContent = `$${Math.max(...monthlyTotals).toFixed(2)}`;
                 document.getElementById('lowestMonth').textContent = `$${Math.min(...monthlyTotals).toFixed(2)}`;
                 document.getElementById('yearlyTotal').textContent = `$${monthlyTotals.reduce((a, b) => a + b, 0).toFixed(2)}`;
             }
         }
         
         function updateYearComparisonChart() {
             const ctx = document.getElementById('yearComparisonChart');
             if (!ctx) return;
             const yearlyData = {};
             allExpenses.forEach(exp => {
                 const year = exp.fields.Year;
                 const month = exp.fields.Month;
                 if (!year || !month) return;
                 if (!yearlyData[year]) yearlyData[year] = {};
                 if (!yearlyData[year][month]) yearlyData[year][month] = 0;
                 yearlyData[year][month] += exp.fields.Actual || 0;
             });
             const years = Object.keys(yearlyData).sort();
             const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
             const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
             const colors = ['#667eea', '#f5576c', '#4facfe', '#43e97b', '#fa709a'];
             const datasets = years.map((year, i) => ({
                 label: year,
                 data: months.map(m => yearlyData[year][m] || 0),
                 borderColor: colors[i % colors.length],
                 tension: 0.4
             }));
             if (charts.yearComparison) charts.yearComparison.destroy();
             charts.yearComparison = new Chart(ctx, {
                 type: 'line',
                 data: { labels: monthNames, datasets: datasets },
                 options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
             });
         }
         
         function updateInsights() {
             updateTrendIndicator();
             updateBudgetAlerts();
             updateTopCategories();
             updateRecommendations();
             updateContributionTrendChart();
         }
         
         function updateTrendIndicator() {
             const container = document.getElementById('trendIndicator');
             if (!container) return;
             const monthlyData = {};
             allExpenses.forEach(exp => {
                 const key = `${exp.fields.Year}-${String(exp.fields.Month).padStart(2, '0')}`;
                 monthlyData[key] = (monthlyData[key] || 0) + (exp.fields.Actual || 0);
             });
             const sortedMonths = Object.keys(monthlyData).sort();
             if (sortedMonths.length < 6) {
                 container.innerHTML = '<p class="text-gray-500">Not enough data</p>';
                 return;
             }
             const recent = sortedMonths.slice(-3).map(m => monthlyData[m]);
             const older = sortedMonths.slice(-6, -3).map(m => monthlyData[m]);
             const avgRecent = recent.reduce((a, b) => a + b, 0) / recent.length;
             const avgOlder = older.reduce((a, b) => a + b, 0) / older.length;
             const change = ((avgRecent - avgOlder) / avgOlder) * 100;
             let icon, color, text, message;
             if (change > 5) {
                 icon = 'fa-arrow-trend-up';
                 color = 'text-red-500';
                 text = 'Spending is Increasing';
                 message = `Your spending increased by ${change.toFixed(1)}%`;
             } else if (change < -5) {
                 icon = 'fa-arrow-trend-down';
                 color = 'text-green-500';
                 text = 'Spending is Decreasing';
                 message = `Great! Spending decreased by ${Math.abs(change).toFixed(1)}%`;
             } else {
                 icon = 'fa-minus';
                 color = 'text-blue-500';
                 text = 'Spending is Stable';
                 message = 'Your spending is stable';
             }
             container.innerHTML = `<i class="fas ${icon} ${color} text-6xl mb-4"></i><h4 class="text-2xl font-bold ${color} mb-2">${text}</h4><p class="text-gray-600">${message}</p>`;
         }
         
         function updateBudgetAlerts() {
             const container = document.getElementById('budgetAlerts');
             if (!container) return;
             const expenses = getFilteredExpenses();
             const categoryData = {};
             expenses.forEach(exp => {
                 const item = exp.fields.Item || 'Other';
                 if (!categoryData[item]) categoryData[item] = { budget: 0, actual: 0 };
                 categoryData[item].budget += exp.fields.Budget || 0;
                 categoryData[item].actual += exp.fields.Actual || 0;
             });
             const alerts = [];
             Object.keys(categoryData).forEach(item => {
                 const { budget, actual } = categoryData[item];
                 const util = budget > 0 ? (actual / budget) * 100 : 0;
                 if (util > 100) alerts.push(`<div class="p-3 bg-red-50 border-l-4 border-red-500 rounded"><i class="fas fa-exclamation-circle text-red-500 mr-2"></i><strong>${item}</strong> is over budget by $${(actual - budget).toFixed(2)}</div>`);
                 else if (util > 90) alerts.push(`<div class="p-3 bg-orange-50 border-l-4 border-orange-500 rounded"><i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i><strong>${item}</strong> is at ${util.toFixed(0)}% of budget</div>`);
             });
             container.innerHTML = alerts.length ? alerts.join('') : '<p class="text-green-600"><i class="fas fa-check-circle mr-2"></i>All within budget!</p>';
         }
         
         function updateTopCategories() {
             const container = document.getElementById('topCategories');
             if (!container) return;
             const expenses = getFilteredExpenses();
             const categoryData = {};
             expenses.forEach(exp => {
                 const item = exp.fields.Item || 'Other';
                 categoryData[item] = (categoryData[item] || 0) + (exp.fields.Actual || 0);
             });
             const sorted = Object.entries(categoryData).sort((a, b) => b[1] - a[1]).slice(0, 5);
             const total = Object.values(categoryData).reduce((a, b) => a + b, 0);
             const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'];
             container.innerHTML = sorted.map(([item, amount], i) => {
                 const pct = total > 0 ? (amount / total) * 100 : 0;
                 return `<div class="flex items-center justify-between p-3 border-b"><div class="flex items-center gap-3"><span class="text-2xl">${medals[i]}</span><div><div class="font-semibold">${item}</div><div class="text-sm text-gray-500">${pct.toFixed(1)}%</div></div></div><div class="text-lg font-bold text-purple-600">$${amount.toFixed(2)}</div></div>`;
             }).join('');
         }
         
         function updateRecommendations() {
             const container = document.getElementById('recommendations');
             if (!container) return;
             const expenses = getFilteredExpenses();
             const totalBudget = expenses.reduce((sum, exp) => sum + (exp.fields.Budget || 0), 0);
             const totalActual = expenses.reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             const llcTotal = expenses.filter(exp => exp.fields.LLC === 'Yes').reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             const recs = [];
             if (totalActual > totalBudget) {
                 recs.push(`<div class="p-4 bg-red-50 border-l-4 border-red-500 rounded"><i class="fas fa-chart-line text-red-500 mr-2"></i><strong>Reduce Spending</strong><p class="text-sm mt-1">Over budget by $${(totalActual - totalBudget).toFixed(2)}</p></div>`);
             } else {
                 recs.push(`<div class="p-4 bg-green-50 border-l-4 border-green-500 rounded"><i class="fas fa-thumbs-up text-green-500 mr-2"></i><strong>Great Job!</strong><p class="text-sm mt-1">Under budget with $${(totalBudget - totalActual).toFixed(2)} remaining</p></div>`);
             }
             const llcPct = totalActual > 0 ? (llcTotal / totalActual) * 100 : 0;
             if (llcPct < 30) {
                 recs.push(`<div class="p-4 bg-blue-50 border-l-4 border-blue-500 rounded"><i class="fas fa-building text-blue-500 mr-2"></i><strong>Maximize LLC</strong><p class="text-sm mt-1">Only ${llcPct.toFixed(0)}% through LLC. Review business expenses.</p></div>`);
             }
             container.innerHTML = recs.join('');
         }
         
         function updateContributionTrendChart() {
             const ctx = document.getElementById('contributionTrendChart');
             if (!ctx) return;
             
             // Group contributions by month (from expenses)
             const monthlyData = {};
             allExpenses.forEach(exp => {
                 const key = `${exp.fields.Year}-${String(exp.fields.Month).padStart(2, '0')}`;
                 if (!monthlyData[key]) {
                     monthlyData[key] = { amar: 0, priya: 0, amarShare: 0, priyaShare: 0 };
                 }
                 monthlyData[key].amar += (exp.fields.AmarContribution || 0);
                 monthlyData[key].priya += (exp.fields.PriyaContribution || 0);
                 monthlyData[key].amarShare += (exp.fields.Actual || 0) / 2;
                 monthlyData[key].priyaShare += (exp.fields.Actual || 0) / 2;
             });
             
             // Add standalone payments
             allPayments.forEach(payment => {
                 const key = `${payment.fields.Year}-${String(payment.fields.Month).padStart(2, '0')}`;
                 if (!monthlyData[key]) {
                     monthlyData[key] = { amar: 0, priya: 0, amarShare: 0, priyaShare: 0 };
                 }
                 if (payment.fields.Person === 'Amar') {
                     monthlyData[key].amar += (payment.fields.Amount || 0);
                 } else if (payment.fields.Person === 'Priya') {
                     monthlyData[key].priya += (payment.fields.Amount || 0);
                 }
             });
             
             const sortedMonths = Object.keys(monthlyData).sort().slice(-12); // Last 12 months
             const labels = sortedMonths.map(m => {
                 const [year, month] = m.split('-');
                 const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                 return `${monthNames[parseInt(month) - 1]} ${year}`;
             });
             
             const amarContribData = sortedMonths.map(m => monthlyData[m].amar);
             const priyaContribData = sortedMonths.map(m => monthlyData[m].priya);
             const amarShareData = sortedMonths.map(m => monthlyData[m].amarShare);
             const priyaShareData = sortedMonths.map(m => monthlyData[m].priyaShare);
             
             if (charts.contributionTrend) charts.contributionTrend.destroy();
             charts.contributionTrend = new Chart(ctx, {
                 type: 'line',
                 data: {
                     labels: labels,
                     datasets: [
                         {
                             label: 'Amar\'s Contribution',
                             data: amarContribData,
                             borderColor: '#4facfe',
                             backgroundColor: 'rgba(79, 172, 254, 0.1)',
                             borderWidth: 3,
                             tension: 0.4,
                             fill: true
                         },
                         {
                             label: 'Priya\'s Contribution',
                             data: priyaContribData,
                             borderColor: '#f093fb',
                             backgroundColor: 'rgba(240, 147, 251, 0.1)',
                             borderWidth: 3,
                             tension: 0.4,
                             fill: true
                         },
                         {
                             label: 'Amar\'s Share (Target)',
                             data: amarShareData,
                             borderColor: '#4facfe',
                             backgroundColor: 'transparent',
                             borderWidth: 2,
                             borderDash: [5, 5],
                             tension: 0.4,
                             fill: false,
                             pointRadius: 0
                         },
                         {
                             label: 'Priya\'s Share (Target)',
                             data: priyaShareData,
                             borderColor: '#f093fb',
                             backgroundColor: 'transparent',
                             borderWidth: 2,
                             borderDash: [5, 5],
                             tension: 0.4,
                             fill: false,
                             pointRadius: 0
                         }
                     ]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         legend: {
                             display: true,
                             position: 'bottom'
                         },
                         tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                                 }
                             }
                         }
                     },
                     scales: {
                         y: {
                             beginAtZero: true,
                             ticks: {
                                 callback: function(value) {
                                     return '$' + value.toFixed(0);
                                 }
                             }
                         }
                     }
                 }
             });
         }
         
         function populateCategorySelector() {
             const selector = document.getElementById('categorySelector');
             if (!selector) return;
             selector.innerHTML = '<option value="">Choose a category...</option>';
             const categories = [...new Set(allExpenses.map(exp => exp.fields.Category).filter(Boolean))].sort();
             categories.forEach(category => {
                 const option = document.createElement('option');
                 option.value = category;
                 option.textContent = category;
                 selector.appendChild(option);
             });
         }
         
         function suggestCategoryFromItem() {
             const itemInput = document.getElementById('itemName');
             const categoryInput = document.getElementById('category');
             const itemName = itemInput.value.trim().toLowerCase();
             
             // Clear auto-filled category and hint if item name is cleared or too short
             if (itemName.length < 3) {
                 if (categoryInput.dataset.autoFilled === 'true') {
                     categoryInput.value = '';
                     categoryInput.dataset.autoFilled = 'false';
                     categoryInput.style.backgroundColor = '';
                     categoryInput.style.borderColor = '';
                     
                     const existingHint = document.getElementById('categoryHint');
                     if (existingHint) existingHint.remove();
                 }
                 return;
             }
             
             // If category was auto-filled but item changed, clear it first
             if (categoryInput.dataset.autoFilled === 'true' && categoryInput.dataset.lastItem !== itemName) {
                 categoryInput.value = '';
                 categoryInput.dataset.autoFilled = 'false';
                 categoryInput.style.backgroundColor = '';
                 categoryInput.style.borderColor = '';
                 
                 const existingHint = document.getElementById('categoryHint');
                 if (existingHint) existingHint.remove();
             }
             
             // Build item-category frequency map from historical data
             const itemCategoryMap = {};
             
             allExpenses.forEach(exp => {
                 if (exp.fields.Item && exp.fields.Category) {
                     const item = exp.fields.Item.trim().toLowerCase();
                     const category = exp.fields.Category.trim();
                     
                     if (!itemCategoryMap[item]) {
                         itemCategoryMap[item] = {};
                     }
                     
                     if (!itemCategoryMap[item][category]) {
                         itemCategoryMap[item][category] = 0;
                     }
                     
                     itemCategoryMap[item][category]++;
                 }
             });
             
             // Check for exact match first
             if (itemCategoryMap[itemName]) {
                 const categories = itemCategoryMap[itemName];
                 const totalCount = Object.values(categories).reduce((sum, count) => sum + count, 0);
                 
                 // Find the most common category
                 let maxCount = 0;
                 let suggestedCategory = null;
                 
                 for (const [category, count] of Object.entries(categories)) {
                     if (count > maxCount) {
                         maxCount = count;
                         suggestedCategory = category;
                     }
                 }
                 
                 // Calculate confidence percentage
                 const confidence = (maxCount / totalCount) * 100;
                 
                 // Only suggest if confidence >= 90%
                 if (confidence >= 90 && suggestedCategory) {
                     // Check if category field is empty or user hasn't manually changed it
                     const currentCategory = categoryInput.value.trim();
                     if (!currentCategory || categoryInput.dataset.autoFilled === 'true') {
                         categoryInput.value = suggestedCategory;
                         categoryInput.dataset.autoFilled = 'true';
                         categoryInput.dataset.lastItem = itemName; // Store the item that triggered this
                         
                         // Show visual feedback
                         categoryInput.style.backgroundColor = '#f0fdf4'; // Light green
                         categoryInput.style.borderColor = '#86efac'; // Green border
                         
                         // Add tooltip/hint
                         const existingHint = document.getElementById('categoryHint');
                         if (existingHint) existingHint.remove();
                         
                         const hint = document.createElement('div');
                         hint.id = 'categoryHint';
                         hint.className = 'text-xs text-green-600 mt-1 flex items-center gap-1';
                         hint.innerHTML = `<i class="fas fa-magic"></i> Auto-suggested based on ${maxCount} previous entries (${Math.round(confidence)}% confidence)`;
                         categoryInput.parentElement.appendChild(hint);
                         
                         // Remove visual feedback after 3 seconds
                         setTimeout(() => {
                             categoryInput.style.backgroundColor = '';
                             categoryInput.style.borderColor = '';
                         }, 3000);
                     }
                 }
             } else {
                 // Try partial match (for similar items)
                 for (const [historicalItem, categories] of Object.entries(itemCategoryMap)) {
                     if (historicalItem.includes(itemName) || itemName.includes(historicalItem)) {
                         const totalCount = Object.values(categories).reduce((sum, count) => sum + count, 0);
                         
                         let maxCount = 0;
                         let suggestedCategory = null;
                         
                         for (const [category, count] of Object.entries(categories)) {
                             if (count > maxCount) {
                                 maxCount = count;
                                 suggestedCategory = category;
                             }
                         }
                         
                         const confidence = (maxCount / totalCount) * 100;
                         
                         if (confidence >= 90 && suggestedCategory) {
                             const currentCategory = categoryInput.value.trim();
                             if (!currentCategory || categoryInput.dataset.autoFilled === 'true') {
                                 categoryInput.value = suggestedCategory;
                                 categoryInput.dataset.autoFilled = 'true';
                                 categoryInput.dataset.lastItem = itemName; // Store the item that triggered this
                                 
                                 categoryInput.style.backgroundColor = '#fef3c7'; // Light yellow (less confident)
                                 categoryInput.style.borderColor = '#fbbf24'; // Yellow border
                                 
                                 const existingHint = document.getElementById('categoryHint');
                                 if (existingHint) existingHint.remove();
                                 
                                 const hint = document.createElement('div');
                                 hint.id = 'categoryHint';
                                 hint.className = 'text-xs text-yellow-700 mt-1 flex items-center gap-1';
                                 hint.innerHTML = `<i class="fas fa-lightbulb"></i> Suggested based on similar item "${historicalItem}" (${Math.round(confidence)}% confidence)`;
                                 categoryInput.parentElement.appendChild(hint);
                                 
                                 setTimeout(() => {
                                     categoryInput.style.backgroundColor = '';
                                     categoryInput.style.borderColor = '';
                                 }, 3000);
                                 
                                 break; // Only suggest once
                             }
                         }
                     }
                 }
             }
         }
         
         // Clear auto-fill flag when user manually edits category
         document.addEventListener('DOMContentLoaded', function() {
             const categoryInput = document.getElementById('category');
             if (categoryInput) {
                 categoryInput.addEventListener('input', function() {
                     if (this.dataset.autoFilled === 'true') {
                         this.dataset.autoFilled = 'false';
                     }
                 });
             }
         });
         
         function populateCategoryDatalist() {
             const datalist = document.getElementById('categoryList');
             if (!datalist) return;
             
             // Clear existing options completely
             while (datalist.firstChild) {
                 datalist.removeChild(datalist.firstChild);
             }
             
             // Get unique categories (case-sensitive)
             const categoryMap = new Map();
             allExpenses.forEach(exp => {
                 if (exp.fields.Category) {
                     const cat = exp.fields.Category.trim();
                     if (cat && !categoryMap.has(cat)) {
                         categoryMap.set(cat, true);
                     }
                 }
             });
             
             // Sort and add to datalist
             [...categoryMap.keys()].sort().forEach(category => {
                 const option = document.createElement('option');
                 option.value = category;
                 datalist.appendChild(option);
             });
         }
         
         function populateItemDatalist() {
             const datalist = document.getElementById('itemList');
             if (!datalist) return;
             
             // Clear existing options completely
             while (datalist.firstChild) {
                 datalist.removeChild(datalist.firstChild);
             }
             
             // Get unique items (case-sensitive)
             const itemMap = new Map();
             allExpenses.forEach(exp => {
                 if (exp.fields.Item) {
                     const item = exp.fields.Item.trim();
                     if (item && !itemMap.has(item)) {
                         itemMap.set(item, true);
                     }
                 }
             });
             
             // Sort and add to datalist
             [...itemMap.keys()].sort().forEach(item => {
                 const option = document.createElement('option');
                 option.value = item;
                 datalist.appendChild(option);
             });
         }
         
         function populateTagsDatalist() {
             const datalist = document.getElementById('tagsList');
             if (!datalist) return;
             
             // Clear existing options completely
             while (datalist.firstChild) {
                 datalist.removeChild(datalist.firstChild);
             }
             
             // Collect all unique tags from all expenses
             const tagMap = new Map();
             allExpenses.forEach(exp => {
                 if (exp.fields.Tags) {
                     exp.fields.Tags.split(',').forEach(tag => {
                         const trimmed = tag.trim();
                         if (trimmed && !tagMap.has(trimmed)) {
                             tagMap.set(trimmed, true);
                         }
                     });
                 }
             });
             
             // Sort and add to datalist
             [...tagMap.keys()].sort().forEach(tag => {
                 const option = document.createElement('option');
                 option.value = tag;
                 datalist.appendChild(option);
             });
         }
         
         function updateCategoryAnalysis() {
             const selectedCategory = document.getElementById('categorySelector').value;
             if (!selectedCategory) {
                 document.getElementById('categoryStats').style.display = 'none';
                 document.getElementById('categoryChartContainer').style.display = 'none';
                 return;
             }
             const categoryExpenses = allExpenses.filter(exp => exp.fields.Category === selectedCategory);
             const total = categoryExpenses.reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             const count = categoryExpenses.length;
             const monthlyData = {};
             categoryExpenses.forEach(exp => {
                 const key = `${exp.fields.Year}-${String(exp.fields.Month).padStart(2, '0')}`;
                 if (!monthlyData[key]) monthlyData[key] = 0;
                 monthlyData[key] += exp.fields.Actual || 0;
             });
             const avg = Object.keys(monthlyData).length > 0 ? total / Object.keys(monthlyData).length : 0;
             document.getElementById('categoryTotal').textContent = `$${total.toFixed(2)}`;
             document.getElementById('categoryAvg').textContent = `$${avg.toFixed(2)}`;
             document.getElementById('categoryCount').textContent = count;
             document.getElementById('categoryStats').style.display = 'grid';
             document.getElementById('categoryChartContainer').style.display = 'block';
             updateCategoryTrendChart(selectedCategory, monthlyData);
             updateCategoryDetails(categoryExpenses);
         }
         
         function updateCategoryTrendChart(category, monthlyData) {
             const ctx = document.getElementById('categoryTrendChart');
             if (!ctx) return;
             const sortedMonths = Object.keys(monthlyData).sort();
             const monthlyTotals = sortedMonths.map(m => monthlyData[m]);
             if (charts.categoryTrend) charts.categoryTrend.destroy();
             charts.categoryTrend = new Chart(ctx, {
                 type: 'line',
                 data: {
                     labels: sortedMonths,
                     datasets: [{
                         label: `${category} - Monthly Spending`,
                         data: monthlyTotals,
                         borderColor: '#667eea',
                         backgroundColor: 'rgba(102, 126, 234, 0.1)',
                         tension: 0.4,
                         fill: true,
                         pointRadius: 6,
                         pointHoverRadius: 8
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         legend: { display: true },
                         tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     return `Spending: $${context.parsed.y.toFixed(2)}`;
                                 }
                             }
                         }
                     },
                     scales: {
                         y: { beginAtZero: true, ticks: { callback: value => '$' + value.toFixed(0) } }
                     }
                 }
             });
         }
         
         function updateCategoryDetails(expenses) {
             const container = document.getElementById('categoryDetails');
             if (!container) return;
             const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
             const sortedExpenses = expenses.sort((a, b) => {
                 const aKey = `${a.fields.Year}-${String(a.fields.Month).padStart(2, '0')}`;
                 const bKey = `${b.fields.Year}-${String(b.fields.Month).padStart(2, '0')}`;
                 return bKey.localeCompare(aKey);
             });
             container.innerHTML = `
                 <div class="overflow-x-auto">
                     <table class="w-full">
                         <thead class="bg-gray-100">
                             <tr>
                                 <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Year</th>
                                 <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Month</th>
                                 <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Budget</th>
                                 <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Actual</th>
                                 <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Variance</th>
                                 <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">LLC</th>
                             </tr>
                         </thead>
                         <tbody>
                             ${sortedExpenses.map(exp => {
                                 const budget = exp.fields.Budget || 0;
                                 const actual = exp.fields.Actual || 0;
                                 const variance = budget - actual;
                                 const monthDisplay = exp.fields.Month ? monthNames[parseInt(exp.fields.Month) - 1] : 'N/A';
                                 return `
                                     <tr class="border-b hover:bg-gray-50">
                                         <td class="px-4 py-3 text-sm">${exp.fields.Year || 'N/A'}</td>
                                         <td class="px-4 py-3 text-sm">${monthDisplay}</td>
                                         <td class="px-4 py-3 text-sm font-semibold">$${budget.toFixed(2)}</td>
                                         <td class="px-4 py-3 text-sm font-semibold ${actual > budget ? 'text-red-600' : 'text-gray-700'}">$${actual.toFixed(2)}</td>
                                         <td class="px-4 py-3 text-sm font-semibold ${variance >= 0 ? 'text-green-600' : 'text-red-600'}">$${Math.abs(variance).toFixed(2)}</td>
                                         <td class="px-4 py-3 text-sm"><span class="badge ${exp.fields.LLC === 'Yes' ? 'badge-llc' : 'badge-personal'}">${exp.fields.LLC || 'No'}</span></td>
                                     </tr>
                                 `;
                             }).join('')}
                         </tbody>
                     </table>
                 </div>
             `;
         }
         
         function switchTab(tab) {
             document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
             document.querySelectorAll('[id$="Tab"]').forEach(content => content.style.display = 'none');
             event.target.closest('.tab-button').classList.add('active');
             document.getElementById(tab + 'Tab').style.display = 'block';
             if (tab === 'analytics' || tab === 'trends') updateCharts();
             if (tab === 'insights') updateInsights();
         }
         
         function openAddExpenseModal() {
             document.getElementById('modalTitle').textContent = 'Add Expense';
             document.getElementById('expenseForm').reset();
             document.getElementById('recordId').value = '';
             const now = new Date();
             const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
             const currentDay = now.getDate();
             document.getElementById('month').value = currentMonth;
             document.getElementById('day').value = currentDay;
             currentReceiptData = null;
             document.getElementById('receiptFile').value = '';
             document.getElementById('currentReceipt').style.display = 'none';
             document.getElementById('expenseModal').classList.add('active');
         }
         
         function closeModal() {
             document.getElementById('expenseModal').classList.remove('active');
         }
         
         function openContributionModal(person) {
             document.getElementById('contributionModalTitle').textContent = `Add ${person}'s Payment`;
             document.getElementById('contributionForm').reset();
             document.getElementById('contributionPerson').value = person;
             document.getElementById('contributionPersonSelect').value = person;
             document.getElementById('paymentRecordId').value = '';
             
             // Populate year dropdown
             const yearSelect = document.getElementById('contributionYear');
             yearSelect.innerHTML = '';
             const currentYear = new Date().getFullYear();
             for (let year = 2025; year <= 2045; year++) {
                 const option = document.createElement('option');
                 option.value = year;
                 option.textContent = year;
                 if (year === currentYear) option.selected = true;
                 yearSelect.appendChild(option);
             }
             
             // Set current month
             const currentMonth = String(new Date().getMonth() + 1).padStart(2, '0');
             document.getElementById('contributionMonth').value = currentMonth;
             
             document.getElementById('contributionModal').classList.add('active');
         }
         
         function closeContributionModal() {
             document.getElementById('contributionModal').classList.remove('active');
         }
         
         function closeMismatchModal() {
             document.getElementById('mismatchModal').classList.remove('active');
         }
         
         function checkContributionMismatches() {
             const mismatches = [];
             const monthlyData = {};
             
             // Group expenses and contributions by year-month
             allExpenses.forEach(exp => {
                 const key = `${exp.fields.Year}-${String(exp.fields.Month).padStart(2, '0')}`;
                 if (!monthlyData[key]) {
                     monthlyData[key] = { spending: 0, contributions: 0, year: exp.fields.Year, month: exp.fields.Month };
                 }
                 monthlyData[key].spending += (exp.fields.Actual || 0);
                 monthlyData[key].contributions += (exp.fields.AmarContribution || 0) + (exp.fields.PriyaContribution || 0);
             });
             
             // Add standalone payments (exclude FromExpense to avoid double counting)
             allPayments.forEach(payment => {
                 if (!payment.fields.FromExpense) {
                     const key = `${payment.fields.Year}-${String(payment.fields.Month).padStart(2, '0')}`;
                     if (!monthlyData[key]) {
                         monthlyData[key] = { spending: 0, contributions: 0, year: payment.fields.Year, month: payment.fields.Month };
                     }
                     monthlyData[key].contributions += (payment.fields.Amount || 0);
                 }
             });
             
             // Check for mismatches
             const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
             Object.keys(monthlyData).forEach(key => {
                 const data = monthlyData[key];
                 const diff = Math.abs(data.spending - data.contributions);
                 
                 // Allow small rounding differences (< $0.01)
                 if (diff > 0.01) {
                     const monthName = monthNames[parseInt(data.month) - 1];
                     const type = data.contributions > data.spending ? 'over' : 'under';
                     mismatches.push({
                         period: `${monthName} ${data.year}`,
                         spending: data.spending,
                         contributions: data.contributions,
                         difference: diff,
                         type: type
                     });
                 }
             });
             
             return mismatches;
         }
         
         function updateMismatchNotification() {
             const mismatches = checkContributionMismatches();
             const badge = document.getElementById('notificationBadge');
             const btn = document.getElementById('notificationBtn');
             
             if (mismatches.length > 0) {
                 badge.textContent = mismatches.length;
                 badge.style.display = 'flex';
                 btn.classList.add('animate-pulse');
             } else {
                 badge.style.display = 'none';
                 btn.classList.remove('animate-pulse');
             }
         }
         
         function showMismatchNotifications() {
             const mismatches = checkContributionMismatches();
             const container = document.getElementById('mismatchList');
             
             if (mismatches.length === 0) {
                 container.innerHTML = `
                     <div class="text-center py-8 text-gray-400">
                         <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                         <p class="text-lg">No mismatches found!</p>
                         <p class="text-sm mt-2">All contributions match spending for each month.</p>
                     </div>
                 `;
             } else {
                 container.innerHTML = mismatches.map(m => {
                     const icon = m.type === 'over' ? 'fa-arrow-up' : 'fa-arrow-down';
                     const color = 'red';
                     const message = m.type === 'over' 
                         ? `Contributions exceed spending by $${m.difference.toFixed(2)}`
                         : `Contributions fall short by $${m.difference.toFixed(2)}`;
                     
                     return `
                         <div class="p-4 bg-${color}-50 border-l-4 border-${color}-500 rounded">
                             <div class="flex items-start gap-3">
                                 <i class="fas ${icon} text-${color}-500 text-xl mt-1"></i>
                                 <div class="flex-1">
                                     <h3 class="font-bold text-${color}-800 mb-1">${m.period}</h3>
                                     <p class="text-sm text-${color}-700 mb-2">${message}</p>
                                     <div class="grid grid-cols-2 gap-2 text-xs">
                                         <div class="bg-white/50 p-2 rounded">
                                             <span class="text-gray-600">Spending:</span>
                                             <span class="font-bold ml-1">$${m.spending.toFixed(2)}</span>
                                         </div>
                                         <div class="bg-white/50 p-2 rounded">
                                             <span class="text-gray-600">Contributions:</span>
                                             <span class="font-bold ml-1">$${m.contributions.toFixed(2)}</span>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     `;
                 }).join('');
             }
             
             document.getElementById('mismatchModal').classList.add('active');
         }
         
         function updateContributionPerson() {
             const person = document.getElementById('contributionPersonSelect').value;
             document.getElementById('contributionPerson').value = person;
             const recordId = document.getElementById('paymentRecordId').value;
             const action = recordId ? 'Edit' : 'Add';
             document.getElementById('contributionModalTitle').textContent = `${action} ${person}'s Payment`;
         }
         
         async function saveStandaloneContribution(event) {
             event.preventDefault();
             const recordId = document.getElementById('paymentRecordId').value;
             const person = document.getElementById('contributionPerson').value;
             const amount = parseFloat(document.getElementById('contributionAmount').value) || 0;
             const description = document.getElementById('contributionDescription').value || 'Payment';
             const year = parseInt(document.getElementById('contributionYear').value);
             const month = document.getElementById('contributionMonth').value;
             
             // Save to Payments table
             const fields = {
                 Person: person,
                 Amount: amount,
                 Description: description,
                 Year: year,
                 Month: month
             };
             
             try {
                 const url = recordId 
                     ? `https://api.airtable.com/v0/${BASE_ID}/${PAYMENTS_TABLE}/${recordId}`
                     : `https://api.airtable.com/v0/${BASE_ID}/${PAYMENTS_TABLE}`;
                 const response = await fetch(url, {
                     method: recordId ? 'PATCH' : 'POST',
                     headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}`, 'Content-Type': 'application/json' },
                     body: JSON.stringify({ fields })
                 });
                 if (!response.ok) throw new Error('Failed to save payment');
                 closeContributionModal();
                 await loadData();
                 showNotification(recordId ? 'Payment updated!' : `${person}'s payment of $${amount.toFixed(2)} recorded!`, 'success');
             } catch (error) {
                 showNotification('Error: ' + error.message, 'error');
             }
         }
         
         function editPayment(id) {
             const payment = allPayments.find(p => p.id === id);
             if (!payment) return;
             
             document.getElementById('contributionModalTitle').textContent = 'Edit Payment';
             document.getElementById('paymentRecordId').value = id;
             document.getElementById('contributionPerson').value = payment.fields.Person || 'Amar';
             document.getElementById('contributionPersonSelect').value = payment.fields.Person || 'Amar';
             document.getElementById('contributionAmount').value = payment.fields.Amount || '';
             document.getElementById('contributionDescription').value = payment.fields.Description || '';
             
             // Populate year dropdown
             const yearSelect = document.getElementById('contributionYear');
             yearSelect.innerHTML = '';
             const currentYear = new Date().getFullYear();
             for (let year = 2025; year <= 2045; year++) {
                 const option = document.createElement('option');
                 option.value = year;
                 option.textContent = year;
                 if (year === payment.fields.Year) option.selected = true;
                 yearSelect.appendChild(option);
             }
             
             document.getElementById('contributionMonth').value = payment.fields.Month || '';
             document.getElementById('contributionModal').classList.add('active');
         }
         
         async function deletePayment(id) {
             if (!confirm('Delete this payment?')) return;
             try {
                 const response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${PAYMENTS_TABLE}/${id}`, {
                     method: 'DELETE',
                     headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
                 });
                 if (!response.ok) throw new Error('Failed to delete payment');
                 await loadData();
                 showNotification('Payment deleted!', 'success');
             } catch (error) {
                 showNotification('Error: ' + error.message, 'error');
             }
         }
         
         async function editExpense(id) {
             const expense = allExpenses.find(exp => exp.id === id);
             if (!expense) return;
             document.getElementById('modalTitle').textContent = 'Edit Expense';
             document.getElementById('recordId').value = id;
             document.getElementById('itemName').value = expense.fields.Item || '';
             document.getElementById('category').value = expense.fields.Category || '';
             document.getElementById('year').value = expense.fields.Year || '';
             document.getElementById('month').value = expense.fields.Month || '';
             document.getElementById('day').value = expense.fields.Day || 1;
             document.getElementById('budget').value = expense.fields.Budget || '';
             document.getElementById('actual').value = expense.fields.Actual || '';
             document.getElementById('llc').value = expense.fields.LLC || 'No';
            document.getElementById('amarContributionInput').value = expense.fields.AmarContribution || '';
            document.getElementById('priyaContributionInput').value = expense.fields.PriyaContribution || '';
            document.getElementById('tags').value = expense.fields.Tags || '';
            document.getElementById('notes').value = expense.fields.Notes || '';
            
            // Handle receipt
             document.getElementById('receiptFile').value = '';
             if (expense.fields.Receipt && expense.fields.Receipt.length > 0) {
                 currentReceiptData = expense.fields.Receipt[0];
                 document.getElementById('receiptFileName').textContent = currentReceiptData.filename;
                 document.getElementById('receiptViewLink').href = currentReceiptData.url;
                 document.getElementById('currentReceipt').style.display = 'block';
             } else {
                 currentReceiptData = null;
                 document.getElementById('currentReceipt').style.display = 'none';
             }
             
             document.getElementById('expenseModal').classList.add('active');
         }
         
         async function saveExpense(event) {
             event.preventDefault();
             
             // Validate actual amount
             const actualAmount = parseFloat(document.getElementById('actual').value);
             if (!actualAmount || actualAmount <= 0) {
                 showNotification('Please enter a valid actual amount', 'error');
                 document.getElementById('actual').focus();
                 return;
             }
             
             // Get contribution amounts
             let amarContribution = parseFloat(document.getElementById('amarContributionInput').value) || 0;
             let priyaContribution = parseFloat(document.getElementById('priyaContributionInput').value) || 0;
             
             // Check if contributions are missing or don't match actual amount
             const totalContribution = amarContribution + priyaContribution;
             const contributionMismatch = Math.abs(totalContribution - actualAmount) > 0.01;
             
             // If no contributions or mismatch, show smart popup
             if ((amarContribution <= 0 && priyaContribution <= 0) || contributionMismatch) {
                 const contributionChoice = await showContributionHelper(actualAmount, amarContribution, priyaContribution);
                 
                 if (contributionChoice === 'cancel') {
                     return; // User cancelled
                 } else if (contributionChoice === 'amar') {
                     // Amar pays full amount
                     document.getElementById('amarContributionInput').value = actualAmount;
                     document.getElementById('priyaContributionInput').value = 0;
                     amarContribution = actualAmount;
                     priyaContribution = 0;
                 } else if (contributionChoice === 'priya') {
                     // Priya pays full amount
                     document.getElementById('amarContributionInput').value = 0;
                     document.getElementById('priyaContributionInput').value = actualAmount;
                     amarContribution = 0;
                     priyaContribution = actualAmount;
                 } else if (contributionChoice === 'split') {
                     // Split 50/50
                     const half = actualAmount / 2;
                     document.getElementById('amarContributionInput').value = half;
                     document.getElementById('priyaContributionInput').value = half;
                     amarContribution = half;
                     priyaContribution = half;
                 }
                 // If 'edit', user goes back to form
             }
             
             // Check budget amount
             const budgetAmount = parseFloat(document.getElementById('budget').value) || 0;
             
             // If budget is 0 or missing, show confirmation popup
             if (budgetAmount <= 0) {
                 const budgetChoice = await showBudgetConfirmation(actualAmount);
                 if (budgetChoice === 'cancel') {
                     return; // User cancelled
                 } else if (budgetChoice === 'useSame') {
                     // Set budget to actual amount
                     document.getElementById('budget').value = actualAmount;
                 }
                 // If 'continue', proceed with budget = 0
             }
             
             // Get submit button and show loading
             const submitBtn = event.submitter || event.target.querySelector('button[type="submit"]');
             if (submitBtn) setButtonLoading(submitBtn, true);
             
             try {
                 const recordId = document.getElementById('recordId').value;
                 const finalBudget = parseFloat(document.getElementById('budget').value) || 0;
                 
                 const fields = {
                    Item: document.getElementById('itemName').value,
                    Category: document.getElementById('category').value,
                    Year: parseInt(document.getElementById('year').value),
                    Month: document.getElementById('month').value,
                    Day: parseInt(document.getElementById('day').value),
                    Budget: finalBudget,
                    Actual: actualAmount,
                    LLC: document.getElementById('llc').value,
                    AmarContribution: amarContribution,
                    PriyaContribution: priyaContribution,
                    Tags: document.getElementById('tags').value || '',
                    Notes: document.getElementById('notes').value || ''
                };
                 
                 // Check for similar item names (only for new expenses, not edits)
                 if (!recordId && fields.Item) {
                     const similarItems = findSimilarItems(fields.Item);
                     if (similarItems.length > 0) {
                         const confirmed = await showSimilarItemWarning(fields.Item, similarItems);
                         if (!confirmed) {
                             if (submitBtn) setButtonLoading(submitBtn, false);
                             return; // User cancelled
                         }
                     }
                 }
                 
                 // Check for duplicates (only for new expenses, not edits)
                 if (!recordId) {
                     const duplicates = findDuplicateExpenses(fields);
                     if (duplicates.length > 0) {
                         const confirmed = await showDuplicateConfirmation(duplicates, fields);
                         if (!confirmed) {
                             if (submitBtn) setButtonLoading(submitBtn, false);
                             return; // User cancelled
                         }
                     }
                 }
                 
                 // Handle receipt file upload
                 const receiptFile = document.getElementById('receiptFile').files[0];
                 if (receiptFile) {
                     await uploadReceiptAndSave(recordId, fields, receiptFile);
                 } else if (currentReceiptData) {
                     // Keep existing receipt
                     fields.Receipt = [currentReceiptData];
                     await saveExpenseToAirtable(recordId, fields);
                 } else {
                     // No receipt
                     await saveExpenseToAirtable(recordId, fields);
                 }
             } catch (error) {
                 showNotification('Error saving expense: ' + error.message, 'error');
             } finally {
                 if (submitBtn) setButtonLoading(submitBtn, false);
             }
         }
         
         function showContributionHelper(actualAmount, currentAmar, currentPriya) {
             return new Promise((resolve) => {
                 const modal = document.createElement('div');
                 modal.className = 'modal active';
                 modal.style.zIndex = '10003'; // Above other modals
                 
                 const totalContribution = currentAmar + currentPriya;
                 const isMissing = currentAmar <= 0 && currentPriya <= 0;
                 const isMismatch = Math.abs(totalContribution - actualAmount) > 0.01;
                 const isOver = totalContribution > actualAmount;
                 const isUnder = totalContribution < actualAmount && totalContribution > 0;
                 
                 let title = 'Contributions Missing';
                 let message = 'Who paid for this expense?';
                 let alertClass = 'blue';
                 
                 if (isMismatch && !isMissing) {
                     title = 'Contribution Mismatch';
                     if (isOver) {
                         message = `Contributions ($${totalContribution.toFixed(2)}) exceed actual amount ($${actualAmount.toFixed(2)})`;
                         alertClass = 'red';
                     } else {
                         message = `Contributions ($${totalContribution.toFixed(2)}) don't cover full amount ($${actualAmount.toFixed(2)})`;
                         alertClass = 'orange';
                     }
                 }
                 
                 modal.innerHTML = `
                     <div class="modal-content" style="max-width: 550px;">
                         <div class="flex justify-between items-center mb-6">
                             <h2 class="text-2xl font-bold text-${alertClass}-600 flex items-center gap-2">
                                 <i class="fas fa-${isMismatch ? 'exclamation-triangle' : 'question-circle'}"></i>
                                 ${title}
                             </h2>
                         </div>
                         
                         <div class="bg-${alertClass}-50 border-l-4 border-${alertClass}-500 p-4 mb-6">
                             <p class="text-sm text-${alertClass}-800">
                                 <i class="fas fa-info-circle mr-2"></i>
                                 ${message}
                             </p>
                         </div>
                         
                         <div class="mb-6">
                             <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                 <div class="grid grid-cols-2 gap-4 mb-3">
                                     <div>
                                         <div class="text-xs text-gray-600 mb-1">Actual Amount</div>
                                         <div class="text-2xl font-bold text-purple-600">$${actualAmount.toFixed(2)}</div>
                                     </div>
                                     <div>
                                         <div class="text-xs text-gray-600 mb-1">Total Contributions</div>
                                         <div class="text-2xl font-bold ${totalContribution === actualAmount ? 'text-green-600' : 'text-red-600'}">
                                             $${totalContribution.toFixed(2)}
                                         </div>
                                     </div>
                                 </div>
                                 ${!isMissing ? `
                                     <div class="pt-3 border-t border-gray-300">
                                         <div class="flex justify-between text-sm mb-1">
                                             <span class="text-gray-600">Amar:</span>
                                             <span class="font-semibold">$${currentAmar.toFixed(2)}</span>
                                         </div>
                                         <div class="flex justify-between text-sm">
                                             <span class="text-gray-600">Priya:</span>
                                             <span class="font-semibold">$${currentPriya.toFixed(2)}</span>
                                         </div>
                                     </div>
                                 ` : ''}
                             </div>
                         </div>
                         
                         <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                             <p class="text-sm text-blue-800 font-semibold mb-2">
                                 <i class="fas fa-magic mr-2"></i>Quick Options:
                             </p>
                             <p class="text-xs text-blue-700">
                                 Choose who paid, or split 50/50. We'll set the contributions automatically!
                             </p>
                         </div>
                         
                         <div class="space-y-3">
                             <button id="amarPaidBtn" class="w-full btn-primary flex items-center justify-center gap-2">
                                 <i class="fas fa-user"></i>
                                 Amar Paid Full Amount ($${actualAmount.toFixed(2)})
                             </button>
                             <button id="priyaPaidBtn" class="w-full btn-primary flex items-center justify-center gap-2">
                                 <i class="fas fa-user"></i>
                                 Priya Paid Full Amount ($${actualAmount.toFixed(2)})
                             </button>
                             <button id="splitBtn" class="w-full btn-secondary flex items-center justify-center gap-2">
                                 <i class="fas fa-balance-scale"></i>
                                 Split 50/50 ($${(actualAmount / 2).toFixed(2)} each)
                             </button>
                             <button id="editBtn" class="w-full px-4 py-2 text-gray-600 hover:text-gray-800 font-semibold rounded-lg hover:bg-gray-100 transition-colors">
                                 <i class="fas fa-edit mr-2"></i>
                                 Go Back & Edit Manually
                             </button>
                         </div>
                     </div>
                 `;
                 
                 document.body.appendChild(modal);
                 
                 document.getElementById('amarPaidBtn').onclick = () => {
                     document.body.removeChild(modal);
                     resolve('amar');
                 };
                 
                 document.getElementById('priyaPaidBtn').onclick = () => {
                     document.body.removeChild(modal);
                     resolve('priya');
                 };
                 
                 document.getElementById('splitBtn').onclick = () => {
                     document.body.removeChild(modal);
                     resolve('split');
                 };
                 
                 document.getElementById('editBtn').onclick = () => {
                     document.body.removeChild(modal);
                     resolve('cancel');
                 };
             });
         }
         
         function showBudgetConfirmation(actualAmount) {
             return new Promise((resolve) => {
                 const modal = document.createElement('div');
                 modal.className = 'modal active';
                 modal.style.zIndex = '10002'; // Above other modals
                 
                 modal.innerHTML = `
                     <div class="modal-content" style="max-width: 500px;">
                         <div class="flex justify-between items-center mb-6">
                             <h2 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
                                 <i class="fas fa-question-circle"></i>
                                 Budget Amount Missing
                             </h2>
                         </div>
                         
                         <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                             <p class="text-sm text-blue-800">
                                 <i class="fas fa-info-circle mr-2"></i>
                                 You haven't entered a budget amount for this expense.
                             </p>
                         </div>
                         
                         <div class="mb-6">
                             <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                 <div class="text-sm text-gray-600 mb-2">Actual Amount:</div>
                                 <div class="text-3xl font-bold text-purple-600">$${actualAmount.toFixed(2)}</div>
                             </div>
                         </div>
                         
                         <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                             <p class="text-sm text-yellow-800">
                                 <i class="fas fa-lightbulb mr-2"></i>
                                 <strong>Tip:</strong> Setting a budget helps you track spending vs. planned amounts.
                             </p>
                         </div>
                         
                         <div class="space-y-3">
                             <button id="useSameBtn" class="w-full btn-primary flex items-center justify-center gap-2">
                                 <i class="fas fa-copy"></i>
                                 Use $${actualAmount.toFixed(2)} as Budget
                                 <span class="text-xs opacity-75">(Recommended)</span>
                             </button>
                             <button id="continueWithoutBtn" class="w-full btn-secondary flex items-center justify-center gap-2">
                                 <i class="fas fa-forward"></i>
                                 Continue with $0 Budget
                             </button>
                             <button id="cancelBtn" class="w-full px-4 py-2 text-gray-600 hover:text-gray-800 font-semibold rounded-lg hover:bg-gray-100 transition-colors">
                                 <i class="fas fa-arrow-left mr-2"></i>
                                 Go Back & Edit
                             </button>
                         </div>
                     </div>
                 `;
                 
                 document.body.appendChild(modal);
                 
                 document.getElementById('useSameBtn').onclick = () => {
                     document.body.removeChild(modal);
                     resolve('useSame');
                 };
                 
                 document.getElementById('continueWithoutBtn').onclick = () => {
                     document.body.removeChild(modal);
                     resolve('continue');
                 };
                 
                 document.getElementById('cancelBtn').onclick = () => {
                     document.body.removeChild(modal);
                     resolve('cancel');
                 };
             });
         }
         
         function findSimilarItems(newItem) {
             const similarItems = [];
             const newItemLower = newItem.toLowerCase().trim();
             
             // Get all unique existing items
             const existingItems = [...new Set(allExpenses.map(exp => exp.fields.Item).filter(Boolean))];
             
             existingItems.forEach(existingItem => {
                 const existingLower = existingItem.toLowerCase().trim();
                 
                 // Skip if exact match (case-insensitive)
                 if (newItemLower === existingLower) return;
                 
                 let isSimilar = false;
                 let reason = '';
                 
                 // Check if one contains the other
                 if (newItemLower.includes(existingLower)) {
                     isSimilar = true;
                     reason = `"${newItem}" contains "${existingItem}"`;
                 } else if (existingLower.includes(newItemLower)) {
                     isSimilar = true;
                     reason = `"${existingItem}" contains "${newItem}"`;
                 }
                 
                 // Check for word overlap (e.g., "car gas" vs "gas")
                 const newWords = newItemLower.split(/\s+/);
                 const existingWords = existingLower.split(/\s+/);
                 const commonWords = newWords.filter(word => 
                     word.length > 2 && existingWords.includes(word)
                 );
                 
                 if (commonWords.length > 0 && !isSimilar) {
                     isSimilar = true;
                     reason = `Both contain: "${commonWords.join(', ')}"`;
                 }
                 
                 if (isSimilar) {
                     similarItems.push({
                         item: existingItem,
                         reason: reason
                     });
                 }
             });
             
             return similarItems;
         }
         
         function showSimilarItemWarning(newItem, similarItems) {
             return new Promise((resolve) => {
                 const modal = document.createElement('div');
                 modal.className = 'modal active';
                 modal.style.zIndex = '10002'; // Above other modals
                 
                 modal.innerHTML = `
                     <div class="modal-content" style="max-width: 500px;">
                         <div class="flex justify-between items-center mb-6">
                             <h2 class="text-2xl font-bold text-orange-600 flex items-center gap-2">
                                 <i class="fas fa-exclamation-circle"></i>
                                 Similar Item Found
                             </h2>
                         </div>
                         
                         <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6">
                             <p class="text-sm text-yellow-800">
                                 <i class="fas fa-info-circle mr-2"></i>
                                 We found similar item${similarItems.length > 1 ? 's' : ''} that already exist. 
                                 Consider using the existing item${similarItems.length > 1 ? 's' : ''} to keep your data consistent.
                             </p>
                         </div>
                         
                         <div class="mb-6">
                             <h3 class="font-bold text-gray-800 mb-3">You're adding:</h3>
                             <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                                 <div class="font-semibold text-gray-800">"${newItem}"</div>
                             </div>
                         </div>
                         
                         <div class="mb-6">
                             <h3 class="font-bold text-gray-800 mb-3">Similar existing item${similarItems.length > 1 ? 's' : ''}:</h3>
                             <div class="space-y-2">
                                 ${similarItems.map(similar => `
                                     <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                         <div class="font-semibold text-gray-800 mb-1">"${similar.item}"</div>
                                         <div class="text-xs text-blue-700">
                                             <i class="fas fa-link mr-1"></i>${similar.reason}
                                         </div>
                                     </div>
                                 `).join('')}
                             </div>
                         </div>
                         
                         <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                             <p class="text-sm text-gray-700">
                                 <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                                 <strong>Tip:</strong> Using consistent item names helps with better analytics and suggestions.
                             </p>
                         </div>
                         
                         <div class="flex gap-3">
                             <button id="goBackBtn" class="btn-secondary flex-1">
                                 <i class="fas fa-arrow-left mr-2"></i>
                                 Go Back & Edit
                             </button>
                             <button id="continueAnywayBtn" class="btn-primary flex-1">
                                 <i class="fas fa-check mr-2"></i>
                                 Add Anyway
                             </button>
                         </div>
                     </div>
                 `;
                 
                 document.body.appendChild(modal);
                 
                 document.getElementById('continueAnywayBtn').onclick = () => {
                     document.body.removeChild(modal);
                     resolve(true);
                 };
                 
                 document.getElementById('goBackBtn').onclick = () => {
                     document.body.removeChild(modal);
                     resolve(false);
                 };
             });
         }
         
         function findDuplicateExpenses(newExpense) {
             const duplicates = [];
             
             allExpenses.forEach(exp => {
                 let matchScore = 0;
                 let reasons = [];
                 
                 // Check item name (case-insensitive, fuzzy match)
                 const itemMatch = exp.fields.Item && newExpense.Item && 
                     exp.fields.Item.toLowerCase() === newExpense.Item.toLowerCase();
                 if (itemMatch) {
                     matchScore += 3;
                     reasons.push('Same item name');
                 }
                 
                 // Check exact amount
                 const amountMatch = exp.fields.Actual === newExpense.Actual && newExpense.Actual > 0;
                 if (amountMatch) {
                     matchScore += 2;
                     reasons.push('Same amount');
                 }
                 
                 // Check same date
                 const dateMatch = exp.fields.Year === newExpense.Year && 
                     exp.fields.Month === newExpense.Month && 
                     exp.fields.Day === newExpense.Day;
                 if (dateMatch) {
                     matchScore += 2;
                     reasons.push('Same date');
                 }
                 
                 // Check same category
                 const categoryMatch = exp.fields.Category === newExpense.Category;
                 if (categoryMatch) {
                     matchScore += 1;
                     reasons.push('Same category');
                 }
                 
                 // If match score is high enough, consider it a potential duplicate
                 // Score >= 5 means at least: same item + same amount, or same item + same date
                 if (matchScore >= 5) {
                     duplicates.push({
                         expense: exp,
                         matchScore: matchScore,
                         reasons: reasons
                     });
                 }
             });
             
             // Sort by match score (highest first)
             return duplicates.sort((a, b) => b.matchScore - a.matchScore).slice(0, 3); // Top 3
         }
         
         function showDuplicateConfirmation(duplicates, newExpense) {
             return new Promise((resolve) => {
                 const modal = document.createElement('div');
                 modal.className = 'modal active';
                 modal.style.zIndex = '10001'; // Above other modals
                 
                 const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                 
                 modal.innerHTML = `
                     <div class="modal-content" style="max-width: 600px;">
                         <div class="flex justify-between items-center mb-6">
                             <h2 class="text-2xl font-bold text-orange-600 flex items-center gap-2">
                                 <i class="fas fa-exclamation-triangle"></i>
                                 Possible Duplicate Expense
                             </h2>
                         </div>
                         
                         <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6">
                             <p class="text-sm text-yellow-800">
                                 <i class="fas fa-info-circle mr-2"></i>
                                 We found ${duplicates.length} similar expense${duplicates.length > 1 ? 's' : ''} that might be duplicate${duplicates.length > 1 ? 's' : ''}. 
                                 Please review before adding.
                             </p>
                         </div>
                         
                         <div class="mb-6">
                             <h3 class="font-bold text-gray-800 mb-3">New Expense:</h3>
                             <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                 <div class="grid grid-cols-2 gap-2 text-sm">
                                     <div><span class="font-semibold">Item:</span> ${newExpense.Item}</div>
                                     <div><span class="font-semibold">Amount:</span> $${newExpense.Actual.toFixed(2)}</div>
                                     <div><span class="font-semibold">Date:</span> ${monthNames[newExpense.Month]} ${newExpense.Day}, ${newExpense.Year}</div>
                                     <div><span class="font-semibold">Category:</span> ${newExpense.Category || 'None'}</div>
                                 </div>
                             </div>
                         </div>
                         
                         <div class="mb-6">
                             <h3 class="font-bold text-gray-800 mb-3">Similar Existing Expense${duplicates.length > 1 ? 's' : ''}:</h3>
                             <div class="space-y-3">
                                 ${duplicates.map(dup => `
                                     <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                         <div class="grid grid-cols-2 gap-2 text-sm mb-2">
                                             <div><span class="font-semibold">Item:</span> ${dup.expense.fields.Item}</div>
                                             <div><span class="font-semibold">Amount:</span> $${(dup.expense.fields.Actual || 0).toFixed(2)}</div>
                                             <div><span class="font-semibold">Date:</span> ${monthNames[dup.expense.fields.Month]} ${dup.expense.fields.Day || 1}, ${dup.expense.fields.Year}</div>
                                             <div><span class="font-semibold">Category:</span> ${dup.expense.fields.Category || 'None'}</div>
                                         </div>
                                         <div class="text-xs text-red-700 font-semibold">
                                             <i class="fas fa-check-circle mr-1"></i>
                                             Match: ${dup.reasons.join(', ')}
                                         </div>
                                     </div>
                                 `).join('')}
                             </div>
                         </div>
                         
                         <div class="flex gap-3">
                             <button id="confirmAddBtn" class="btn-primary flex-1">
                                 <i class="fas fa-check mr-2"></i>
                                 Add Anyway (Not a Duplicate)
                             </button>
                             <button id="cancelAddBtn" class="btn-secondary flex-1">
                                 <i class="fas fa-times mr-2"></i>
                                 Cancel
                             </button>
                         </div>
                     </div>
                 `;
                 
                 document.body.appendChild(modal);
                 
                 document.getElementById('confirmAddBtn').onclick = () => {
                     document.body.removeChild(modal);
                     resolve(true);
                 };
                 
                 document.getElementById('cancelAddBtn').onclick = () => {
                     document.body.removeChild(modal);
                     resolve(false);
                 };
             });
         }
         
         async function uploadReceiptAndSave(recordId, fields, file) {
             try {
                 showNotification('Uploading receipt...', 'info');
                 
                 // Step 1: Save the expense first (without receipt)
                 const url = recordId ? `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}/${recordId}` : `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`;
                 const response = await fetch(url, {
                     method: recordId ? 'PATCH' : 'POST',
                     headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}`, 'Content-Type': 'application/json' },
                     body: JSON.stringify({ fields })
                 });
                 if (!response.ok) throw new Error('Failed to save expense');
                 const savedRecord = await response.json();
                 const expenseRecordId = savedRecord.id;
                 
                 // Step 2: Convert file to base64 and upload using Airtable's upload attachment endpoint
                 const reader = new FileReader();
                 reader.onloadend = async function() {
                     try {
                         const base64 = reader.result.split(',')[1]; // Remove data:image/png;base64, prefix
                         
                         const uploadUrl = `https://content.airtable.com/v0/${BASE_ID}/${expenseRecordId}/Receipt/uploadAttachment`;
                         const uploadResponse = await fetch(uploadUrl, {
                             method: 'POST',
                             headers: { 
                                 'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                                 'Content-Type': 'application/json'
                             },
                             body: JSON.stringify({
                                 contentType: file.type,
                                 file: base64,
                                 filename: file.name
                             })
                         });
                         
                         if (!uploadResponse.ok) {
                             const errorText = await uploadResponse.text();
                             console.error('Upload error:', errorText);
                             throw new Error('Failed to upload receipt: ' + uploadResponse.status);
                         }
                         
                         closeModal();
                         await loadData();
                         showNotification('Expense and receipt saved successfully!', 'success');
                     } catch (error) {
                         showNotification('Error uploading receipt: ' + error.message, 'error');
                     }
                 };
                 reader.readAsDataURL(file);
             } catch (error) {
                 showNotification('Error: ' + error.message, 'error');
             }
         }
         
         function removeReceipt() {
             currentReceiptData = null;
             document.getElementById('receiptFile').value = '';
             document.getElementById('currentReceipt').style.display = 'none';
         }
         
         async function saveExpenseToAirtable(recordId, fields) {
            try {
                // Filter out empty optional fields (Tags, Notes) to avoid Airtable errors if fields don't exist
                const cleanFields = { ...fields };
                if (!cleanFields.Tags || cleanFields.Tags.trim() === '') {
                    delete cleanFields.Tags;
                }
                if (!cleanFields.Notes || cleanFields.Notes.trim() === '') {
                    delete cleanFields.Notes;
                }
                
                const url = recordId ? `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}/${recordId}` : `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`;
                const response = await fetch(url, {
                    method: recordId ? 'PATCH' : 'POST',
                    headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fields: cleanFields })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Airtable error:', errorData);
                    throw new Error(errorData.error?.message || 'Failed to save');
                }
                 
                 // Create payment entries for visibility (but marked to avoid double counting)
                 await createPaymentEntriesFromContributions(fields, recordId);
                 
                 closeModal();
                 await loadData();
                 showNotification(recordId ? 'Updated!' : 'Added!', 'success');
             } catch (error) {
                 showNotification('Error: ' + error.message, 'error');
             }
         }
         
         async function createPaymentEntriesFromContributions(fields, expenseRecordId) {
             try {
                 const payments = [];
                 
                 // Create Amar's payment if contribution > 0
                 if (fields.AmarContribution && fields.AmarContribution > 0) {
                     payments.push({
                         fields: {
                             Person: 'Amar',
                             Amount: fields.AmarContribution,
                             Year: fields.Year,
                             Month: fields.Month,
                             Description: `${fields.Item} - ${fields.Category}`,
                             FromExpense: true  // Mark to avoid double counting
                         }
                     });
                 }
                 
                 // Create Priya's payment if contribution > 0
                 if (fields.PriyaContribution && fields.PriyaContribution > 0) {
                     payments.push({
                         fields: {
                             Person: 'Priya',
                             Amount: fields.PriyaContribution,
                             Year: fields.Year,
                             Month: fields.Month,
                             Description: `${fields.Item} - ${fields.Category}`,
                             FromExpense: true  // Mark to avoid double counting
                         }
                     });
                 }
                 
                 // Save payments to Airtable
                 if (payments.length > 0) {
                     for (const payment of payments) {
                         await fetch(`https://api.airtable.com/v0/${BASE_ID}/${PAYMENTS_TABLE}`, {
                             method: 'POST',
                             headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}`, 'Content-Type': 'application/json' },
                             body: JSON.stringify(payment)
                         });
                     }
                 }
             } catch (error) {
                 console.error('Error creating payment entries:', error);
                 // Don't throw - expense was saved successfully
             }
         }
         
         async function deleteExpense(id) {
             if (!confirm('Delete this expense?')) return;
             try {
                 const response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}/${id}`, {
                     method: 'DELETE',
                     headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
                 });
                 if (!response.ok) throw new Error('Failed to delete');
                 await loadData();
                 showNotification('Deleted!', 'success');
             } catch (error) {
                 showNotification('Error: ' + error.message, 'error');
             }
         }
         
         function showNotification(message, type) {
             const notification = document.getElementById('notification');
             const notificationText = document.getElementById('notificationText');
             notificationText.textContent = message;
             notification.className = `notification ${type}`;
             notification.style.display = 'block';
             setTimeout(() => notification.style.display = 'none', 3000);
         }
         
         function toggleMenu() {
             const menu = document.getElementById('slideMenu');
             const overlay = document.getElementById('menuOverlay');
             const isOpen = menu.style.transform === 'translateX(0px)';
             
             if (isOpen) {
                 menu.style.transform = 'translateX(100%)';
                 overlay.style.display = 'none';
             } else {
                 menu.style.transform = 'translateX(0px)';
                 overlay.style.display = 'block';
             }
         }
         
         let allFixedExpenses = [];
         
         async function loadFixedExpenses() {
             try {
                 const response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${FIXED_EXPENSES_TABLE}`, {
                     headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
                 });
                 
                 if (!response.ok) {
                     console.log('Fixed expenses table not found');
                     allFixedExpenses = [];
                     return;
                 }
                 
                 const data = await response.json();
                 allFixedExpenses = data.records;
             } catch (error) {
                 console.log('Could not load fixed expenses:', error);
                 allFixedExpenses = [];
             }
         }
         
         function openFixedExpensesModal() {
             renderFixedExpenses();
             document.getElementById('fixedExpensesModal').classList.add('active');
         }
         
         function closeFixedExpensesModal() {
             document.getElementById('fixedExpensesModal').classList.remove('active');
         }
         
         function openAddFixedExpenseForm() {
             document.getElementById('fixedExpenseModalTitle').textContent = 'Add Fixed Expense';
             document.getElementById('fixedExpenseForm').reset();
             document.getElementById('fixedExpenseId').value = '';
             
             // Populate year dropdown
             const yearSelect = document.getElementById('fixedStartYear');
             yearSelect.innerHTML = '';
             const currentYear = new Date().getFullYear();
             for (let year = currentYear; year <= currentYear + 5; year++) {
                 const option = document.createElement('option');
                 option.value = year;
                 option.textContent = year;
                 if (year === currentYear) option.selected = true;
                 yearSelect.appendChild(option);
             }
             
             // Set current month
             const currentMonth = String(new Date().getMonth() + 1).padStart(2, '0');
             document.getElementById('fixedStartMonth').value = currentMonth;
             
             document.getElementById('addFixedExpenseModal').classList.add('active');
         }
         
         function closeAddFixedExpenseForm() {
             document.getElementById('addFixedExpenseModal').classList.remove('active');
         }
         
         function renderFixedExpenses() {
             const container = document.getElementById('fixedExpensesList');
             
             if (allFixedExpenses.length === 0) {
                 container.innerHTML = `
                     <div class="text-center py-8 text-gray-400">
                         <i class="fas fa-inbox text-4xl mb-3"></i>
                         <p>No fixed expenses yet</p>
                     </div>
                 `;
                 return;
             }
             
             const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            container.innerHTML = allFixedExpenses.map(expense => {
                const fields = expense.fields;
                const startMonth = monthNames[parseInt(fields.StartMonth) - 1] || 'N/A';
                const amount = fields.Amount || 0;
                return `
                    <div class="p-4 border border-gray-200 rounded-lg hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-800">${fields.Item || 'Unnamed'}</h4>
                                <p class="text-sm text-gray-600">${fields.Category || 'N/A'}</p>
                                <p class="text-xs text-gray-500 mt-1">Starts: ${startMonth} ${fields.StartYear || 'N/A'}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold text-purple-600">$${amount.toFixed(2)}</p>
                                <span class="text-xs badge ${fields.LLC === 'Yes' ? 'badge-llc' : 'badge-personal'}">${fields.LLC || 'No'}</span>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button onclick="editFixedExpense('${expense.id}')" class="text-blue-500 hover:text-blue-700 text-sm">
                                <i class="fas fa-edit mr-1"></i>Edit
                            </button>
                            <button onclick="deleteFixedExpense('${expense.id}')" class="text-red-500 hover:text-red-700 text-sm">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
         }
         
         async function saveFixedExpense(event) {
             event.preventDefault();
             
             const id = document.getElementById('fixedExpenseId').value;
             const fields = {
                 Item: document.getElementById('fixedItemName').value,
                 Category: document.getElementById('fixedCategory').value,
                 Amount: parseFloat(document.getElementById('fixedAmount').value),
                 LLC: document.getElementById('fixedLLC').value,
                 StartYear: parseInt(document.getElementById('fixedStartYear').value),
                 StartMonth: document.getElementById('fixedStartMonth').value
             };
             
             try {
                 const url = id 
                     ? `https://api.airtable.com/v0/${BASE_ID}/${FIXED_EXPENSES_TABLE}/${id}`
                     : `https://api.airtable.com/v0/${BASE_ID}/${FIXED_EXPENSES_TABLE}`;
                 
                 const response = await fetch(url, {
                     method: id ? 'PATCH' : 'POST',
                     headers: { 
                         'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify({ fields })
                 });
                 
                 if (!response.ok) throw new Error('Failed to save fixed expense');
                 
                 closeAddFixedExpenseForm();
                 await loadFixedExpenses();
                 renderFixedExpenses();
                 showNotification(id ? 'Fixed expense updated!' : 'Fixed expense added!', 'success');
             } catch (error) {
                 showNotification('Error: ' + error.message, 'error');
             }
         }
         
         async function editFixedExpense(id) {
             const expense = allFixedExpenses.find(e => e.id === id);
             if (!expense) return;
             
             document.getElementById('fixedExpenseModalTitle').textContent = 'Edit Fixed Expense';
             document.getElementById('fixedExpenseId').value = id;
             document.getElementById('fixedItemName').value = expense.fields.Item;
             document.getElementById('fixedCategory').value = expense.fields.Category;
             document.getElementById('fixedAmount').value = expense.fields.Amount;
             document.getElementById('fixedLLC').value = expense.fields.LLC || 'No';
             
             // Populate year dropdown
             const yearSelect = document.getElementById('fixedStartYear');
             yearSelect.innerHTML = '';
             const currentYear = new Date().getFullYear();
             for (let year = currentYear; year <= currentYear + 5; year++) {
                 const option = document.createElement('option');
                 option.value = year;
                 option.textContent = year;
                 if (year === expense.fields.StartYear) option.selected = true;
                 yearSelect.appendChild(option);
             }
             
             document.getElementById('fixedStartMonth').value = expense.fields.StartMonth;
             document.getElementById('addFixedExpenseModal').classList.add('active');
         }
         
         async function deleteFixedExpense(id) {
             if (!confirm('Delete this fixed expense? This will not affect existing expenses.')) return;
             
             try {
                 const response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${FIXED_EXPENSES_TABLE}/${id}`, {
                     method: 'DELETE',
                     headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
                 });
                 
                 if (!response.ok) throw new Error('Failed to delete');
                 
                 await loadFixedExpenses();
                 renderFixedExpenses();
                 showNotification('Fixed expense deleted!', 'success');
             } catch (error) {
                 showNotification('Error: ' + error.message, 'error');
             }
         }
         
         let allLLCExpenses = [];
         
         async function loadLLCExpenses() {
             try {
                 const response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${LLC_EXPENSES_TABLE}`, {
                     headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
                 });
                 
                 if (!response.ok) {
                     console.log('LLC expenses table not found');
                     allLLCExpenses = [];
                     return;
                 }
                 
                 const data = await response.json();
                 allLLCExpenses = data.records;
             } catch (error) {
                 console.log('Could not load LLC expenses:', error);
                 allLLCExpenses = [];
             }
         }
         
         function openLLCExpensesModal() {
             renderLLCExpenses();
             document.getElementById('llcExpensesModal').classList.add('active');
         }
         
         function closeLLCExpensesModal() {
             document.getElementById('llcExpensesModal').classList.remove('active');
         }
         
         function openAddLLCExpenseForm() {
             document.getElementById('llcExpenseModalTitle').textContent = 'Add LLC Eligible Expense';
             document.getElementById('llcExpenseForm').reset();
             document.getElementById('llcExpenseId').value = '';
             
             // Populate existing categories from all expenses
             populateExistingCategories();
             
             document.getElementById('addLLCExpenseModal').classList.add('active');
         }
         
         function closeAddLLCExpenseForm() {
             document.getElementById('addLLCExpenseModal').classList.remove('active');
         }
         
         function populateExistingCategories() {
             const datalist = document.getElementById('existingCategories');
             datalist.innerHTML = '';
             
             // Get unique categories from all expenses
             const categories = new Set();
             allExpenses.forEach(exp => {
                 if (exp.fields.Category) {
                     categories.add(exp.fields.Category);
                 }
             });
             
             // Add to datalist
             categories.forEach(category => {
                 const option = document.createElement('option');
                 option.value = category;
                 datalist.appendChild(option);
             });
         }
         
         function renderLLCExpenses() {
             const container = document.getElementById('llcExpensesList');
             
             if (allLLCExpenses.length === 0) {
                 container.innerHTML = `
                     <div class="text-center py-8 text-gray-400">
                         <i class="fas fa-inbox text-4xl mb-3"></i>
                         <p>No LLC eligible expenses defined yet</p>
                     </div>
                 `;
                 return;
             }
             
             container.innerHTML = allLLCExpenses.map(expense => {
                 const fields = expense.fields;
                 return `
                     <div class="p-4 border border-gray-200 rounded-lg hover:shadow-md transition-shadow">
                         <div class="flex justify-between items-start">
                             <div class="flex-1">
                                 <h4 class="font-bold text-gray-800">${fields.Item || 'Unnamed'}</h4>
                                 <p class="text-sm text-gray-600"><i class="fas fa-tag mr-1"></i>${fields.Category || 'N/A'}</p>
                             </div>
                             <div class="flex gap-2">
                                 <button onclick="editLLCExpense('${expense.id}')" class="text-blue-500 hover:text-blue-700 text-sm">
                                     <i class="fas fa-edit"></i>
                                 </button>
                                 <button onclick="deleteLLCExpense('${expense.id}')" class="text-red-500 hover:text-red-700 text-sm">
                                     <i class="fas fa-trash"></i>
                                 </button>
                             </div>
                         </div>
                     </div>
                 `;
             }).join('');
         }
         
         async function saveLLCExpense(event) {
             event.preventDefault();
             
             const id = document.getElementById('llcExpenseId').value;
             const fields = {
                 Item: document.getElementById('llcItemName').value,
                 Category: document.getElementById('llcCategoryName').value
             };
             
             try {
                 const url = id 
                     ? `https://api.airtable.com/v0/${BASE_ID}/${LLC_EXPENSES_TABLE}/${id}`
                     : `https://api.airtable.com/v0/${BASE_ID}/${LLC_EXPENSES_TABLE}`;
                 
                 const response = await fetch(url, {
                     method: id ? 'PATCH' : 'POST',
                     headers: { 
                         'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify({ fields })
                 });
                 
                 if (!response.ok) throw new Error('Failed to save LLC expense');
                 
                 closeAddLLCExpenseForm();
                 await loadLLCExpenses();
                 renderLLCExpenses();
                 showNotification(id ? 'LLC expense updated!' : 'LLC expense added!', 'success');
             } catch (error) {
                 showNotification('Error: ' + error.message, 'error');
             }
         }
         
         async function editLLCExpense(id) {
             const expense = allLLCExpenses.find(e => e.id === id);
             if (!expense) return;
             
             document.getElementById('llcExpenseModalTitle').textContent = 'Edit LLC Eligible Expense';
             document.getElementById('llcExpenseId').value = id;
             document.getElementById('llcItemName').value = expense.fields.Item;
             document.getElementById('llcCategoryName').value = expense.fields.Category;
             
             populateExistingCategories();
             document.getElementById('addLLCExpenseModal').classList.add('active');
         }
         
         async function deleteLLCExpense(id) {
             if (!confirm('Delete this LLC eligible expense?')) return;
             
             try {
                 const response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${LLC_EXPENSES_TABLE}/${id}`, {
                     method: 'DELETE',
                     headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
                 });
                 
                 if (!response.ok) throw new Error('Failed to delete');
                 
                 await loadLLCExpenses();
                 renderLLCExpenses();
                 showNotification('LLC expense deleted!', 'success');
             } catch (error) {
                 showNotification('Error: ' + error.message, 'error');
             }
         }
         
         async function openMonthlySummary() {
             // Populate year dropdown
             const yearSelect = document.getElementById('summaryYear');
             yearSelect.innerHTML = '';
             const currentYear = new Date().getFullYear();
             const currentMonth = String(new Date().getMonth() + 1).padStart(2, '0');
             
             for (let year = 2025; year <= 2045; year++) {
                 const option = document.createElement('option');
                 option.value = year;
                 option.textContent = year;
                 if (year === currentYear) option.selected = true;
                 yearSelect.appendChild(option);
             }
             
             // Set current month
             document.getElementById('summaryMonth').value = currentMonth;
             
             document.getElementById('monthlySummaryModal').classList.add('active');
             
             // Ensure data is loaded
             if (allExpenses.length === 0) {
                 await loadData();
             }
             
             loadMonthlySummary();
         }
         
         function closeMonthlySummary() {
             document.getElementById('monthlySummaryModal').classList.remove('active');
         }
         
         function showCategoryExpenses(category, year, month) {
             // Filter expenses for this category and month
             const categoryExpenses = allExpenses.filter(exp => {
                 const expYear = parseInt(exp.fields.Year);
                 const expMonth = parseInt(exp.fields.Month);
                 const expCategory = exp.fields.Category || 'Other';
                 return expYear === year && expMonth === month && expCategory === category;
             });
             
             // Sort by date (most recent first)
             categoryExpenses.sort((a, b) => {
                 const dateA = new Date(a.fields.Year, a.fields.Month - 1, a.fields.Day || 1);
                 const dateB = new Date(b.fields.Year, b.fields.Month - 1, b.fields.Day || 1);
                 return dateB - dateA;
             });
             
             const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
             const totalAmount = categoryExpenses.reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             
             // Create modal
             const modal = document.createElement('div');
             modal.className = 'modal active';
             modal.style.zIndex = '10001'; // Above monthly summary modal
             
             modal.innerHTML = `
                 <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                     <div class="flex justify-between items-center mb-6">
                         <div>
                             <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                 <i class="fas fa-list text-purple-600"></i>
                                 ${category}
                             </h2>
                             <p class="text-sm text-gray-600 mt-1">${monthNames[month - 1]} ${year} â€¢ ${categoryExpenses.length} ${categoryExpenses.length === 1 ? 'expense' : 'expenses'}</p>
                         </div>
                         <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-gray-600">
                             <i class="fas fa-times text-2xl"></i>
                         </button>
                     </div>
                     
                     <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4 rounded-lg mb-6">
                         <div class="text-sm opacity-90">Total Spending</div>
                         <div class="text-3xl font-bold">$${totalAmount.toFixed(2)}</div>
                         <div class="text-sm opacity-90 mt-1">Average: $${(totalAmount / categoryExpenses.length).toFixed(2)} per expense</div>
                     </div>
                     
                     <div class="space-y-3">
                         ${categoryExpenses.map(exp => {
                             const item = exp.fields.Item || 'Unnamed';
                             const actual = exp.fields.Actual || 0;
                             const day = exp.fields.Day;
                             const llc = exp.fields.LLC === 'Yes';
                             const amarContrib = exp.fields.AmarContribution || 0;
                             const priyaContrib = exp.fields.PriyaContribution || 0;
                             const notes = exp.fields.Notes || '';
                             
                             // Format date properly
                             let dateDisplay = '';
                             if (day !== undefined && day !== null && day !== '') {
                                 dateDisplay = `${monthNames[month - 1]} ${day}, ${year}`;
                             } else {
                                 dateDisplay = `${monthNames[month - 1]} ${year}`;
                             }
                             
                             // Debug log
                             console.log('Expense:', item, 'Day field:', day, 'Type:', typeof day, 'Display:', dateDisplay);
                             
                             return `
                                 <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                                     <div class="flex justify-between items-start mb-2">
                                         <div class="flex-1">
                                             <div class="font-semibold text-gray-800 flex items-center gap-2">
                                                 ${item}
                                                 ${llc ? '<span class="badge badge-llc text-xs">LLC</span>' : ''}
                                             </div>
                                             <div class="text-sm text-gray-600 mt-1">
                                                 <i class="fas fa-calendar mr-1"></i>${dateDisplay}
                                             </div>
                                         </div>
                                         <div class="text-right">
                                             <div class="text-xl font-bold text-purple-600">$${actual.toFixed(2)}</div>
                                         </div>
                                     </div>
                                     
                                     <div class="flex gap-4 text-xs text-gray-600 mt-3 pt-3 border-t border-gray-100">
                                         <div class="flex items-center gap-1">
                                             <i class="fas fa-user text-blue-500"></i>
                                             <span>Amar: $${amarContrib.toFixed(2)}</span>
                                         </div>
                                         <div class="flex items-center gap-1">
                                             <i class="fas fa-user text-pink-500"></i>
                                             <span>Priya: $${priyaContrib.toFixed(2)}</span>
                                         </div>
                                     </div>
                                     
                                     ${notes && notes.trim() !== '' ? `
                                         <div class="mt-2 text-sm text-gray-600 bg-gray-50 p-2 rounded">
                                             <i class="fas fa-sticky-note mr-1"></i>${notes}
                                         </div>
                                     ` : ''}
                                 </div>
                             `;
                         }).join('')}
                     </div>
                     
                     <div class="mt-6 pt-4 border-t border-gray-200">
                         <button onclick="this.closest('.modal').remove()" class="w-full btn-secondary">
                             <i class="fas fa-arrow-left mr-2"></i>Back to Summary
                         </button>
                     </div>
                 </div>
             `;
             
             document.body.appendChild(modal);
         }
         
         async function loadMonthlySummary() {
             const year = parseInt(document.getElementById('summaryYear').value);
             const month = parseInt(document.getElementById('summaryMonth').value);
             const container = document.getElementById('monthlySummaryContent');
             
             container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-4xl text-purple-600"></i><p class="mt-3 text-gray-600">Loading summary...</p></div>';
             
             console.log('Loading summary for:', year, month);
             console.log('Total expenses:', allExpenses.length);
             console.log('Total payments:', allPayments.length);
             
             // Debug: Check format of first expense
             if (allExpenses.length > 0) {
                 console.log('Sample expense Year:', allExpenses[0].fields.Year, 'Type:', typeof allExpenses[0].fields.Year);
                 console.log('Sample expense Month:', allExpenses[0].fields.Month, 'Type:', typeof allExpenses[0].fields.Month);
             }
             
             // Filter expenses for selected month (handle both string and number formats)
             const monthExpenses = allExpenses.filter(exp => {
                 const expYear = parseInt(exp.fields.Year);
                 const expMonth = parseInt(exp.fields.Month);
                 return expYear === year && expMonth === month;
             });
             
             const monthPayments = allPayments.filter(pay => {
                 const payYear = parseInt(pay.fields.Year);
                 const payMonth = parseInt(pay.fields.Month);
                 return payYear === year && payMonth === month && !pay.fields.FromExpense;
             });
             
             console.log('Month expenses:', monthExpenses.length);
             console.log('Month payments:', monthPayments.length);
             
             if (monthExpenses.length === 0) {
                 const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                 container.innerHTML = `
                     <div class="text-center py-8 text-gray-400">
                         <i class="fas fa-inbox text-4xl mb-3"></i>
                         <p class="text-lg font-semibold mb-2">No data for ${monthNames[month - 1]} ${year}</p>
                         <p class="text-sm">Try selecting a different month or add some expenses first.</p>
                     </div>
                 `;
                 return;
             }
             
             // Calculate metrics
             const totalSpending = monthExpenses.reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             const expenseCount = monthExpenses.length;
             const avgExpense = totalSpending / expenseCount;
             
             // Category breakdown
             const categoryTotals = {};
             monthExpenses.forEach(exp => {
                 const cat = exp.fields.Category || 'Other';
                 categoryTotals[cat] = (categoryTotals[cat] || 0) + (exp.fields.Actual || 0);
             });
             
             // Contributions
             const amarContribFromExpenses = monthExpenses.reduce((sum, exp) => sum + (exp.fields.AmarContribution || 0), 0);
             const priyaContribFromExpenses = monthExpenses.reduce((sum, exp) => sum + (exp.fields.PriyaContribution || 0), 0);
             const amarContribFromPayments = monthPayments.filter(p => p.fields.Person === 'Amar').reduce((sum, p) => sum + (p.fields.Amount || 0), 0);
             const priyaContribFromPayments = monthPayments.filter(p => p.fields.Person === 'Priya').reduce((sum, p) => sum + (p.fields.Amount || 0), 0);
             
             const amarTotal = amarContribFromExpenses + amarContribFromPayments;
             const priyaTotal = priyaContribFromExpenses + priyaContribFromPayments;
             const totalContributions = amarTotal + priyaTotal;
             
             const amarPercentage = totalContributions > 0 ? (amarTotal / totalContributions * 100) : 0;
             const priyaPercentage = totalContributions > 0 ? (priyaTotal / totalContributions * 100) : 0;
             
             // LLC expenses
             const llcExpenses = monthExpenses.filter(exp => exp.fields.LLC === 'Yes');
             const llcTotal = llcExpenses.reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             const llcPercentage = totalSpending > 0 ? (llcTotal / totalSpending * 100) : 0;
             
             // Top 5 expenses
             const sortedExpenses = [...monthExpenses].sort((a, b) => (b.fields.Actual || 0) - (a.fields.Actual || 0));
             const top5 = sortedExpenses.slice(0, 5);
             
             // Contribution balance
             const expectedEach = totalSpending / 2;
             const amarDiff = amarTotal - expectedEach;
             const priyaDiff = priyaTotal - expectedEach;
             
             // Month names
             const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
             
             // Generate progress bars
             const amarBar = 'â–ˆ'.repeat(Math.round(amarPercentage / 5)) + 'â–‘'.repeat(20 - Math.round(amarPercentage / 5));
             const priyaBar = 'â–ˆ'.repeat(Math.round(priyaPercentage / 5)) + 'â–‘'.repeat(20 - Math.round(priyaPercentage / 5));
             
             // Render summary
             container.innerHTML = `
                 <div class="space-y-6">
                     <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-6 rounded-lg">
                         <h3 class="text-2xl font-bold mb-2">${monthNames[month - 1]} ${year}</h3>
                         <div class="text-4xl font-bold">$${totalSpending.toFixed(2)}</div>
                         <div class="text-sm opacity-90 mt-2">${expenseCount} transactions â€¢ $${avgExpense.toFixed(2)} average</div>
                     </div>
                     
                     <div class="card p-6">
                         <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                             <i class="fas fa-chart-pie text-purple-600"></i>
                             Spending by Category
                         </h3>
                         <div class="space-y-3">
                            ${Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]).map(([cat, amount]) => {
                                const percentage = (amount / totalSpending * 100).toFixed(1);
                                const categoryExpenses = monthExpenses.filter(exp => (exp.fields.Category || 'Other') === cat);
                                const expenseCount = categoryExpenses.length;
                                return `
                                    <div class="cursor-pointer hover:bg-purple-50 p-3 rounded-lg transition-colors" 
                                         onclick="showCategoryExpenses('${cat.replace(/'/g, "\\'")}', ${year}, ${month})"
                                         style="cursor: pointer;">
                                        <div class="flex justify-between items-start mb-1">
                                            <div class="flex-1">
                                                <span class="font-semibold">${cat}</span>
                                                <span class="text-xs text-gray-500 ml-2">(${expenseCount} ${expenseCount === 1 ? 'item' : 'items'})</span>
                                            </div>
                                            <span class="text-gray-600 whitespace-nowrap ml-2">$${amount.toFixed(2)} (${percentage}%)</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-purple-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                        </div>
                                        <div class="text-xs text-purple-600 mt-1 opacity-0 hover:opacity-100 transition-opacity">
                                            <i class="fas fa-arrow-right mr-1"></i>Click to view expenses
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                     </div>
                     
                     <div class="card p-6">
                         <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                             <i class="fas fa-users text-purple-600"></i>
                             Contribution Breakdown
                         </h3>
                         <div class="space-y-6">
                             <div class="p-4 bg-blue-50 rounded-lg">
                                 <div class="flex justify-between items-center mb-2">
                                     <span class="text-lg font-bold">ðŸ‘¤ Amar</span>
                                     <span class="text-2xl font-bold text-blue-600">$${amarTotal.toFixed(2)}</span>
                                 </div>
                                 <div class="text-sm text-gray-600 mb-2">${amarPercentage.toFixed(1)}% of total contributions</div>
                                 <div class="font-mono text-xs bg-white p-2 rounded">${amarBar} ${amarPercentage.toFixed(0)}%</div>
                                 <div class="mt-2 text-sm ${amarDiff >= 0 ? 'text-green-600' : 'text-red-600'}">
                                     ${amarDiff >= 0 ? '+' : ''}$${amarDiff.toFixed(2)} vs 50/50 split
                                 </div>
                             </div>
                             
                             <div class="p-4 bg-pink-50 rounded-lg">
                                 <div class="flex justify-between items-center mb-2">
                                     <span class="text-lg font-bold">ðŸ‘¤ Priya</span>
                                     <span class="text-2xl font-bold text-pink-600">$${priyaTotal.toFixed(2)}</span>
                                 </div>
                                 <div class="text-sm text-gray-600 mb-2">${priyaPercentage.toFixed(1)}% of total contributions</div>
                                 <div class="font-mono text-xs bg-white p-2 rounded">${priyaBar} ${priyaPercentage.toFixed(0)}%</div>
                                 <div class="mt-2 text-sm ${priyaDiff >= 0 ? 'text-green-600' : 'text-red-600'}">
                                     ${priyaDiff >= 0 ? '+' : ''}$${priyaDiff.toFixed(2)} vs 50/50 split
                                 </div>
                             </div>
                             
                             <div class="p-4 bg-gray-100 rounded-lg">
                                 <div class="text-center">
                                     <div class="text-sm text-gray-600 mb-1">Expected (50/50)</div>
                                     <div class="text-lg font-bold">$${expectedEach.toFixed(2)} each</div>
                                     <div class="mt-2 text-sm font-semibold ${Math.abs(amarDiff) > 100 ? 'text-orange-600' : 'text-green-600'}">
                                         ${Math.abs(amarDiff) > 100 ? 'âš ï¸ Significant imbalance' : 'âœ“ Balanced contributions'}
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                     
                     <div class="card p-4 md:p-6">
                         <h3 class="text-lg md:text-xl font-bold mb-3 md:mb-4 flex items-center gap-2">
                             <i class="fas fa-building text-purple-600"></i>
                             <span class="text-sm md:text-base">LLC Eligible Expenses</span>
                         </h3>
                         <div class="grid grid-cols-3 gap-2 md:gap-4">
                             <div class="text-center p-2 md:p-4 bg-green-50 rounded-lg">
                                 <div class="text-lg md:text-2xl font-bold text-green-600 break-words">$${llcTotal.toFixed(2)}</div>
                                 <div class="text-xs md:text-sm text-gray-600">Total LLC</div>
                             </div>
                             <div class="text-center p-2 md:p-4 bg-blue-50 rounded-lg">
                                 <div class="text-lg md:text-2xl font-bold text-blue-600">${llcPercentage.toFixed(1)}%</div>
                                 <div class="text-xs md:text-sm text-gray-600">Of Total</div>
                             </div>
                             <div class="text-center p-2 md:p-4 bg-purple-50 rounded-lg">
                                 <div class="text-lg md:text-2xl font-bold text-purple-600 break-words">$${(llcTotal * 0.25).toFixed(2)}</div>
                                 <div class="text-xs md:text-sm text-gray-600">Est. Savings (25%)</div>
                             </div>
                         </div>
                     </div>
                     
                     <div class="card p-6">
                         <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                             <i class="fas fa-trophy text-purple-600"></i>
                             Top 5 Expenses
                         </h3>
                         <div class="space-y-3">
                             ${top5.map((exp, idx) => `
                                 <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                     <div class="text-2xl font-bold text-gray-400">${idx + 1}</div>
                                     <div class="flex-1">
                                         <div class="font-semibold">${exp.fields.Item || 'N/A'}</div>
                                         <div class="text-sm text-gray-600">${exp.fields.Category || 'N/A'}</div>
                                     </div>
                                     <div class="text-lg font-bold text-purple-600">$${(exp.fields.Actual || 0).toFixed(2)}</div>
                                 </div>
                             `).join('')}
                         </div>
                     </div>
                 </div>
             `;
         }
         
         function updatePredictedTotal() {
             // Quick calculation for dashboard tile
             const yearFilterEl = document.getElementById('yearSelector');
             const monthFilterEl = document.getElementById('monthSelector');
             const selectedYear = yearFilterEl ? yearFilterEl.value : 'all';
             const selectedMonth = monthFilterEl ? monthFilterEl.value : 'all';
             
             // Get expenses to analyze (last 3 months from current or filtered period)
             let expensesToAnalyze = allExpenses;
             
             // If specific month/year selected, use last 3 months from that point
             if (selectedYear !== 'all' && selectedMonth !== 'all') {
                 const year = parseInt(selectedYear);
                 const month = parseInt(selectedMonth);
                 
                 // Calculate 3 months before selected month
                 // For month 10 (Oct): want months 7, 8, 9
                 // For month 11 (Nov): want months 8, 9, 10
                 expensesToAnalyze = allExpenses.filter(exp => {
                     const expYear = exp.fields.Year;
                     const expMonth = parseInt(exp.fields.Month);
                     
                     // Create comparable values: YYYYMM format
                     const expValue = expYear * 100 + expMonth;
                     const selectedValue = year * 100 + month;
                     
                     // Calculate 3 months ago
                     let threeMonthsAgoYear = year;
                     let threeMonthsAgoMonth = month - 3;
                     if (threeMonthsAgoMonth <= 0) {
                         threeMonthsAgoMonth += 12;
                         threeMonthsAgoYear -= 1;
                     }
                     const threeMonthsAgoValue = threeMonthsAgoYear * 100 + threeMonthsAgoMonth;
                     
                     // Include expenses from 3 months ago up to (but not including) selected month
                     return expValue >= threeMonthsAgoValue && expValue < selectedValue;
                 });
             } else {
                 // Use last 3 months from now
                 const now = new Date();
                 const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 2, 1);
                 expensesToAnalyze = allExpenses.filter(exp => {
                     const expDate = new Date(exp.fields.Year, exp.fields.Month - 1, 1);
                     return expDate >= threeMonthsAgo;
                 });
             }
             
             if (expensesToAnalyze.length === 0) {
                 document.getElementById('predictedTotal').innerHTML = '$0';
                 return;
             }
             
             // Calculate simple average
             const total = expensesToAnalyze.reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             const monthsCount = Math.max(1, new Set(expensesToAnalyze.map(e => `${e.fields.Year}-${e.fields.Month}`)).size);
             const avgMonthly = total / monthsCount;
             
             // Simple trend calculation
             const monthlyTotals = {};
             expensesToAnalyze.forEach(exp => {
                 const key = `${exp.fields.Year}-${String(exp.fields.Month).padStart(2, '0')}`;
                 monthlyTotals[key] = (monthlyTotals[key] || 0) + (exp.fields.Actual || 0);
             });
             
             const months = Object.keys(monthlyTotals).sort();
             const trend = months.length > 1 ? (monthlyTotals[months[months.length - 1]] - monthlyTotals[months[0]]) / months.length : 0;
             
             const predicted = Math.max(0, avgMonthly + trend);
             
             // Get comparison month (last month in analysis)
             const lastMonthKey = months[months.length - 1];
             const lastMonthTotal = monthlyTotals[lastMonthKey] || 0;
             
             // Calculate percentage change
             const change = lastMonthTotal > 0 ? ((predicted - lastMonthTotal) / lastMonthTotal * 100) : 0;
             const absChange = Math.abs(change);
             
             // Determine arrow and color based on change
             let arrow = '';
             let arrowColor = '';
             
             if (absChange < 5) {
                 // Less than 5% change - neutral/stable
                 arrow = 'â†’';
                 arrowColor = '#FFA500'; // Orange
             } else if (change > 0) {
                 // Increasing
                 arrow = 'â†‘';
                 if (absChange < 10) {
                     arrowColor = '#FF6B6B'; // Light red
                 } else if (absChange < 20) {
                     arrowColor = '#FF4444'; // Medium red
                 } else {
                     arrowColor = '#CC0000'; // Dark red
                 }
             } else {
                 // Decreasing
                 arrow = 'â†“';
                 if (absChange < 10) {
                     arrowColor = '#90EE90'; // Light green
                 } else if (absChange < 20) {
                     arrowColor = '#4CAF50'; // Medium green
                 } else {
                     arrowColor = '#2E7D32'; // Dark green
                 }
             }
             
             document.getElementById('predictedTotal').innerHTML = `
                 <span style="color: ${arrowColor}; font-size: 0.8em; margin-right: 4px;">${arrow}</span>$${predicted.toFixed(0)}
             `;
         }
         
         function openPredictiveBudgeting() {
             document.getElementById('predictiveBudgetingModal').classList.add('active');
             generatePredictions();
         }
         
         function closePredictiveBudgeting() {
             document.getElementById('predictiveBudgetingModal').classList.remove('active');
         }
         
         function generatePredictions() {
             const container = document.getElementById('predictiveBudgetingContent');
             
             // Get selected filter or current date
             const yearFilterEl = document.getElementById('yearSelector');
             const monthFilterEl = document.getElementById('monthSelector');
             const selectedYear = yearFilterEl ? yearFilterEl.value : 'all';
             const selectedMonth = monthFilterEl ? monthFilterEl.value : 'all';
             
             let baseYear, baseMonth, predictYear, predictMonth;
             const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
             
             // Determine what month we're predicting for
             if (selectedYear !== 'all' && selectedMonth !== 'all') {
                 // Predicting for the selected month
                 baseYear = parseInt(selectedYear);
                 baseMonth = parseInt(selectedMonth);
                 predictYear = baseYear;
                 predictMonth = baseMonth;
             } else {
                 // Predicting for next month from today
                 const now = new Date();
                 baseYear = now.getFullYear();
                 baseMonth = now.getMonth() + 1;
                 predictMonth = baseMonth + 1;
                 predictYear = baseYear;
                 if (predictMonth > 12) {
                     predictMonth = 1;
                     predictYear += 1;
                 }
             }
             
             // Get expenses from 3 months before the prediction target
             let recentExpenses;
             if (selectedYear !== 'all' && selectedMonth !== 'all') {
                 // Use same logic as updatePredictedTotal
                 const year = parseInt(selectedYear);
                 const month = parseInt(selectedMonth);
                 
                 recentExpenses = allExpenses.filter(exp => {
                     const expYear = exp.fields.Year;
                     const expMonth = parseInt(exp.fields.Month);
                     const expValue = expYear * 100 + expMonth;
                     const selectedValue = year * 100 + month;
                     
                     let threeMonthsAgoYear = year;
                     let threeMonthsAgoMonth = month - 3;
                     if (threeMonthsAgoMonth <= 0) {
                         threeMonthsAgoMonth += 12;
                         threeMonthsAgoYear -= 1;
                     }
                     const threeMonthsAgoValue = threeMonthsAgoYear * 100 + threeMonthsAgoMonth;
                     
                     return expValue >= threeMonthsAgoValue && expValue < selectedValue;
                 });
             } else {
                 const now = new Date();
                 const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 2, 1);
                 recentExpenses = allExpenses.filter(exp => {
                     const expDate = new Date(exp.fields.Year, exp.fields.Month - 1, 1);
                     return expDate >= threeMonthsAgo;
                 });
             }
             
             if (recentExpenses.length === 0) {
                 container.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-inbox text-4xl mb-3"></i><p>Not enough data to generate predictions. Add more expenses first.</p></div>';
                 return;
             }
             
             // Calculate predictions by category
             const categoryData = {};
             recentExpenses.forEach(exp => {
                 const cat = exp.fields.Category || 'Other';
                 if (!categoryData[cat]) {
                     categoryData[cat] = { total: 0, count: 0, amounts: [] };
                 }
                 categoryData[cat].total += exp.fields.Actual || 0;
                 categoryData[cat].count++;
                 categoryData[cat].amounts.push(exp.fields.Actual || 0);
             });
             
             // Calculate overall prediction (same logic as dashboard)
             const total = recentExpenses.reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             const monthsCount = Math.max(1, new Set(recentExpenses.map(e => `${e.fields.Year}-${e.fields.Month}`)).size);
             const avgMonthly = total / monthsCount;
             
             // Overall trend calculation
             const monthlyTotals = {};
             recentExpenses.forEach(exp => {
                 const key = `${exp.fields.Year}-${String(exp.fields.Month).padStart(2, '0')}`;
                 monthlyTotals[key] = (monthlyTotals[key] || 0) + (exp.fields.Actual || 0);
             });
             
             const months = Object.keys(monthlyTotals).sort();
             const overallTrend = months.length > 1 ? (monthlyTotals[months[months.length - 1]] - monthlyTotals[months[0]]) / months.length : 0;
             const totalPredicted = Math.max(0, avgMonthly + overallTrend);
             
             // Calculate predictions per category (for breakdown display)
             const predictions = [];
             
             Object.keys(categoryData).forEach(category => {
                 const data = categoryData[category];
                 const average = data.total / data.count;
                 
                 // Calculate trend (simple linear regression)
                 const amounts = data.amounts;
                 const trend = amounts.length > 1 ? (amounts[amounts.length - 1] - amounts[0]) / amounts.length : 0;
                 
                 // Predicted amount = average + trend
                 const predicted = Math.max(0, average + trend);
                 
                 // Calculate confidence based on consistency
                 const variance = amounts.reduce((sum, val) => sum + Math.pow(val - average, 2), 0) / amounts.length;
                 const stdDev = Math.sqrt(variance);
                 const confidence = Math.max(0, Math.min(100, 100 - (stdDev / average * 100)));
                 
                 predictions.push({
                     category,
                     predicted,
                     average,
                     trend: trend > 0 ? 'increasing' : trend < 0 ? 'decreasing' : 'stable',
                     trendAmount: Math.abs(trend),
                     confidence,
                     count: data.count
                 });
             });
             
             // Sort by predicted amount
             predictions.sort((a, b) => b.predicted - a.predicted);
             
             // Calculate overall metrics
             const currentMonthTotal = allExpenses
                 .filter(exp => exp.fields.Year === baseYear && exp.fields.Month === baseMonth)
                 .reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             
             // Calculate last month from base month
             let lastMonth = baseMonth - 1;
             let lastMonthYear = baseYear;
             if (lastMonth === 0) {
                 lastMonth = 12;
                 lastMonthYear -= 1;
             }
             
             const lastMonthTotal = allExpenses
                 .filter(exp => exp.fields.Year === lastMonthYear && exp.fields.Month === lastMonth)
                 .reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             
             // Render predictions
             container.innerHTML = `
                 <div class="space-y-6">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                         <div class="card p-6 text-center bg-gradient-to-br from-purple-500 to-pink-500 text-white">
                             <div class="text-sm opacity-90 mb-2">Predicted Total</div>
                             <div class="text-3xl font-bold">$${totalPredicted.toFixed(2)}</div>
                             <div class="text-xs opacity-75 mt-2">${monthNames[predictMonth - 1]} ${predictYear}</div>
                         </div>
                         <div class="card p-6 text-center">
                             <div class="text-sm text-gray-600 mb-2">3-Month Average</div>
                             <div class="text-2xl font-bold text-gray-800">$${avgMonthly.toFixed(2)}</div>
                             <div class="text-xs text-gray-500 mt-2">Based on recent history</div>
                         </div>
                         <div class="card p-6 text-center">
                             <div class="text-sm text-gray-600 mb-2">vs Last Month</div>
                             <div class="text-2xl font-bold ${totalPredicted > lastMonthTotal ? 'text-red-600' : 'text-green-600'}">
                                 ${totalPredicted > lastMonthTotal ? '+' : ''}$${(totalPredicted - lastMonthTotal).toFixed(2)}
                             </div>
                             <div class="text-xs text-gray-500 mt-2">${lastMonthTotal > 0 ? ((totalPredicted - lastMonthTotal) / lastMonthTotal * 100).toFixed(1) + '% change' : 'N/A (no previous data)'}</div>
                         </div>
                     </div>
                     
                     <div class="card p-6">
                         <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                             <i class="fas fa-chart-line text-purple-600"></i>
                             Category Predictions
                         </h3>
                         <div class="space-y-4">
                             ${predictions.map(pred => `
                                 <div class="p-4 bg-gray-50 rounded-lg">
                                     <div class="flex justify-between items-start mb-3">
                                         <div class="flex-1">
                                             <div class="font-semibold text-lg text-gray-800">${pred.category}</div>
                                             <div class="text-sm text-gray-600">Based on ${pred.count} recent transactions</div>
                                         </div>
                                         <div class="text-right">
                                             <div class="text-2xl font-bold text-purple-600">$${pred.predicted.toFixed(2)}</div>
                                             <div class="text-xs text-gray-500">predicted</div>
                                         </div>
                                     </div>
                                     <div class="grid grid-cols-3 gap-3 text-sm">
                                         <div>
                                             <span class="text-gray-600">Average:</span>
                                             <span class="font-semibold ml-1">$${pred.average.toFixed(2)}</span>
                                         </div>
                                         <div>
                                             <span class="text-gray-600">Trend:</span>
                                             <span class="font-semibold ml-1 ${pred.trend === 'increasing' ? 'text-red-600' : pred.trend === 'decreasing' ? 'text-green-600' : 'text-gray-600'}">
                                                 ${pred.trend === 'increasing' ? 'â†‘' : pred.trend === 'decreasing' ? 'â†“' : 'â†’'} ${pred.trend}
                                             </span>
                                         </div>
                                         <div>
                                             <span class="text-gray-600">Confidence:</span>
                                             <span class="font-semibold ml-1">${pred.confidence.toFixed(0)}%</span>
                                         </div>
                                     </div>
                                     <div class="mt-3">
                                         <div class="w-full bg-gray-200 rounded-full h-2">
                                             <div class="bg-purple-600 h-2 rounded-full" style="width: ${(pred.predicted / totalPredicted * 100).toFixed(1)}%"></div>
                                         </div>
                                         <div class="text-xs text-gray-500 mt-1">${(pred.predicted / totalPredicted * 100).toFixed(1)}% of total predicted spending</div>
                                     </div>
                                 </div>
                             `).join('')}
                         </div>
                     </div>
                     
                     <div class="card p-6">
                         <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                             <i class="fas fa-chart-area text-purple-600"></i>
                             Predicted vs Actual Trend
                         </h3>
                         <div class="chart-container" style="height: 300px;">
                             <canvas id="predictionTrendChart"></canvas>
                         </div>
                     </div>
                     
                     <div class="card p-6 bg-yellow-50 border border-yellow-200">
                         <h3 class="text-lg font-bold mb-3 text-yellow-800">
                             <i class="fas fa-lightbulb mr-2"></i>Insights & Recommendations
                         </h3>
                         <ul class="space-y-2 text-sm text-yellow-800">
                             ${totalPredicted > avgMonthly * 1.1 ? '<li><i class="fas fa-exclamation-triangle mr-2"></i>Predicted spending is 10%+ higher than your 3-month average. Consider reviewing your budget.</li>' : ''}
                             ${predictions.filter(p => p.trend === 'increasing').length > 0 ? `<li><i class="fas fa-arrow-trend-up mr-2"></i>Increasing trends detected in: ${predictions.filter(p => p.trend === 'increasing').map(p => p.category).join(', ')}</li>` : ''}
                             ${predictions.filter(p => p.confidence < 50).length > 0 ? `<li><i class="fas fa-question-circle mr-2"></i>Low confidence predictions for: ${predictions.filter(p => p.confidence < 50).map(p => p.category).join(', ')}. More data needed.</li>` : ''}
                             <li><i class="fas fa-check-circle mr-2"></i>Predictions improve with more data. Keep tracking your expenses!</li>
                         </ul>
                     </div>
                 </div>
             `;
             
             // Create prediction trend chart
             createPredictionTrendChart(totalPredicted, avgMonthly, lastMonthTotal, currentMonthTotal);
         }
         
         function createPredictionTrendChart(predicted, avgMonthly, lastMonth, currentMonth) {
             const ctx = document.getElementById('predictionTrendChart');
             if (!ctx) return;
             
             // Destroy existing chart if it exists
             if (window.predictionChart) {
                 window.predictionChart.destroy();
             }
             
             // Get last 6 months of actual data
             const now = new Date();
             const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
             const labels = [];
             const actualData = [];
             const predictedData = [];
             
             // Get last 6 months
             for (let i = 5; i >= 0; i--) {
                 const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                 const month = date.getMonth() + 1;
                 const year = date.getFullYear();
                 labels.push(`${monthNames[date.getMonth()]} ${year}`);
                 
                 const monthTotal = allExpenses
                     .filter(exp => exp.fields.Year === year && exp.fields.Month === month)
                     .reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
                 
                 actualData.push(monthTotal);
                 
                 // Add last actual value to predicted line to connect it
                 if (i === 0) {
                     predictedData.push(monthTotal); // Connect from last actual month
                 } else {
                     predictedData.push(null);
                 }
             }
             
             // Add next month prediction
             const nextDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
             labels.push(`${monthNames[nextDate.getMonth()]} ${nextDate.getFullYear()}`);
             actualData.push(null); // No actual data yet
             predictedData.push(predicted);
             
             window.predictionChart = new Chart(ctx, {
                 type: 'line',
                 data: {
                     labels: labels,
                     datasets: [
                         {
                             label: 'Actual Spending',
                             data: actualData,
                             borderColor: '#667eea',
                             backgroundColor: 'rgba(102, 126, 234, 0.1)',
                             borderWidth: 3,
                             fill: true,
                             tension: 0.4,
                             pointRadius: 6,
                             pointHoverRadius: 8,
                             pointBackgroundColor: '#667eea',
                             pointBorderColor: '#fff',
                             pointBorderWidth: 2
                         },
                         {
                             label: 'Predicted Spending',
                             data: predictedData,
                             borderColor: '#FA8BFF',
                             backgroundColor: 'rgba(250, 139, 255, 0.1)',
                             borderWidth: 3,
                             borderDash: [10, 5],
                             fill: true,
                             tension: 0.4,
                             pointRadius: 8,
                             pointHoverRadius: 10,
                             pointBackgroundColor: '#FA8BFF',
                             pointBorderColor: '#fff',
                             pointBorderWidth: 2,
                             pointStyle: 'star'
                         }
                     ]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         legend: {
                             display: true,
                             position: 'top',
                             labels: {
                                 usePointStyle: true,
                                 padding: 15,
                                 font: { size: 12, weight: 'bold' }
                             }
                         },
                         tooltip: {
                             mode: 'index',
                             intersect: false,
                             backgroundColor: 'rgba(0, 0, 0, 0.8)',
                             padding: 12,
                             titleFont: { size: 14, weight: 'bold' },
                             bodyFont: { size: 13 },
                             callbacks: {
                                 label: function(context) {
                                     let label = context.dataset.label || '';
                                     if (label) {
                                         label += ': ';
                                     }
                                     if (context.parsed.y !== null) {
                                         label += '$' + context.parsed.y.toFixed(2);
                                     }
                                     return label;
                                 }
                             }
                         }
                     },
                     scales: {
                         y: {
                             beginAtZero: true,
                             ticks: {
                                 callback: function(value) {
                                     return '$' + value.toFixed(0);
                                 }
                             },
                             grid: {
                                 color: 'rgba(0, 0, 0, 0.05)'
                             }
                         },
                         x: {
                             grid: {
                                 display: false
                             }
                         }
                     },
                     interaction: {
                         mode: 'nearest',
                         axis: 'x',
                         intersect: false
                     }
                 }
             });
         }
         
         function openAIInsights() {
             document.getElementById('aiInsightsModal').classList.add('active');
             generateAIInsights();
         }
         
         function closeAIInsights() {
             document.getElementById('aiInsightsModal').classList.remove('active');
         }
         
         function generateAIInsights() {
             const container = document.getElementById('aiInsightsContent');
             
             if (allExpenses.length === 0) {
                 container.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-inbox text-4xl mb-3"></i><p>No expenses to analyze. Add some expenses first!</p></div>';
                 return;
             }
             
             const insights = [];
             
             // 1. Weekend vs Weekday Spending Pattern
             const weekendInsight = analyzeWeekendSpending();
             if (weekendInsight) insights.push(weekendInsight);
             
             // 2. Category Overspending Detection
             const overspendingInsights = detectOverspending();
             insights.push(...overspendingInsights);
             
             // 3. Spending Trends
             const trendInsights = analyzeSpendingTrends();
             insights.push(...trendInsights);
             
             // 4. Anomaly Detection
             const anomalies = detectAnomalies();
             insights.push(...anomalies);
             
             // 5. Money Saving Opportunities
             const savingTips = generateSavingTips();
             insights.push(...savingTips);
             
             // 6. Budget Efficiency Score
             const efficiencyScore = calculateBudgetEfficiency();
             
             // Render insights
             container.innerHTML = `
                 <div class="space-y-6">
                     <!-- Efficiency Score Card -->
                     <div class="card p-6 bg-gradient-to-br from-purple-500 to-pink-500 text-white">
                         <div class="flex items-center justify-between">
                             <div>
                                 <h3 class="text-xl font-bold mb-2">Budget Efficiency Score</h3>
                                 <p class="text-sm opacity-90">How well you're managing your budget</p>
                             </div>
                             <div class="text-center">
                                 <div class="text-5xl font-bold">${efficiencyScore.score}</div>
                                 <div class="text-sm opacity-75">/100</div>
                             </div>
                         </div>
                         <div class="mt-4 bg-white bg-opacity-20 rounded-full h-3">
                             <div class="bg-white rounded-full h-3 transition-all" style="width: ${efficiencyScore.score}%"></div>
                         </div>
                         <p class="mt-3 text-sm">${efficiencyScore.message}</p>
                     </div>
                     
                     <!-- Insights Grid -->
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         ${insights.map(insight => `
                             <div class="card p-5 border-l-4 ${insight.type === 'warning' ? 'border-red-500 bg-red-50' : insight.type === 'success' ? 'border-green-500 bg-green-50' : insight.type === 'info' ? 'border-blue-500 bg-blue-50' : 'border-yellow-500 bg-yellow-50'}">
                                 <div class="flex items-start gap-3">
                                     <i class="fas ${insight.icon} text-2xl ${insight.type === 'warning' ? 'text-red-600' : insight.type === 'success' ? 'text-green-600' : insight.type === 'info' ? 'text-blue-600' : 'text-yellow-600'}"></i>
                                     <div class="flex-1">
                                         <h4 class="font-bold text-gray-800 mb-2">${insight.title}</h4>
                                         <p class="text-sm text-gray-700 mb-3">${insight.message}</p>
                                         ${insight.action ? `<div class="text-xs font-semibold ${insight.type === 'warning' ? 'text-red-700' : insight.type === 'success' ? 'text-green-700' : insight.type === 'info' ? 'text-blue-700' : 'text-yellow-700'}"><i class="fas fa-lightbulb mr-1"></i>${insight.action}</div>` : ''}
                                     </div>
                                 </div>
                             </div>
                         `).join('')}
                     </div>
                 </div>
             `;
         }
         
         function analyzeWeekendSpending() {
             const weekendSpending = [];
             const weekdaySpending = [];
             
             allExpenses.forEach(exp => {
                 const date = new Date(exp.fields.Year, exp.fields.Month - 1, exp.fields.Day || 1);
                 const dayOfWeek = date.getDay();
                 const amount = exp.fields.Actual || 0;
                 
                 if (dayOfWeek === 0 || dayOfWeek === 6) {
                     weekendSpending.push(amount);
                 } else {
                     weekdaySpending.push(amount);
                 }
             });
             
             if (weekendSpending.length === 0 || weekdaySpending.length === 0) return null;
             
             const weekendAvg = weekendSpending.reduce((a, b) => a + b, 0) / weekendSpending.length;
             const weekdayAvg = weekdaySpending.reduce((a, b) => a + b, 0) / weekdaySpending.length;
             
             const diff = ((weekendAvg - weekdayAvg) / weekdayAvg * 100);
             
             if (Math.abs(diff) < 10) return null;
             
             if (diff > 0) {
                 return {
                     type: 'tip',
                     icon: 'fa-calendar-week',
                     title: 'Weekend Spending Pattern',
                     message: `You spend ${diff.toFixed(0)}% more on weekends ($${weekendAvg.toFixed(2)} vs $${weekdayAvg.toFixed(2)} on weekdays).`,
                     action: 'Plan weekend activities in advance to reduce impulse spending.'
                 };
             } else {
                 return {
                     type: 'success',
                     icon: 'fa-calendar-check',
                     title: 'Great Weekend Control',
                     message: `You spend ${Math.abs(diff).toFixed(0)}% less on weekends. Keep it up!`,
                     action: null
                 };
             }
         }
         
         function detectOverspending() {
             const insights = [];
             const categoryTotals = {};
             const categoryBudgets = {};
             
             allExpenses.forEach(exp => {
                 const cat = exp.fields.Category || 'Other';
                 categoryTotals[cat] = (categoryTotals[cat] || 0) + (exp.fields.Actual || 0);
                 categoryBudgets[cat] = (categoryBudgets[cat] || 0) + (exp.fields.Budget || 0);
             });
             
             Object.keys(categoryTotals).forEach(cat => {
                 const actual = categoryTotals[cat];
                 const budget = categoryBudgets[cat];
                 
                 if (budget > 0) {
                     const overspend = ((actual - budget) / budget * 100);
                     
                     if (overspend > 20) {
                         insights.push({
                             type: 'warning',
                             icon: 'fa-exclamation-triangle',
                             title: `${cat} Overspending`,
                             message: `You've exceeded your ${cat} budget by ${overspend.toFixed(0)}% ($${(actual - budget).toFixed(2)} over).`,
                             action: `Review ${cat} expenses and set a stricter budget next month.`
                         });
                     } else if (overspend < -20) {
                         insights.push({
                             type: 'success',
                             icon: 'fa-check-circle',
                             title: `${cat} Under Budget`,
                             message: `Great job! You're ${Math.abs(overspend).toFixed(0)}% under budget in ${cat}.`,
                             action: null
                         });
                     }
                 }
             });
             
             return insights.slice(0, 3); // Top 3
         }
         
         function analyzeSpendingTrends() {
             const insights = [];
             const now = new Date();
             
             // Get last 3 months
             const monthlyTotals = {};
             for (let i = 2; i >= 0; i--) {
                 const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                 const key = `${date.getFullYear()}-${date.getMonth() + 1}`;
                 monthlyTotals[key] = 0;
             }
             
             allExpenses.forEach(exp => {
                 const key = `${exp.fields.Year}-${exp.fields.Month}`;
                 if (monthlyTotals.hasOwnProperty(key)) {
                     monthlyTotals[key] += exp.fields.Actual || 0;
                 }
             });
             
             const months = Object.keys(monthlyTotals).sort();
             if (months.length >= 2) {
                 const trend = monthlyTotals[months[months.length - 1]] - monthlyTotals[months[0]];
                 const trendPercent = (trend / monthlyTotals[months[0]] * 100);
                 
                 if (trendPercent > 15) {
                     insights.push({
                         type: 'warning',
                         icon: 'fa-arrow-trend-up',
                         title: 'Spending Increasing',
                         message: `Your spending has increased by ${trendPercent.toFixed(0)}% over the last 3 months.`,
                         action: 'Review your expenses and identify areas to cut back.'
                     });
                 } else if (trendPercent < -15) {
                     insights.push({
                         type: 'success',
                         icon: 'fa-arrow-trend-down',
                         title: 'Spending Decreasing',
                         message: `Excellent! Your spending has decreased by ${Math.abs(trendPercent).toFixed(0)}% over the last 3 months.`,
                         action: null
                     });
                 }
             }
             
             return insights;
         }
         
         function detectAnomalies() {
             const insights = [];
             const categoryExpenses = {};
             
             // Group by category
             allExpenses.forEach(exp => {
                 const cat = exp.fields.Category || 'Other';
                 if (!categoryExpenses[cat]) categoryExpenses[cat] = [];
                 categoryExpenses[cat].push(exp.fields.Actual || 0);
             });
             
             // Detect anomalies (expenses > 2 standard deviations from mean)
             Object.keys(categoryExpenses).forEach(cat => {
                 const amounts = categoryExpenses[cat];
                 if (amounts.length < 3) return;
                 
                 const mean = amounts.reduce((a, b) => a + b, 0) / amounts.length;
                 const variance = amounts.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / amounts.length;
                 const stdDev = Math.sqrt(variance);
                 
                 const anomalies = amounts.filter(amt => Math.abs(amt - mean) > 2 * stdDev);
                 
                 if (anomalies.length > 0) {
                     insights.push({
                         type: 'info',
                         icon: 'fa-chart-line',
                         title: `Unusual ${cat} Expense`,
                         message: `Detected ${anomalies.length} unusually high expense(s) in ${cat}. Average: $${mean.toFixed(2)}, Unusual: $${Math.max(...anomalies).toFixed(2)}.`,
                         action: 'Review these expenses to ensure they were necessary.'
                     });
                 }
             });
             
             return insights.slice(0, 2);
         }
         
         function generateSavingTips() {
             const insights = [];
             const categoryTotals = {};
             
             allExpenses.forEach(exp => {
                 const cat = exp.fields.Category || 'Other';
                 categoryTotals[cat] = (categoryTotals[cat] || 0) + (exp.fields.Actual || 0);
             });
             
             // Find top spending categories
             const sorted = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
             
             if (sorted.length > 0) {
                 const topCategory = sorted[0];
                 const savingAmount = topCategory[1] * 0.2; // 20% reduction
                 
                 insights.push({
                     type: 'tip',
                     icon: 'fa-piggy-bank',
                     title: 'Savings Opportunity',
                     message: `${topCategory[0]} is your highest expense ($${topCategory[1].toFixed(2)}). Reducing it by 20% could save you $${savingAmount.toFixed(2)}/month.`,
                     action: `Look for alternatives or negotiate better rates for ${topCategory[0]}.`
                 });
             }
             
             return insights;
         }
         
         function calculateBudgetEfficiency() {
             let score = 100;
             let message = '';
             
             const totalBudget = allExpenses.reduce((sum, exp) => sum + (exp.fields.Budget || 0), 0);
             const totalActual = allExpenses.reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             
             if (totalBudget === 0) {
                 return { score: 50, message: 'Set budgets for your expenses to improve your score!' };
             }
             
             const variance = ((totalActual - totalBudget) / totalBudget * 100);
             
             // Deduct points for overspending
             if (variance > 0) {
                 score -= Math.min(variance, 50);
                 message = 'You\'re overspending. Try to stick to your budget!';
             } else if (variance < -30) {
                 score -= 20;
                 message = 'You\'re way under budget. Consider adjusting your budget or saving more!';
             } else {
                 message = 'Great job staying within budget!';
             }
             
             return { score: Math.max(0, Math.round(score)), message };
         }
         
         function openAdvancedAnalytics() {
             document.getElementById('advancedAnalyticsModal').classList.add('active');
             generateAdvancedAnalytics();
         }
         
         function closeAdvancedAnalytics() {
             document.getElementById('advancedAnalyticsModal').classList.remove('active');
         }
         
         function generateAdvancedAnalytics() {
             const container = document.getElementById('advancedAnalyticsContent');
             
             if (allExpenses.length === 0) {
                 container.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-inbox text-4xl mb-3"></i><p>No expenses to analyze. Add some expenses first!</p></div>';
                 return;
             }
             
             // Render analytics dashboard
             container.innerHTML = `
                 <div class="space-y-6">
                     <!-- Top Spending Days -->
                     <div class="card p-6">
                         <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                             <i class="fas fa-fire text-red-600"></i>
                             Top 10 Spending Days
                         </h3>
                         <div id="topSpendingDays"></div>
                     </div>
                     
                     <!-- Monthly Spending Trend -->
                     <div class="card p-6">
                         <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                             <i class="fas fa-chart-line text-purple-600"></i>
                             Monthly Spending Trend (Last 6 Months)
                         </h3>
                         <div class="chart-container" style="height: 300px;">
                             <canvas id="monthlyTrendChart"></canvas>
                         </div>
                     </div>
                     
                     <!-- Category Distribution -->
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div class="card p-6">
                             <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                                 <i class="fas fa-chart-pie text-purple-600"></i>
                                 Spending by Category
                             </h3>
                             <div class="chart-container" style="height: 300px;">
                                 <canvas id="categoryPieChart"></canvas>
                             </div>
                         </div>
                         
                         <!-- Budget vs Actual -->
                         <div class="card p-6">
                             <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                                 <i class="fas fa-balance-scale text-purple-600"></i>
                                 Budget vs Actual
                             </h3>
                             <div class="chart-container" style="height: 300px;">
                                 <canvas id="budgetVsActualChart"></canvas>
                             </div>
                         </div>
                     </div>
                     
                     <!-- Category Comparison Chart -->
                     <div class="card p-6">
                         <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                             <i class="fas fa-chart-bar text-purple-600"></i>
                             Category Comparison - Last 3 Months
                         </h3>
                         <div class="chart-container" style="height: 400px;">
                             <canvas id="categoryComparisonChart"></canvas>
                         </div>
                     </div>
                 </div>
             `;
             
             // Generate each visualization
             createTopSpendingDays();
             createMonthlyTrendChart();
             createCategoryPieChart();
             createBudgetVsActualChart();
             createCategoryComparisonChart();
         }
         
         function createTopSpendingDays() {
             const container = document.getElementById('topSpendingDays');
             
             // Group expenses by date and sum
             const dailySpending = {};
             allExpenses.forEach(exp => {
                 const dateKey = `${exp.fields.Year}-${String(exp.fields.Month).padStart(2, '0')}-${String(exp.fields.Day || 1).padStart(2, '0')}`;
                 const displayDate = `${exp.fields.Month}/${exp.fields.Day || 1}/${exp.fields.Year}`;
                 
                 if (!dailySpending[dateKey]) {
                     dailySpending[dateKey] = {
                         date: displayDate,
                         total: 0,
                         expenses: []
                     };
                 }
                 
                 dailySpending[dateKey].total += exp.fields.Actual || 0;
                 dailySpending[dateKey].expenses.push({
                     item: exp.fields.Item,
                     amount: exp.fields.Actual || 0,
                     category: exp.fields.Category || 'Other'
                 });
             });
             
             // Sort by total and get top 10
             const topDays = Object.values(dailySpending)
                 .sort((a, b) => b.total - a.total)
                 .slice(0, 10);
             
             if (topDays.length === 0) {
                 container.innerHTML = '<p class="text-gray-500 text-center py-4">No spending data available</p>';
                 return;
             }
             
             // Render top days
             let html = '<div class="space-y-3">';
             topDays.forEach((day, index) => {
                 const maxAmount = topDays[0].total;
                 const percentage = (day.total / maxAmount * 100);
                 
                 html += `
                     <div class="relative">
                         <div class="flex items-center justify-between mb-2">
                             <div class="flex items-center gap-3">
                                 <span class="text-2xl font-bold text-gray-400">#${index + 1}</span>
                                 <div>
                                     <div class="font-semibold text-gray-800">${day.date}</div>
                                     <div class="text-xs text-gray-500">${day.expenses.length} expense${day.expenses.length > 1 ? 's' : ''}</div>
                                 </div>
                             </div>
                             <div class="text-right">
                                 <div class="text-xl font-bold text-purple-600">$${day.total.toFixed(2)}</div>
                             </div>
                         </div>
                         <div class="w-full bg-gray-200 rounded-full h-2">
                             <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all" style="width: ${percentage}%"></div>
                         </div>
                         <div class="mt-2 text-xs text-gray-600">
                             ${day.expenses.slice(0, 3).map(e => `${e.item} ($${e.amount.toFixed(2)})`).join(', ')}
                             ${day.expenses.length > 3 ? ` +${day.expenses.length - 3} more` : ''}
                         </div>
                     </div>
                 `;
             });
             html += '</div>';
             
             container.innerHTML = html;
         }
         
         function createMonthlyTrendChart() {
             const ctx = document.getElementById('monthlyTrendChart');
             if (!ctx) return;
             
             const now = new Date();
             const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
             
             // Get last 6 months
             const labels = [];
             const spendingData = [];
             const budgetData = [];
             
             for (let i = 5; i >= 0; i--) {
                 const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                 const year = date.getFullYear();
                 const month = date.getMonth() + 1;
                 
                 labels.push(`${monthNames[date.getMonth()]} ${year}`);
                 
                 const monthExpenses = allExpenses.filter(exp => 
                     exp.fields.Year === year && exp.fields.Month === month
                 );
                 
                 const spending = monthExpenses.reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
                 const budget = monthExpenses.reduce((sum, exp) => sum + (exp.fields.Budget || 0), 0);
                 
                 spendingData.push(spending);
                 budgetData.push(budget);
             }
             
             // Destroy existing chart
             if (window.monthlyTrendChart && typeof window.monthlyTrendChart.destroy === 'function') {
                 window.monthlyTrendChart.destroy();
             }
             
             window.monthlyTrendChart = new Chart(ctx, {
                 type: 'line',
                 data: {
                     labels: labels,
                     datasets: [
                         {
                             label: 'Actual Spending',
                             data: spendingData,
                             borderColor: '#f093fb',
                             backgroundColor: 'rgba(240, 147, 251, 0.1)',
                             borderWidth: 3,
                             fill: true,
                             tension: 0.4,
                             pointRadius: 6,
                             pointHoverRadius: 8,
                             pointBackgroundColor: '#f093fb',
                             pointBorderColor: '#fff',
                             pointBorderWidth: 2
                         },
                         {
                             label: 'Budget',
                             data: budgetData,
                             borderColor: '#667eea',
                             backgroundColor: 'rgba(102, 126, 234, 0.1)',
                             borderWidth: 3,
                             borderDash: [5, 5],
                             fill: false,
                             tension: 0.4,
                             pointRadius: 6,
                             pointHoverRadius: 8,
                             pointBackgroundColor: '#667eea',
                             pointBorderColor: '#fff',
                             pointBorderWidth: 2
                         }
                     ]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         legend: {
                             position: 'top',
                             labels: {
                                 usePointStyle: true,
                                 padding: 15
                             }
                         },
                         tooltip: {
                             mode: 'index',
                             intersect: false,
                             callbacks: {
                                 label: function(context) {
                                     return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                                 }
                             }
                         }
                     },
                     scales: {
                         y: {
                             beginAtZero: true,
                             ticks: {
                                 callback: function(value) {
                                     return '$' + value.toFixed(0);
                                 }
                             },
                             grid: {
                                 color: 'rgba(0, 0, 0, 0.05)'
                             }
                         },
                         x: {
                             grid: { display: false }
                         }
                     }
                 }
             });
         }
         
         function createCategoryPieChart() {
             const ctx = document.getElementById('categoryPieChart');
             if (!ctx) return;
             
             // Aggregate by category
             const categoryTotals = {};
             allExpenses.forEach(exp => {
                 const cat = exp.fields.Category || 'Other';
                 categoryTotals[cat] = (categoryTotals[cat] || 0) + (exp.fields.Actual || 0);
             });
             
             const labels = Object.keys(categoryTotals);
             const data = Object.values(categoryTotals);
             const colors = [
                 '#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a', 
                 '#fee140', '#30cfd0', '#a8edea', '#fed6e3', '#c471ed'
             ];
             
             // Destroy existing chart
             if (window.categoryPieChart && typeof window.categoryPieChart.destroy === 'function') {
                 window.categoryPieChart.destroy();
             }
             
             window.categoryPieChart = new Chart(ctx, {
                 type: 'doughnut',
                 data: {
                     labels: labels,
                     datasets: [{
                         data: data,
                         backgroundColor: colors.slice(0, labels.length),
                         borderWidth: 2,
                         borderColor: '#fff'
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         legend: {
                             position: 'right',
                             labels: {
                                 padding: 15,
                                 usePointStyle: true
                             }
                         },
                         tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                     const percentage = ((context.parsed / total) * 100).toFixed(1);
                                     return context.label + ': $' + context.parsed.toFixed(2) + ' (' + percentage + '%)';
                                 }
                             }
                         }
                     }
                 }
             });
         }
         
         function createBudgetVsActualChart() {
             const ctx = document.getElementById('budgetVsActualChart');
             if (!ctx) return;
             
             // Aggregate by category
             const categoryData = {};
             allExpenses.forEach(exp => {
                 const cat = exp.fields.Category || 'Other';
                 if (!categoryData[cat]) {
                     categoryData[cat] = { budget: 0, actual: 0 };
                 }
                 categoryData[cat].budget += exp.fields.Budget || 0;
                 categoryData[cat].actual += exp.fields.Actual || 0;
             });
             
             const labels = Object.keys(categoryData);
             const budgetData = labels.map(cat => categoryData[cat].budget);
             const actualData = labels.map(cat => categoryData[cat].actual);
             
             // Destroy existing chart
             if (window.budgetVsActualChart && typeof window.budgetVsActualChart.destroy === 'function') {
                 window.budgetVsActualChart.destroy();
             }
             
             window.budgetVsActualChart = new Chart(ctx, {
                 type: 'bar',
                 data: {
                     labels: labels,
                     datasets: [
                         {
                             label: 'Budget',
                             data: budgetData,
                             backgroundColor: '#667eea',
                             borderRadius: 8
                         },
                         {
                             label: 'Actual',
                             data: actualData,
                             backgroundColor: '#f093fb',
                             borderRadius: 8
                         }
                     ]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         legend: {
                             position: 'top',
                             labels: {
                                 usePointStyle: true,
                                 padding: 15
                             }
                         },
                         tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                                 }
                             }
                         }
                     },
                     scales: {
                         x: {
                             grid: { display: false }
                         },
                         y: {
                             beginAtZero: true,
                             ticks: {
                                 callback: function(value) {
                                     return '$' + value.toFixed(0);
                                 }
                             }
                         }
                     }
                 }
             });
         }
         
         function createSpendingHeatmap() {
             const container = document.getElementById('spendingHeatmap');
             const now = new Date();
             const year = now.getFullYear();
             const month = now.getMonth();
             
             // Get days in current month
             const daysInMonth = new Date(year, month + 1, 0).getDate();
             const firstDay = new Date(year, month, 1).getDay();
             
             // Calculate daily spending
             const dailySpending = {};
             allExpenses.forEach(exp => {
                 if (exp.fields.Year === year && exp.fields.Month === month + 1) {
                     const day = exp.fields.Day || 1;
                     dailySpending[day] = (dailySpending[day] || 0) + (exp.fields.Actual || 0);
                 }
             });
             
             // Find max spending for color scale
             const maxSpending = Math.max(...Object.values(dailySpending), 1);
             
             // Generate calendar HTML
             let html = '<div class="grid grid-cols-7 gap-2">';
             
             // Day headers
             const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
             days.forEach(day => {
                 html += `<div class="text-center text-xs font-semibold text-gray-600 py-2">${day}</div>`;
             });
             
             // Empty cells for days before month starts
             for (let i = 0; i < firstDay; i++) {
                 html += '<div></div>';
             }
             
             // Calendar days
             for (let day = 1; day <= daysInMonth; day++) {
                 const spending = dailySpending[day] || 0;
                 const intensity = spending / maxSpending;
                 
                 // Color scale: white -> light purple -> dark purple
                 let bgColor;
                 if (spending === 0) {
                     bgColor = '#f3f4f6'; // gray-100
                 } else if (intensity < 0.25) {
                     bgColor = '#e9d5ff'; // purple-200
                 } else if (intensity < 0.5) {
                     bgColor = '#d8b4fe'; // purple-300
                 } else if (intensity < 0.75) {
                     bgColor = '#c084fc'; // purple-400
                 } else {
                     bgColor = '#a855f7'; // purple-500
                 }
                 
                 const textColor = intensity > 0.5 ? '#ffffff' : '#1f2937';
                 const isToday = day === now.getDate();
                 
                 html += `
                     <div class="aspect-square rounded-lg flex flex-col items-center justify-center text-xs font-semibold ${isToday ? 'ring-2 ring-purple-600' : ''}" 
                          style="background-color: ${bgColor}; color: ${textColor};"
                          title="Day ${day}: $${spending.toFixed(2)}">
                         <div>${day}</div>
                         ${spending > 0 ? `<div class="text-[10px] mt-1">$${spending.toFixed(0)}</div>` : ''}
                     </div>
                 `;
             }
             
             html += '</div>';
             html += '<div class="mt-4 flex items-center justify-center gap-4 text-xs text-gray-600">';
             html += '<span>Less</span>';
             html += '<div class="flex gap-1">';
             html += '<div class="w-4 h-4 rounded" style="background-color: #f3f4f6"></div>';
             html += '<div class="w-4 h-4 rounded" style="background-color: #e9d5ff"></div>';
             html += '<div class="w-4 h-4 rounded" style="background-color: #d8b4fe"></div>';
             html += '<div class="w-4 h-4 rounded" style="background-color: #c084fc"></div>';
             html += '<div class="w-4 h-4 rounded" style="background-color: #a855f7"></div>';
             html += '</div>';
             html += '<span>More</span>';
             html += '</div>';
             
             container.innerHTML = html;
         }
         
         function createSpendingVelocityGauge() {
             const ctx = document.getElementById('velocityChart');
             if (!ctx) return;
             
             const now = new Date();
             const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
             const daysPassed = now.getDate();
             const daysRemaining = daysInMonth - daysPassed;
             
             // Calculate current month spending
             const currentMonthSpending = allExpenses
                 .filter(exp => exp.fields.Year === now.getFullYear() && exp.fields.Month === now.getMonth() + 1)
                 .reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             
             const currentMonthBudget = allExpenses
                 .filter(exp => exp.fields.Year === now.getFullYear() && exp.fields.Month === now.getMonth() + 1)
                 .reduce((sum, exp) => sum + (exp.fields.Budget || 0), 0);
             
             // Calculate velocity
             const actualPace = (currentMonthSpending / daysPassed) * daysInMonth;
             const budgetPace = currentMonthBudget;
             const velocity = budgetPace > 0 ? (actualPace / budgetPace * 100) : 0;
             
             // Destroy existing chart
             if (window.velocityChart && typeof window.velocityChart.destroy === 'function') {
                 window.velocityChart.destroy();
             }
             
             window.velocityChart = new Chart(ctx, {
                 type: 'doughnut',
                 data: {
                     labels: ['Current Pace', 'Remaining Budget'],
                     datasets: [{
                         data: [Math.min(velocity, 100), Math.max(100 - velocity, 0)],
                         backgroundColor: [
                             velocity > 100 ? '#ef4444' : velocity > 80 ? '#f59e0b' : '#10b981',
                             '#e5e7eb'
                         ],
                         borderWidth: 0
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     cutout: '75%',
                     plugins: {
                         legend: { display: false },
                         tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     return context.label + ': ' + context.parsed.toFixed(0) + '%';
                                 }
                             }
                         }
                     }
                 },
                 plugins: [{
                     id: 'centerText',
                     afterDraw: (chart) => {
                         const ctx = chart.ctx;
                         const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
                         const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;
                         
                         ctx.save();
                         ctx.font = 'bold 32px Inter';
                         ctx.fillStyle = velocity > 100 ? '#ef4444' : velocity > 80 ? '#f59e0b' : '#10b981';
                         ctx.textAlign = 'center';
                         ctx.textBaseline = 'middle';
                         ctx.fillText(velocity.toFixed(0) + '%', centerX, centerY - 10);
                         
                         ctx.font = '14px Inter';
                         ctx.fillStyle = '#6b7280';
                         ctx.fillText('Spending Pace', centerX, centerY + 20);
                         ctx.restore();
                     }
                 }]
             });
         }
         
         function createCategoryComparisonChart() {
             const ctx = document.getElementById('categoryComparisonChart');
             if (!ctx) return;
             
             const now = new Date();
             const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
             
             // Get last 3 months
             const months = [];
             const monthData = {};
             
             for (let i = 2; i >= 0; i--) {
                 const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                 const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
                 const monthLabel = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
                 months.push(monthLabel);
                 monthData[monthKey] = {};
             }
             
             // Aggregate by category and month
             allExpenses.forEach(exp => {
                 const monthKey = `${exp.fields.Year}-${exp.fields.Month}`;
                 if (monthData[monthKey]) {
                     const cat = exp.fields.Category || 'Other';
                     monthData[monthKey][cat] = (monthData[monthKey][cat] || 0) + (exp.fields.Actual || 0);
                 }
             });
             
             // Get all categories
             const categories = new Set();
             Object.values(monthData).forEach(month => {
                 Object.keys(month).forEach(cat => categories.add(cat));
             });
             
             // Create datasets
             const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#fee140', '#30cfd0'];
             const datasets = Array.from(categories).map((cat, index) => ({
                 label: cat,
                 data: Object.keys(monthData).map(monthKey => monthData[monthKey][cat] || 0),
                 backgroundColor: colors[index % colors.length],
                 borderRadius: 8
             }));
             
             // Destroy existing chart
             if (window.categoryComparisonChart && typeof window.categoryComparisonChart.destroy === 'function') {
                 window.categoryComparisonChart.destroy();
             }
             
             window.categoryComparisonChart = new Chart(ctx, {
                 type: 'bar',
                 data: {
                     labels: months,
                     datasets: datasets
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         legend: {
                             position: 'top',
                             labels: {
                                 usePointStyle: true,
                                 padding: 15
                             }
                         },
                         tooltip: {
                             mode: 'index',
                             intersect: false,
                             callbacks: {
                                 label: function(context) {
                                     return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                                 }
                             }
                         }
                     },
                     scales: {
                         x: {
                             stacked: false,
                             grid: { display: false }
                         },
                         y: {
                             stacked: false,
                             beginAtZero: true,
                             ticks: {
                                 callback: function(value) {
                                     return '$' + value.toFixed(0);
                                 }
                             }
                         }
                     }
                 }
             });
         }
         
         function createSavingsRateChart() {
             const ctx = document.getElementById('savingsChart');
             if (!ctx) return;
             
             const now = new Date();
             const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
             
             // Get last 6 months
             const labels = [];
             const savingsData = [];
             
             for (let i = 5; i >= 0; i--) {
                 const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                 const year = date.getFullYear();
                 const month = date.getMonth() + 1;
                 
                 labels.push(`${monthNames[date.getMonth()]} ${year}`);
                 
                 const monthExpenses = allExpenses.filter(exp => 
                     exp.fields.Year === year && exp.fields.Month === month
                 );
                 
                 const budget = monthExpenses.reduce((sum, exp) => sum + (exp.fields.Budget || 0), 0);
                 const actual = monthExpenses.reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
                 const savings = budget - actual;
                 
                 savingsData.push(savings);
             }
             
             // Destroy existing chart
             if (window.savingsChart && typeof window.savingsChart.destroy === 'function') {
                 window.savingsChart.destroy();
             }
             
             window.savingsChart = new Chart(ctx, {
                 type: 'line',
                 data: {
                     labels: labels,
                     datasets: [{
                         label: 'Monthly Savings',
                         data: savingsData,
                         borderColor: '#10b981',
                         backgroundColor: 'rgba(16, 185, 129, 0.1)',
                         borderWidth: 3,
                         fill: true,
                         tension: 0.4,
                         pointRadius: 6,
                         pointHoverRadius: 8,
                         pointBackgroundColor: '#10b981',
                         pointBorderColor: '#fff',
                         pointBorderWidth: 2
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         legend: { display: false },
                         tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     const value = context.parsed.y;
                                     return value >= 0 
                                         ? 'Saved: $' + value.toFixed(2)
                                         : 'Overspent: $' + Math.abs(value).toFixed(2);
                                 }
                             }
                         }
                     },
                     scales: {
                         y: {
                             beginAtZero: true,
                             ticks: {
                                 callback: function(value) {
                                     return '$' + value.toFixed(0);
                                 }
                             },
                             grid: {
                                 color: 'rgba(0, 0, 0, 0.05)'
                             }
                         },
                         x: {
                             grid: { display: false }
                         }
                     }
                 }
             });
         }
         
         function openSmartSearch() {
             document.getElementById('smartSearchModal').classList.add('active');
             
             // Populate category dropdown
             const categories = [...new Set(allExpenses.map(e => e.fields.Category).filter(c => c))];
             const categorySelect = document.getElementById('searchCategory');
             categorySelect.innerHTML = '<option value="">All Categories</option>' + 
                 categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
         }
         
         function closeSmartSearch() {
             document.getElementById('smartSearchModal').classList.remove('active');
         }
         
         function performNaturalSearch() {
             const query = document.getElementById('naturalSearchInput').value.toLowerCase();
             
             if (!query.trim()) {
                 showNotification('Please enter a search query', 'error');
                 return;
             }
             
             let results = [...allExpenses];
             
             // Parse natural language query
             const filters = parseNaturalLanguage(query);
             
             // Apply filters
             if (filters.category) {
                 results = results.filter(exp => 
                     exp.fields.Category && exp.fields.Category.toLowerCase().includes(filters.category)
                 );
             }
             
             if (filters.item) {
                 results = results.filter(exp => 
                     exp.fields.Item && exp.fields.Item.toLowerCase().includes(filters.item)
                 );
             }
             
             if (filters.minAmount !== null) {
                 results = results.filter(exp => (exp.fields.Actual || 0) >= filters.minAmount);
             }
             
             if (filters.maxAmount !== null) {
                 results = results.filter(exp => (exp.fields.Actual || 0) <= filters.maxAmount);
             }
             
             if (filters.year) {
                 results = results.filter(exp => exp.fields.Year === filters.year);
             }
             
             if (filters.month) {
                 results = results.filter(exp => exp.fields.Month === filters.month);
             }
             
             if (filters.dateRange) {
                 results = results.filter(exp => {
                     const expDate = new Date(exp.fields.Year, exp.fields.Month - 1, exp.fields.Day || 1);
                     return expDate >= filters.dateRange.start && expDate <= filters.dateRange.end;
                 });
             }
             
             displaySearchResults(results, `Natural search: "${query}"`);
         }
         
         function parseNaturalLanguage(query) {
             const filters = {
                 category: null,
                 item: null,
                 minAmount: null,
                 maxAmount: null,
                 year: null,
                 month: null,
                 dateRange: null
             };
             
             // Extract category (check all categories in your data)
             const allCategories = [...new Set(allExpenses.map(e => e.fields.Category).filter(c => c))];
             allCategories.forEach(cat => {
                 if (query.includes(cat.toLowerCase())) {
                     filters.category = cat.toLowerCase();
                 }
             });
             
             // Also check common category keywords
             const categoryKeywords = {
                 'grocery': 'grocery',
                 'groceries': 'grocery',
                 'gas': 'gas',
                 'fuel': 'gas',
                 'dining': 'dining',
                 'restaurant': 'dining',
                 'food': 'dining',
                 'mortgage': 'mortgage',
                 'rent': 'mortgage',
                 'utilities': 'utilities',
                 'utility': 'utilities',
                 'healthcare': 'healthcare',
                 'medical': 'healthcare',
                 'shopping': 'shopping',
                 'entertainment': 'entertainment'
             };
             
             Object.keys(categoryKeywords).forEach(keyword => {
                 if (query.includes(keyword)) {
                     filters.category = categoryKeywords[keyword];
                 }
             });
             
             // Extract amount patterns - improved
             // "over $100" or "more than 100" or "greater than 100"
             const overMatch = query.match(/(?:over|more than|greater than|above)\s+\$?(\d+(?:\.\d{2})?)/i);
             if (overMatch) {
                 filters.minAmount = parseFloat(overMatch[1]);
             }
             
             // "under $100" or "less than 100" or "below 100"
             const underMatch = query.match(/(?:under|less than|below)\s+\$?(\d+(?:\.\d{2})?)/i);
             if (underMatch) {
                 filters.maxAmount = parseFloat(underMatch[1]);
             }
             
             // "between $50 and $100"
             const betweenMatch = query.match(/between\s+\$?(\d+(?:\.\d{2})?)\s+and\s+\$?(\d+(?:\.\d{2})?)/i);
             if (betweenMatch) {
                 filters.minAmount = parseFloat(betweenMatch[1]);
                 filters.maxAmount = parseFloat(betweenMatch[2]);
             }
             
             // Exact amount "$100" or "100 dollars"
             const exactMatch = query.match(/\$(\d+(?:\.\d{2})?)/);
             if (exactMatch && !overMatch && !underMatch && !betweenMatch) {
                 const amount = parseFloat(exactMatch[1]);
                 filters.minAmount = amount - 0.01;
                 filters.maxAmount = amount + 0.01;
             }
             
             // Extract year
             const yearMatch = query.match(/\b(20\d{2})\b/);
             if (yearMatch) {
                 filters.year = parseInt(yearMatch[1]);
             }
             
             // Extract month
             const monthNames = ['january', 'february', 'march', 'april', 'may', 'june', 
                                'july', 'august', 'september', 'october', 'november', 'december'];
             monthNames.forEach((month, index) => {
                 if (query.includes(month)) {
                     filters.month = index + 1;
                 }
             });
             
             // Extract time ranges
             const now = new Date();
             if (query.includes('last month')) {
                 const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                 const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
                 filters.dateRange = { start: lastMonth, end: lastMonthEnd };
             } else if (query.includes('this month')) {
                 const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                 filters.dateRange = { start: thisMonth, end: now };
             } else if (query.includes('last 3 months')) {
                 const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                 filters.dateRange = { start: threeMonthsAgo, end: now };
             }
             
             // Extract item keywords (anything not matched above)
             // Skip if query starts with "all" (like "all utility" means category, not item)
             if (!query.startsWith('all ')) {
                 const categoryKeywordsList = Object.keys(categoryKeywords);
                 const stopWords = ['over', 'under', 'in', 'last', 'this', 'month', 'months', 'the', 'a', 'an', 
                                   'less', 'than', 'more', 'between', 'and', 'below', 'above', 'greater', 'all', 
                                   'expenses', 'expense', 'my', 'find', 'show', 'get'];
                 
                 const words = query.split(' ').filter(w => 
                     !stopWords.includes(w) &&
                     !w.startsWith('$') &&
                     !categoryKeywordsList.includes(w) &&
                     !monthNames.includes(w) &&
                     !/^\d+$/.test(w)
                 );
                 
                 if (words.length > 0) {
                     filters.item = words[0];
                 }
             }
             
             return filters;
         }
         
         function applyQuickFilter(filterType) {
             let results = [...allExpenses];
             let description = '';
             
             switch(filterType) {
                 case 'dining':
                     results = results.filter(exp => 
                         exp.fields.Category && exp.fields.Category.toLowerCase().includes('dining')
                     );
                     description = 'Dining';
                     break;
                     
                 case 'shopping':
                     results = results.filter(exp => 
                         exp.fields.Category && exp.fields.Category.toLowerCase().includes('shopping')
                     );
                     description = 'Shopping';
                     break;
                     
                 case 'misc':
                     results = results.filter(exp => 
                         exp.fields.Category && exp.fields.Category.toLowerCase().includes('misc')
                     );
                     description = 'Misc';
                     break;
                     
                 case 'over100':
                     results = results.filter(exp => (exp.fields.Actual || 0) > 100);
                     description = 'Over $100';
                     break;
                     
                 case 'over500':
                     results = results.filter(exp => (exp.fields.Actual || 0) > 500);
                     description = 'Over $500';
                     break;
                     
                 case 'llcOnly':
                     results = results.filter(exp => exp.fields.LLC === 'Yes');
                     description = 'LLC Expenses Only';
                     break;
             }
             
             displaySearchResults(results, description);
         }
         
         function applyAdvancedFilters() {
             const minAmount = parseFloat(document.getElementById('minAmount').value);
             const maxAmount = parseFloat(document.getElementById('maxAmount').value);
             const startDate = document.getElementById('startDate').value;
             const endDate = document.getElementById('endDate').value;
             const category = document.getElementById('searchCategory').value;
             
             let results = [...allExpenses];
             let filterDesc = [];
             
             if (!isNaN(minAmount)) {
                 results = results.filter(exp => (exp.fields.Actual || 0) >= minAmount);
                 filterDesc.push(`Min: $${minAmount}`);
             }
             
             if (!isNaN(maxAmount)) {
                 results = results.filter(exp => (exp.fields.Actual || 0) <= maxAmount);
                 filterDesc.push(`Max: $${maxAmount}`);
             }
             
             if (startDate) {
                 const start = new Date(startDate);
                 results = results.filter(exp => {
                     const expDate = new Date(exp.fields.Year, exp.fields.Month - 1, exp.fields.Day || 1);
                     return expDate >= start;
                 });
                 filterDesc.push(`From: ${startDate}`);
             }
             
             if (endDate) {
                 const end = new Date(endDate);
                 results = results.filter(exp => {
                     const expDate = new Date(exp.fields.Year, exp.fields.Month - 1, exp.fields.Day || 1);
                     return expDate <= end;
                 });
                 filterDesc.push(`To: ${endDate}`);
             }
             
             if (category) {
                 results = results.filter(exp => exp.fields.Category === category);
                 filterDesc.push(`Category: ${category}`);
             }
             
             displaySearchResults(results, filterDesc.join(', ') || 'Advanced Filters');
         }
         
         function clearAllFilters() {
             document.getElementById('naturalSearchInput').value = '';
             document.getElementById('minAmount').value = '';
             document.getElementById('maxAmount').value = '';
             document.getElementById('startDate').value = '';
             document.getElementById('endDate').value = '';
             document.getElementById('searchCategory').value = '';
             
             document.getElementById('searchResults').innerHTML = `
                 <div class="text-center py-8 text-gray-400">
                     <i class="fas fa-search text-4xl mb-3"></i>
                     <p>Enter search criteria above to find expenses</p>
                 </div>
             `;
         }
         
         function displaySearchResults(results, description) {
             const container = document.getElementById('searchResults');
             
             if (results.length === 0) {
                 container.innerHTML = `
                     <div class="text-center py-8 text-gray-400">
                         <i class="fas fa-inbox text-4xl mb-3"></i>
                         <p>No expenses found matching: ${description}</p>
                     </div>
                 `;
                 return;
             }
             
             // Calculate total
             const total = results.reduce((sum, exp) => sum + (exp.fields.Actual || 0), 0);
             
             // Sort by date (newest first)
             results.sort((a, b) => {
                 const dateA = new Date(a.fields.Year, a.fields.Month - 1, a.fields.Day || 1);
                 const dateB = new Date(b.fields.Year, b.fields.Month - 1, b.fields.Day || 1);
                 return dateB - dateA;
             });
             
             const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
             
             container.innerHTML = `
                 <div class="mb-4 p-4 bg-purple-50 rounded-lg">
                     <div class="flex justify-between items-center">
                         <div>
                             <h3 class="font-bold text-gray-800">Search Results: ${description}</h3>
                             <p class="text-sm text-gray-600">${results.length} expense${results.length !== 1 ? 's' : ''} found</p>
                         </div>
                         <div class="text-right">
                             <div class="text-2xl font-bold text-purple-600">$${total.toFixed(2)}</div>
                             <div class="text-xs text-gray-600">Total</div>
                         </div>
                     </div>
                 </div>
                 
                 <div class="space-y-2 max-h-96 overflow-y-auto">
                     ${results.map(exp => `
                         <div class="card p-4 hover:shadow-lg transition-shadow cursor-pointer" onclick="editExpense('${exp.id}')">
                             <div class="flex justify-between items-start">
                                 <div class="flex-1">
                                     <div class="font-semibold text-gray-800">${exp.fields.Item}</div>
                                     <div class="text-sm text-gray-600 mt-1">
                                         <span class="inline-flex items-center gap-1">
                                             <i class="fas fa-calendar text-gray-400"></i>
                                             ${monthNames[exp.fields.Month]} ${exp.fields.Day || 1}, ${exp.fields.Year}
                                         </span>
                                         ${exp.fields.Category ? `
                                             <span class="ml-3 inline-flex items-center gap-1">
                                                 <i class="fas fa-tag text-gray-400"></i>
                                                 ${exp.fields.Category}
                                             </span>
                                         ` : ''}
                                         ${exp.fields.LLC === 'Yes' ? `
                                             <span class="ml-3 px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded">LLC</span>
                                         ` : ''}
                                     </div>
                                 </div>
                                 <div class="text-right">
                                     <div class="text-lg font-bold text-purple-600">$${(exp.fields.Actual || 0).toFixed(2)}</div>
                                     ${exp.fields.Budget ? `<div class="text-xs text-gray-500">Budget: $${exp.fields.Budget.toFixed(2)}</div>` : ''}
                                 </div>
                             </div>
                         </div>
                     `).join('')}
                 </div>
             `;
         }
         
         function openSettings() {
             const personalURL = window.location.origin + window.location.pathname + 
                               '?key=' + encodeURIComponent(AIRTABLE_API_KEY) + 
                               '&base=' + encodeURIComponent(BASE_ID);
             
             const menu = 'âš™ï¸ Settings\n\n' +
                         'API Key: ***' + (AIRTABLE_API_KEY ? AIRTABLE_API_KEY.slice(-8) : 'Not set') + '\n' +
                         'Base ID: ' + (BASE_ID || 'Not set') + '\n\n' +
                         '1ï¸âƒ£ OK = Get Personal URL (for Private Mode)\n' +
                         '2ï¸âƒ£ Cancel = Update/Clear Credentials';
             
             const action = confirm(menu);
             
             if (action === true) {
                 // Copy personal URL
                 navigator.clipboard.writeText(personalURL).then(() => {
                     alert('ðŸ“‹ Personal URL copied to clipboard!\n\n' + personalURL + '\n\nâœ… Bookmark this URL for private browsing\nðŸ”’ Keep it private - it contains your credentials!');
                 }).catch(() => {
                     alert('ðŸ“‹ Your Personal URL:\n\n' + personalURL + '\n\nâœ… Bookmark this for private browsing\nðŸ”’ Keep it private!');
                 });
             } else {
                 // Update or clear
                 const updateAction = confirm('Update credentials?\n\nOK = Update\nCancel = Clear & Reset');
                 
                 if (updateAction === true) {
                     const newKey = prompt('Enter new Airtable API Key:', AIRTABLE_API_KEY);
                     const newBase = prompt('Enter new Airtable Base ID:', BASE_ID);
                     
                     if (newKey && newBase) {
                         AIRTABLE_API_KEY = newKey;
                         BASE_ID = newBase;
                         try {
                             localStorage.setItem('airtable_api_key', newKey);
                             localStorage.setItem('airtable_base_id', newBase);
                         } catch(e) {}
                         showNotification('âœ… Credentials updated!', 'success');
                         loadData();
                     }
                 } else if (updateAction === false) {
                     if (confirm('âš ï¸ Clear saved credentials?')) {
                         try {
                             localStorage.removeItem('airtable_api_key');
                             localStorage.removeItem('airtable_base_id');
                         } catch(e) {}
                         showNotification('ðŸ”„ Credentials cleared! Reload to re-enter.', 'success');
                     }
                 }
             }
         }
      </script>
   </body>
</html>
